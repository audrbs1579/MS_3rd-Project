<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Commit Detail • Project Guardian</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif; margin:0; padding:24px; background:#f7faf9;}
    .card { background:#fff; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.06); padding:20px; margin-bottom:16px;}
    .title { font-size:20px; font-weight:700; margin:0 0 12px;}
    .muted { color:#687076; font-size:13px;}
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .kv { margin:6px 0; }
    .kv b { display:inline-block; width:160px; color:#1f2937; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700;}
    .pill.good { background:#ecfdf5; color:#065f46;}
    .pill.warn { background:#fff7ed; color:#9a3412;}
    .pill.bad  { background:#fef2f2; color:#991b1b;}
    .list { margin:0; padding-left:20px; }
    .green { background:#ecfff4; }
    .spacer { height:8px; }
    canvas { max-width: 520px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="card">
    <h2 class="title">Commit 상세</h2>
    <div id="meta" class="muted">로딩 중…</div>
  </div>

  <div class="grid">
    <div class="card">
      <h3 class="title">BRICKS 요약</h3>
      <div id="bricks-badge"></div>
      <div class="kv"><b>anomaly_score</b> <span id="v-score">N/A</span></div>
      <div class="kv"><b>threshold_used</b> <span id="v-thr">N/A</span></div>
      <div class="kv"><b>is_anomaly</b> <span id="v-flag">N/A</span></div>
    </div>

    <div class="card">
      <h3 class="title">BRICKS 차트</h3>
      <p class="muted">anomaly_score와 threshold_used를 막대 그래프로 비교합니다.</p>
      <canvas id="scoreChart" height="180"></canvas>
    </div>
  </div>

  <div class="card green">
    <h3 class="title">BRICKS 상세</h3>
    <ul class="list" id="bricks-detail">
      <!-- 3개만 표시 (score / threshold_used / is_anomaly). 값 없으면 숨김 -->
    </ul>
  </div>

  <div class="spacer"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    // 간단한 상태 저장소
    const S = {
      repo: new URLSearchParams(location.search).get('repo') || '',
      sha:  new URLSearchParams(location.search).get('sha')  || '',
      branch: new URLSearchParams(location.search).get('branch') || '',
      commentsByCommit: {},
    };

    function badge(score, thr, flag){
      if (flag === true)  return '<span class="pill bad">Anomaly</span>';
      if (typeof score === 'number' && typeof thr === 'number' && score >= 0.9*thr) return '<span class="pill warn">Near threshold</span>';
      if (typeof flag === 'boolean') return '<span class="pill good">Normal</span>';
      return '<span class="pill">—</span>';
    }

    async function loadSecurity(){
      const q = new URLSearchParams({ repo: S.repo, sha: S.sha, branch: S.branch });
      const r = await fetch(`/api/security_status?${q.toString()}`);
      if (!r.ok) throw new Error(`security_status ${r.status}`);
      const j = await r.json();

      const b = (j.bricks || {});
      const score = b.anomaly_score;
      const thr   = b.threshold_used;
      const flag  = b.is_anomaly;

      document.getElementById('meta').textContent = `${j.repo} @ ${j.sha?.slice(0,7)}`;
      document.getElementById('bricks-badge').innerHTML = badge(score, thr, flag);

      const fmt = (v) => (typeof v === 'number') ? v.toFixed(6) : (v===true?'True':(v===false?'False':'N/A'));
      document.getElementById('v-score').textContent = fmt(score);
      document.getElementById('v-thr').textContent   = fmt(thr);
      document.getElementById('v-flag').textContent  = fmt(flag);

      // 상세 3개만 렌더 (값 없으면 생략)
      const ul = document.getElementById('bricks-detail');
      ul.innerHTML = '';
      const rows = [
        ['anomaly_score', score],
        ['threshold_used', thr],
        ['is_anomaly', flag],
      ].filter(([k,v]) => v !== null && v !== undefined);
      for (const [k,v] of rows){
        const li = document.createElement('li');
        li.textContent = `${k}=${fmt(v)}`;
        ul.appendChild(li);
      }

      drawChart(score, thr);
    }

    let chart;
    function drawChart(score, thr){
      const ctx = document.getElementById('scoreChart');
      if (chart) { chart.destroy(); }
      const data = {
        labels: ['anomaly_score', 'threshold_used'],
        datasets: [{
          data: [
            typeof score === 'number' ? score : 0,
            typeof thr   === 'number' ? thr   : 0
          ]
        }]
      };
      chart = new Chart(ctx, {
        type: 'bar',
        data,
        options: {
          responsive: true,
          plugins: { legend: { display:false }, tooltip: { enabled: true } },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    // (문법오류 수정) 코멘트 스프레드 오타 방지 예시
    function addCommentLocal(sha, newComment){
      const prev = S.commentsByCommit[sha] || [];
      S.commentsByCommit[sha] = [newComment, ...prev];
    }

    (async () => {
      try {
        if (!S.repo || !S.sha){
          document.getElementById('meta').textContent = '쿼리 파라미터가 부족합니다 (?repo=..&sha=..)';
          return;
        }
        await loadSecurity();
      } catch (e){
        document.getElementById('meta').textContent = `에러: ${e}`;
      }
    })();
  </script>
</body>
</html>

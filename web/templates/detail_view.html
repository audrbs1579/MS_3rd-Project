<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Detail</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#f9fafb; --card:#fff; --border:#e5e7eb; --muted:#6b7280 }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;color:#111827}
    .wrap{padding:16px;max-width:1100px;margin:0 auto}
    .grid{display:grid;grid-template-columns:1.1fr 1fr;gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px}
    .h{margin:0 0 8px 0;font-size:15px;border-bottom:1px solid var(--border);padding-bottom:8px}
    .meta{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .muted{color:var(--muted)}
    .file{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:10px;padding:8px;margin:6px 0;background:#fff}
  </style>
</head>
<body>
<div class="wrap">
  <div class="grid">
    <div class="card">
      <h2 class="h">Commit</h2>
      <div id="commitMeta" class="meta"></div>
      <div id="commitFiles"></div>
    </div>
    <div class="card">
      <h2 class="h">Security</h2>
      <div id="identityBody" class="muted">로딩 중…</div>
      <div id="defenderBody" class="muted"></div>
      <div id="bricksBody" class="muted"></div>
    </div>
  </div>
</div>

<script>
(()=>{
  const repo   = new URLSearchParams(location.search).get('repo') || {{ repo_name|tojson if repo_name is defined else 'null' }};
  const branch = new URLSearchParams(location.search).get('branch') || {{ branch_name|tojson if branch_name is defined else 'null' }};
  const sha    = new URLSearchParams(location.search).get('sha') || {{ commit_sha|tojson if commit_sha is defined else 'null' }};

  const esc = (s)=> String(s??"").replace(/[&<>"'`]/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;","`":"&#96;" }[m]));
  const ago=(iso)=>{ if(!iso) return "-"; const d=(Date.now()-new Date(iso).getTime())/1000;
    if(d<60) return `${d|0}초 전`; const m=d/60|0; if(m<60) return `${m}분 전`; const h=m/60|0; if(h<24) return `${h}시간 전`; return `${h/24|0}일 전`; };

  async function api(path, query){
    const qs = query ? `?${new URLSearchParams(query).toString()}` : "";
    const res = await fetch(path+qs, {credentials:'same-origin'});
    if(!res.ok) throw new Error(`${path} ${res.status}`);
    return await res.json();
  }

  function renderCommitReview(d){
    const meta = document.getElementById('commitMeta');
    meta.innerHTML = `
      <div><div class="muted">작성자</div><div>${esc(d.author?.name||d.author||'-')}</div></div>
      <div><div class="muted">시간</div><div>${ago(d.date)}</div></div>
      <div><div class="muted">SHA</div><div>${esc(d.sha||sha||'-')}</div></div>
      <div><div class="muted">브랜치</div><div>${esc(branch||'-')}</div></div>
    `;
    const files = document.getElementById('commitFiles');
    files.innerHTML = (d.files||[]).map(f=>`
      <div class="file">
        <div>
          <div>${esc(f.filename)}</div>
          <div class="muted">+${f.additions} / -${f.deletions} (${f.status})</div>
        </div>
        <a href="${f.blob_url||'#'}" target="_blank">보기</a>
      </div>
    `).join("") || '<div class="muted">변경 파일 없음</div>';
  }

  function renderSecurity(s){
    const id = document.getElementById('identityBody');
    const de = document.getElementById('defenderBody');
    const br = document.getElementById('bricksBody');
    const txt = (x)=> esc(x?.summary || '결과 없음');
    id.textContent = txt(s.sentinel);
    de.textContent = txt(s.defender);
    br.textContent = txt(s.bricks);
  }

  async function loadAll(){
    const c = await api('/api/commit_detail', { repo, sha });
    renderCommitReview(c||{});
    const s = await api('/api/security_status', { repo, commit: sha, branch: branch||'' });
    renderSecurity(s||{});
  }

  async function refreshDetail(){
    try{
      await loadAll();
    }catch(e){ console.warn('detail auto-refresh error', e); }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    loadAll();
    setInterval(refreshDetail, 30000); // 30초 강제 자동 새로고침(동일 커밋 유지)
  });
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Project Guardian – OSS Activity Explorer</title>
  <style>
    /* 기본 스타일은 유지, 레이아웃만 3단으로 변경 */
    body{
      background-color:#3A6EA5;
      font-family:Gulim, Dotum, "Tahoma", Geneva, sans-serif;
      font-size:12px; margin:0; padding:0; overflow:hidden;
    }
    .desktop{height:100vh;width:100vw;display:grid;grid-template-rows:1fr 30px;}
    .workspace{position:relative;overflow:hidden;padding:10px;}

    /* [수정] 3단 그리드 레이아웃 정의 (레포 | 의존성 | 상세) */
    .grid{
      height:100%;
      display:grid;
      /* 초기 비율: 35% | 35% | 30% */
      grid-template-columns: 2fr 10px 2fr 10px 1.5fr;
      gap:10px;
      align-items:stretch;
    }

    .window{
      border:2px solid #0058E1;border-radius:8px 8px 0 0;background:#ECE9D8;
      box-shadow:5px 5px 15px rgba(0,0,0,.5);display:flex;flex-direction:column;overflow:hidden;
    }
    .title-bar{
      background:linear-gradient(to bottom,#0058E1,#3A85E1);color:#fff;font-weight:bold;
      padding:6px 8px;display:flex;align-items:center;gap:6px;user-select:none;
      flex-shrink: 0;
    }
    .title-icon{width:16px;height:16px;flex:0 0 16px;}
    .title-text{flex:1 1 auto;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .title-buttons span{
      display:inline-block;width:18px;height:18px;margin-left:3px;background:#D64F34;color:#fff;
      text-align:center;line-height:18px;border:1px solid #fff;font-family:"Courier New",Courier,monospace;
    }
    
    .toolbar{display:flex;gap:8px;align-items:center;padding:8px 10px;background:#f5f2e8;border-bottom:1px solid #cfc9b8; flex-shrink: 0;}
    .toolbar input[type="text"]{width:260px;padding:5px 6px;border:1px solid #9f9a87;background:#fff;font-family:inherit;}
    .toolbar button{border:1px solid #000;background:#ECE9D8;padding:5px 10px;cursor:pointer;}

    .content-area { padding:10px;flex-grow:1;overflow:auto;color:#000; }
    
    .repo-row, .dep-row {
      padding:10px;border:1px solid #ccc;background:#fff;border-radius:4px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px;cursor:pointer;
    }
    .repo-row.active, .dep-row.active { outline:2px solid #3A85E1;background:#f5f9ff; }
    .repo-title{display:flex;align-items:center;gap:8px;min-width:0;}
    .repo-name, .dep-name {font-weight:bold;color:#0058E1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:260px;}
    .chip{font-size:11px;background:#e7eefc;border:1px solid #bfd0f5;padding:1px 6px;border-radius:10px;color:#245edc;white-space:nowrap;}
    
    .handle{
      background:#D6D3C6; border:1px solid #9f9a87;border-radius:8px;
      user-select:none;cursor:col-resize; display:flex; align-items:center; justify-content:center;
    }

    /* [신규] 3번째 창 (상세 정보) 스타일 */
    .detail-content { font-family: 'Malgun Gothic', sans-serif; }
    .detail-header { border-bottom: 1px solid #ccc; padding-bottom: 8px; margin-bottom: 8px; }
    .detail-title { font-size: 14px; font-weight: bold; }
    .detail-meta { font-size: 11px; color: #555; }
    .detail-score { font-size: 18px; font-weight: bold; padding: 5px; border-radius: 4px; text-align: center; }
    .detail-section { margin-top: 15px; }
    .detail-section h4 { margin: 0 0 5px 0; font-size: 12px; border-bottom: 1px solid #ddd; padding-bottom: 3px; }
    .detail-list { list-style: none; padding-left: 0; margin: 0; font-size: 11px; max-height: 200px; overflow-y: auto; background: #fff; border: 1px solid #ccc; }
    .detail-list li { padding: 4px 6px; border-bottom: 1px solid #eee; }
    .detail-list li:last-child { border-bottom: none; }
    .loading-spinner {
        border: 4px solid #f3f3f3; border-top: 4px solid #3498db;
        border-radius: 50%; width: 30px; height: 30px;
        animation: spin 1s linear infinite; margin: 20px auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .taskbar{background:linear-gradient(to bottom,#245EDC,#3A85E1);border-top:1px solid #66A3FF;display:flex;align-items:center;gap:8px;padding:0 6px;}
    .start-button{background:linear-gradient(to bottom,#72BE4A,#55A82B);color:#fff;font-weight:bold;font-size:16px;border:2px outset #55A82B;border-radius:10px 10px 0 0;padding:2px 20px;margin-left:5px;font-style:italic;cursor:pointer;user-select:none;}
    a{color:#0058E1;text-decoration:none;} a:hover{text-decoration:underline;}
  </style>
</head>
<body>
  <div class="desktop">
    <div class="workspace">
      <div class="grid" id="mainGrid">
        <div class="window" id="myReposPane">
          <div class="title-bar">
            <div class="title-text">{{ user_id }}'s Repositories</div>
          </div>
          <div class="toolbar">
            <input id="filterInput" type="text" placeholder="레포/의존성 검색" />
            <a href="{{ url_for('logout') }}"><button>Logout</button></a>
          </div>
          <div class="content-area" id="repoList">
            {% for item in items %}
            <div class="repo-row" data-repo-id="{{ item.id }}">
              <div class="repo-title">
                <span class="repo-name" title="{{ item.repositoryName }}">{{ item.repositoryName }}</span>
              </div>
              <span class="chip">{{ item.dependencies | length }} dependencies</span>
            </div>
            {% endfor %}
          </div>
        </div>
        
        <div class="handle" data-splitter-for="1"></div>

        <div class="window" id="dependenciesPane">
          <div class="title-bar">
            <div class="title-text">Dependencies</div>
          </div>
          <div class="content-area" id="depsList">
             <div class="empty-state">Select a repository to see its dependencies.</div>
          </div>
        </div>

        <div class="handle" data-splitter-for="2"></div>

        <div class="window" id="activityPane">
          <div class="title-bar">
            <div class="title-text">OSS Activity Details</div>
          </div>
          <div class="content-area" id="activityDetails">
            <div class="empty-state">Select a dependency to see its latest activity.</div>
          </div>
        </div>
      </div>
    </div>
    <div class="taskbar"><div class="start-button">start</div></div>
  </div>

  <script>
    const REPO_DATA = {{ items|tojson }};
    
    const repoListEl = document.getElementById('repoList');
    const depsListEl = document.getElementById('depsList');
    const activityDetailsEl = document.getElementById('activityDetails');

    // 1. 내 레포지토리 클릭 이벤트
    repoListEl.addEventListener('click', e => {
        const row = e.target.closest('.repo-row');
        if (!row) return;

        document.querySelectorAll('.repo-row').forEach(r => r.classList.remove('active'));
        row.classList.add('active');
        
        const repoId = row.dataset.repoId;
        const repo = REPO_DATA.find(r => r.id === repoId);
        
        renderDependencies(repo);
        clearActivityDetails();
    });

    // 2. 의존성 목록 렌더링
    function renderDependencies(repo) {
        if (!repo || !repo.dependencies) {
            depsListEl.innerHTML = '<div class="empty-state">No dependencies found.</div>';
            return;
        }

        depsListEl.innerHTML = repo.dependencies.map(dep => {
            const [repoFullName, version] = dep.split(' ');
            return `<div class="dep-row" data-repo-full-name="${repoFullName}">
                        <span class="dep-name" title="${dep}">${repoFullName}</span>
                        <span class="chip">${version || 'N/A'}</span>
                    </div>`;
        }).join('');
    }

    // 3. 의존성 클릭 이벤트 -> API 호출
    depsListEl.addEventListener('click', e => {
        const row = e.target.closest('.dep-row');
        if (!row) return;

        document.querySelectorAll('.dep-row').forEach(r => r.classList.remove('active'));
        row.classList.add('active');

        const repoFullName = row.dataset.repoFullName;
        fetchAndRenderActivity(repoFullName);
    });

    // 4. API 호출 및 상세 정보 렌더링
    async function fetchAndRenderActivity(repoFullName) {
        activityDetailsEl.innerHTML = '<div class="loading-spinner"></div>';
        try {
            const response = await fetch(`/get_oss_activity/${repoFullName}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            renderActivityDetails(data);
        } catch (error) {
            activityDetailsEl.innerHTML = `<div class="empty-state" style="color: red;">Error fetching activity:<br>${error.message}</div>`;
        }
    }

    // 5. 상세 정보 UI 렌더링
    function renderActivityDetails(data) {
        if (data.error) {
             activityDetailsEl.innerHTML = `<div class="empty-state" style="color: red;">${data.error}</div>`;
             return;
        }
        if (!data.has_recent_event) {
            activityDetailsEl.innerHTML = `<div class="empty-state">No recent push event found for this repository.</div>`;
            return;
        }

        const score = data.anomaly_score;
        let scoreColor = '#666';
        if (score > 0.8) scoreColor = '#e53e3e'; // High risk
        else if (score > 0.5) scoreColor = '#dd6b20'; // Medium risk
        else if (score !== null) scoreColor = '#38a169'; // Low risk
        
        const commitsHtml = (data.commits || []).map(c => `<li><strong>${c.author.name}:</strong> ${c.message.split('\\n')[0]}</li>`).join('');

        activityDetailsEl.innerHTML = `
            <div class="detail-content">
                <div class="detail-header">
                    <div class="detail-title">${data.repo_full_name}</div>
                    <div class="detail-meta">Last synced: ${new Date(data.last_synced).toLocaleString()}</div>
                </div>
                <div class="detail-section">
                    <h4>Anomaly Score</h4>
                    <div class="detail-score" style="background-color: ${scoreColor}; color: white;">
                        ${score !== null ? score.toFixed(2) : 'N/A'}
                    </div>
                </div>
                <div class="detail-section">
                    <h4>Latest Push Event Details</h4>
                    <ul class="detail-list">
                        <li><strong>Actor:</strong> ${data.actor || 'N/A'}</li>
                        <li><strong>Event Time (UTC):</strong> ${data.created_at}</li>
                        <li><strong>Force Push:</strong> ${data.features.force_push === 1 ? 'Yes' : 'No'}</li>
                        <li><strong>Sensitive Path Touched:</strong> ${data.features.touched_sensitive_paths === 1 ? 'Yes' : 'No'}</li>
                        <li><strong>Dependency File Changed:</strong> ${data.features.dep_change_cnt === 1 ? 'Yes' : 'No'}</li>
                    </ul>
                </div>
                <div class="detail-section">
                    <h4>Commits in Push (${data.commits.length})</h4>
                    <ul class="detail-list">${commitsHtml}</ul>
                </div>
            </div>`;
    }

    function clearActivityDetails() {
        activityDetailsEl.innerHTML = '<div class="empty-state">Select a dependency to see its latest activity.</div>';
    }

    // 스플리터 로직 (간소화 버전)
    document.querySelectorAll('.handle').forEach(handle => {
        handle.addEventListener('mousedown', e => {
            const mainGrid = document.getElementById('mainGrid');
            const startX = e.clientX;
            const gridTemplate = getComputedStyle(mainGrid).gridTemplateColumns.split(' ').map(v => parseFloat(v));
            const splitterIndex = parseInt(handle.dataset.splitterFor) * 2 - 1;

            const onMouseMove = moveEvent => {
                const dx = moveEvent.clientX - startX;
                const newCols = [...gridTemplate];
                newCols[splitterIndex - 1] += dx;
                newCols[splitterIndex + 1] -= dx;
                mainGrid.style.gridTemplateColumns = newCols.map(v => `${v}px`).join(' ');
            };
            const onMouseUp = () => {
                window.removeEventListener('mousemove', onMouseMove);
                window.removeEventListener('mouseup', onMouseUp);
            };
            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('mouseup', onMouseUp);
        });
    });

  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Project Guardian – Dependencies Explorer</title>
  <style>
    /* ===== Windows XP 룩 & 폰트 ===== */
    body{
      background-color:#3A6EA5;
      font-family:Gulim, Dotum, "Tahoma", Geneva, sans-serif;
      font-size:12px; margin:0; padding:0; overflow:hidden;
    }
    .desktop{height:100vh;width:100vw;display:grid;grid-template-rows:1fr 30px;}
    .workspace{position:relative;overflow:hidden;padding:10px;}

    /* 처음에는 좌 2/3, 우 1/3 */
    .grid{height:100%;display:grid;grid-template-columns:2fr 10px 1fr;gap:10px;align-items:stretch;}

    /* 공통 창 */
    .window{
      border:2px solid #0058E1;border-radius:8px 8px 0 0;background:#ECE9D8;
      box-shadow:5px 5px 15px rgba(0,0,0,.5);display:flex;flex-direction:column;overflow:hidden;
    }
    .title-bar{
      background:linear-gradient(to bottom,#0058E1,#3A85E1);color:#fff;font-weight:bold;
      padding:6px 8px;display:flex;align-items:center;gap:6px;user-select:none;
    }
    .title-icon{width:16px;height:16px;flex:0 0 16px;}
    .title-text{flex:1 1 auto;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .title-buttons span{
      display:inline-block;width:18px;height:18px;margin-left:3px;background:#D64F34;color:#fff;
      text-align:center;line-height:18px;border:1px solid #fff;font-family:"Courier New",Courier,monospace;
    }

    /* 좌: 레포 목록 */
    .toolbar{display:flex;gap:8px;align-items:center;padding:8px 10px;background:#f5f2e8;border-bottom:1px solid #cfc9b8;}
    .toolbar input[type="text"]{width:260px;padding:5px 6px;border:1px solid #9f9a87;background:#fff;font-family:inherit;}
    .toolbar button{border:1px solid #000;background:#ECE9D8;padding:5px 10px;cursor:pointer;}
    .left-content{padding:10px;flex:1 1 auto;overflow:auto;color:#000;}
    .repo-row{
      padding:10px;border:1px solid #ccc;background:#fff;border-radius:4px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px;cursor:pointer;
    }
    .repo-row.active{outline:2px solid #3A85E1;background:#f5f9ff;}
    .repo-title{display:flex;align-items:center;gap:8px;min-width:0;}
    .repo-name{font-weight:bold;color:#0058E1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:260px;}
    .chip{font-size:11px;background:#e7eefc;border:1px solid #bfd0f5;padding:1px 6px;border-radius:10px;color:#245edc;white-space:nowrap;}
    .repo-actions{display:flex;gap:6px;}
    .repo-actions button{border:1px solid #000;background:#ECE9D8;padding:3px 8px;cursor:pointer;}

    /* 가운데 핸들 (드래그 가능) */
    .handle{
      display:flex;align-items:center;justify-content:center;background:#D6D3C6;
      border:1px solid #9f9a87;border-radius:8px;user-select:none;cursor:col-resize;
    }
    .handle button{
      border:1px solid #000;background:#ECE9D8;padding:2px 6px;cursor:col-resize;font-weight:bold;
      width:22px;height:22px;display:flex;align-items:center;justify-content:center;
    }

    /* 우: 의존성 상세 */
    .right-content{padding:10px;flex:1 1 auto;overflow:auto;color:#000;}
    .detail-header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px;}
    .deps{margin:0;padding:0;list-style:none;border:1px solid #eee;background:#fff;}
    .deps li{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 10px;border-bottom:1px solid #f0f0f0;}
    .deps li:last-child{border-bottom:none;}
    .dep-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:640px;}
    .empty{padding:12px;background:#fff;border:1px dashed #ccc;color:#333;}

    /* 작업표시줄 */
    .taskbar{background:linear-gradient(to bottom,#245EDC,#3A85E1);border-top:1px solid #66A3FF;display:flex;align-items:center;gap:8px;padding:0 6px;}
    .start-button{background:linear-gradient(to bottom,#72BE4A,#55A82B);color:#fff;font-weight:bold;font-size:16px;border:2px outset #55A82B;border-radius:10px 10px 0 0;padding:2px 20px;margin-left:5px;font-style:italic;cursor:pointer;user-select:none;}

    a{color:#0058E1;text-decoration:none;} a:hover{text-decoration:underline;}
  </style>
</head>
<body>
  <div class="desktop">
    <div class="workspace">
      <div class="grid" id="grid">
        <!-- 좌: 레포 목록 창 -->
        <div class="window" id="leftWin">
          <div class="title-bar">
            <svg class="title-icon" viewBox="0 0 16 16" aria-hidden="true">
              <path d="M1 4h5l2 2h7v7H1z" fill="#FFCC66" stroke="#996600"></path>
            </svg>
            <div class="title-text">{{ user_id }} – Repositories</div>
            <div class="title-buttons"><span>_</span><span>☐</span><span>X</span></div>
          </div>
          <div class="toolbar">
            <span>검색:</span>
            <input id="filterInput" type="text" placeholder="레포지토리/의존성 검색" />
            <button id="btnExpand">모두 펼치기</button>
            <button id="btnCollapse">모두 접기</button>
            <a href="{{ url_for('logout') }}"><button>Logout</button></a>
          </div>
          <div class="left-content" id="repoList">
            {% for item in items %}
            <div class="repo-row" data-index="{{ loop.index0 }}" data-repo="{{ item.repositoryName | e }}">
              <div class="repo-title">
                <svg width="10" viewBox="0 0 16 16"><path d="M5 3l6 5-6 5z" fill="currentColor"></path></svg>
                <span class="repo-name" title="{{ item.repositoryName }}">{{ item.repositoryName }}</span>
                <span class="chip" title="DB에 기록된 갱신 시각">updated: {{ item.lastUpdated | to_kst }}</span>
              </div>
              <div class="repo-actions">
                <span class="chip">{{ item.dependencies | length }} deps</span>
                <button class="copyBtn" type="button">복사</button>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

        <!-- 가운데 핸들 (">"만 표시 + 드래그로 폭 조절) -->
        <div class="handle" id="splitter">
          <button id="splitBtn" title="창 폭 조절">></button>
        </div>

        <!-- 우: 선택한 레포 의존성 창 -->
        <div class="window" id="rightWin">
          <div class="title-bar">
            <svg class="title-icon" viewBox="0 0 16 16" aria-hidden="true">
              <circle cx="8" cy="8" r="7" fill="#66CCFF" stroke="#006699"></circle>
            </svg>
            <div class="title-text" id="detailTitle">Dependencies</div>
            <div class="title-buttons"><span>_</span><span>☐</span><span>X</span></div>
          </div>
          <div class="right-content">
            <div class="detail-header">
              <div id="detailMeta" class="chip">왼쪽에서 레포지토리를 선택하면 의존성을 표시합니다.</div>
              <div><button id="btnCopyDeps" class="chip" style="cursor:pointer;">의존성 복사</button></div>
            </div>
            <ul class="deps" id="depsList"></ul>
            <div class="empty" id="emptyState" style="display:none;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- 작업표시줄 -->
    <div class="taskbar"><div class="start-button">start</div></div>
  </div>

  <script>
    // ===== 서버 데이터 =====
    const DATA = {{ items|tojson }};
    const repoListEl = document.getElementById('repoList');
    const depsListEl = document.getElementById('depsList');
    const emptyStateEl = document.getElementById('emptyState');
    const detailTitleEl = document.getElementById('detailTitle');
    const detailMetaEl = document.getElementById('detailMeta');

    // ===== 레포 선택 시 오른쪽 렌더링 =====
    function onlyRepoName(full){
      if(!full) return '';
      const parts = full.split('/');
      return parts.length > 1 ? parts.slice(1).join('/') : full; // owner 제거
    }

    function renderDetails(idx){
      const item = DATA[idx];
      if(!item) return;

      // 좌측 active
      document.querySelectorAll('.repo-row').forEach(r=>r.classList.remove('active'));
      const row = document.querySelector(`.repo-row[data-index="${idx}"]`);
      if(row) row.classList.add('active');

      // 제목: 소유자 제거
      detailTitleEl.textContent = onlyRepoName(item.repositoryName);

      // 메타(업데이트 시각)
      const timeChip = row.querySelector('.repo-title .chip');
      detailMetaEl.textContent = timeChip ? timeChip.textContent : '';

      // 의존성 출력
      const deps = item.dependencies || [];
      depsListEl.innerHTML = '';
      if(deps.length === 0){
        emptyStateEl.style.display = '';
        emptyStateEl.textContent = '이 레포지토리는 의존성이 없습니다.';
        return;
      }
      emptyStateEl.style.display = 'none';

      deps.forEach(dep=>{
        const li = document.createElement('li');
        const name = document.createElement('span');
        name.className = 'dep-name'; name.title = dep; name.textContent = dep;

        const chip = document.createElement('span');
        chip.className = 'chip';
        const lower = (dep||'').toLowerCase();
        if (lower.includes('npm') || lower.includes('yarn') || lower.includes('.json')) chip.textContent = 'JS';
        else if (lower.includes('pip') || lower.includes('python') || lower.includes('.txt')) chip.textContent = 'Py';
        else if (lower.includes('maven') || lower.includes('gradle') || lower.includes('.pom') || lower.includes('jar')) chip.textContent = 'Java';
        else if (lower.includes('nuget') || lower.includes('.csproj')) chip.textContent = '.NET';
        else chip.textContent = 'dep';

        li.appendChild(name); li.appendChild(chip);
        depsListEl.appendChild(li);
      });
    }

    // 좌측 클릭/복사
    repoListEl.addEventListener('click', (e)=>{
      const row = e.target.closest('.repo-row'); if(!row) return;
      const idx = row.getAttribute('data-index');

      if(e.target.classList.contains('copyBtn')){
        const deps = (DATA[idx]?.dependencies || []).join('\n');
        navigator.clipboard.writeText(deps).then(()=>{
          e.target.textContent='복사됨!'; setTimeout(()=>e.target.textContent='복사',900);
        });
        return;
      }
      renderDetails(idx);
    });

    // 검색
    document.getElementById('filterInput').addEventListener('input', function(){
      const q = (this.value||'').trim().toLowerCase();
      document.querySelectorAll('.repo-row').forEach(function(row){
        const idx = row.getAttribute('data-index');
        const item = DATA[idx];
        const name = (item.repositoryName||'').toLowerCase();
        const deps = (item.dependencies||[]).map(d=>(d||'').toLowerCase());
        const hit = !q || name.includes(q) || deps.some(d=>d.includes(q));
        row.style.display = hit ? '' : 'none';
      });
    });

    // 모두 펼치기 → 첫 항목 선택
    document.getElementById('btnExpand').addEventListener('click', ()=>{
      const first = document.querySelector('.repo-row:not([style*="display: none"])');
      if(first) renderDetails(first.getAttribute('data-index'));
    });
    // 모두 접기 → 선택 해제
    document.getElementById('btnCollapse').addEventListener('click', ()=>{
      document.querySelectorAll('.repo-row').forEach(r=>r.classList.remove('active'));
      depsListEl.innerHTML='';
      detailTitleEl.textContent='Dependencies';
      detailMetaEl.textContent='왼쪽에서 레포지토리를 선택하면 의존성을 표시합니다.';
      emptyStateEl.style.display='none';
    });

    // ===== 가운데 스플리터: 드래그로 폭 조절 =====
    const grid = document.getElementById('grid');
    const splitter = document.getElementById('splitter');
    let dragging = false;
    let startX = 0;
    let startLeftWidth = 0; // px 기준

    function getLeftWidthPx(){
      const cols = getComputedStyle(grid).gridTemplateColumns.split(' ');
      // 현재 좌측이 fr일 수 있으므로 실제 px로 계산
      const rect = grid.getBoundingClientRect();
      const rightPx = document.getElementById('rightWin').getBoundingClientRect().width;
      const gutter = splitter.getBoundingClientRect().width;
      const leftPx = rect.width - rightPx - gutter - 10 /*gap 보정*/;
      return leftPx;
    }

    splitter.addEventListener('mousedown', (e)=>{
      dragging = true;
      startX = e.clientX;
      startLeftWidth = document.getElementById('leftWin').getBoundingClientRect().width;
      document.body.style.userSelect='none';
    });
    window.addEventListener('mousemove', (e)=>{
      if(!dragging) return;
      const dx = e.clientX - startX;
      let newLeft = Math.max(260, startLeftWidth + dx);     // 최소 260px
      const gridRect = grid.getBoundingClientRect();
      const maxLeft = gridRect.width - 260 - splitter.offsetWidth - 10; // 우측 최소 260px
      newLeft = Math.min(newLeft, maxLeft);
      const right = gridRect.width - newLeft - splitter.offsetWidth - 10;
      grid.style.gridTemplateColumns = `${newLeft}px 10px ${right}px`;
    });
    window.addEventListener('mouseup', ()=>{
      dragging = false;
      document.body.style.userSelect='';
    });

    // 버튼은 모양만 ">"로 유지 (토글은 없이 드래그만)
    document.getElementById('splitBtn').addEventListener('click', (e)=>{ /*no-op*/ });

    // 초기: 첫 번째 항목 자동 선택(있으면)
    const firstRow = document.querySelector('.repo-row');
    if(firstRow) renderDetails(firstRow.getAttribute('data-index'));
  </script>
</body>
</html>

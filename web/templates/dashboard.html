<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Project Guardian - OSS Activity Explorer</title>
  <style>
    body{background-color:#3A6EA5;font-family:Gulim, Dotum, "Tahoma", Geneva, sans-serif;font-size:12px; margin:0; padding:0; overflow:hidden;}
    .desktop{height:100vh;width:100vw;display:grid;grid-template-rows:1fr 30px;}
    .workspace{position:relative;overflow:hidden;padding:10px;}
    .grid{height:100%;display:grid;grid-template-columns: 2fr 10px 2fr 10px 1.5fr;gap:10px;align-items:stretch;}
    .window{border:2px solid #0058E1;border-radius:8px 8px 0 0;background:#ECE9D8;box-shadow:5px 5px 15px rgba(0,0,0,.5);display:flex;flex-direction:column;overflow:hidden;}
    .title-bar{background:linear-gradient(to bottom,#0058E1,#3A85E1);color:#fff;font-weight:bold;padding:6px 8px;display:flex;align-items:center;gap:6px;user-select:none;flex-shrink: 0;}
    .toolbar{display:flex;gap:8px;align-items:center;padding:8px 10px;background:#f5f2e8;border-bottom:1px solid #cfc9b8; flex-shrink: 0;}
    .toolbar button, .toolbar a button {border:1px solid #000;background:#ECE9D8;padding:5px 10px;cursor:pointer; font-family: inherit;}
    .content-area { padding:10px;flex-grow:1;overflow:auto;color:#000; }
    .repo-row, .dep-row {padding:10px;border:1px solid #ccc;background:#fff;border-radius:4px;display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px;cursor:pointer;}
    .repo-row.active, .dep-row.active { outline:2px solid #3A85E1;background:#f5f9ff; }
    .repo-name, .dep-name {font-weight:bold;color:#0058E1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:260px;}
    .chip{font-size:11px;background:#e7eefc;border:1px solid #bfd0f5;padding:1px 6px;border-radius:10px;color:#245edc;white-space:nowrap;}
    .handle{background:#D6D3C6; border:1px solid #9f9a87;border-radius:8px;user-select:none;cursor:col-resize; display:flex; align-items:center; justify-content:center;}
    .detail-content { font-family: 'Malgun Gothic', sans-serif; }
    .detail-header { border-bottom: 1px solid #ccc; padding-bottom: 8px; margin-bottom: 8px; }
    .detail-title { font-size: 14px; font-weight: bold; }
    .detail-meta { font-size: 11px; color: #555; }
    .detail-score { font-size: 18px; font-weight: bold; padding: 5px; border-radius: 4px; text-align: center; }
    .detail-section { margin-top: 15px; }
    .detail-section h4 { margin: 0 0 5px 0; font-size: 12px; border-bottom: 1px solid #ddd; padding-bottom: 3px; }
    .detail-list { list-style: none; padding-left: 0; margin: 0; font-size: 11px; max-height: 200px; overflow-y: auto; background: #fff; border: 1px solid #ccc; }
    .detail-list li { padding: 4px 6px; border-bottom: 1px solid #eee; }
    .empty-state, .loading-state, .error-state { padding: 20px; text-align: center; color: #666; }
    .error-state { color: #D64F34; font-weight: bold; text-align: left; white-space: pre-wrap; word-break: break-all; }
    .loading-spinner {border: 4px solid #f0f0f0; border-top: 4px solid #3A85E1;border-radius: 50%; width: 30px; height: 30px;animation: spin 1s linear infinite; margin: 0 auto 10px auto;}
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .taskbar{background:linear-gradient(to bottom,#245EDC,#3A85E1);border-top:1px solid #66A3FF;display:flex;align-items:center;gap:8px;padding:0 6px;}
    .start-button{background:linear-gradient(to bottom,#72BE4A,#55A82B);color:#fff;font-weight:bold;font-size:16px;border:2px outset #55A82B;border-radius:10px 10px 0 0;padding:2px 20px;margin-left:5px;font-style:italic;cursor:pointer;user-select:none;}
    a{color:#0058E1;text-decoration:none;} a:hover{text-decoration:underline;}
  </style>
</head>
<body>
  <div class="desktop">
    <div class="workspace">
      <div class="grid" id="mainGrid">
        <div class="window" id="myReposPane">
          <div class="title-bar"><div class="title-text">{{ user_id }}'s Repositories</div></div>
          <div class="toolbar">
            <input id="filterInput" type="text" placeholder="레포/의존성 검색" />
            <button id="refreshBtn">새로고침</button>
            <a href="{{ url_for('logout') }}"><button>Logout</button></a>
          </div>
          <div class="content-area" id="repoList">
            {% for item in items %}
            <div class="repo-row" data-repo-id="{{ item.id }}">
              <div class="repo-title"><span class="repo-name" title="{{ item.repositoryName }}">{{ item.repositoryName }}</span></div>
              <span class="chip">{{ item.dependencies | length }} dependencies</span>
            </div>
            {% endfor %}
          </div>
        </div>
        <div class="handle" data-splitter-for="1"></div>
        <div class="window" id="dependenciesPane">
          <div class="title-bar"><div class="title-text">Dependencies</div></div>
          <div class="content-area" id="depsList">
             <div class="empty-state">Select a repository to see its dependencies.</div>
          </div>
        </div>
        <div class="handle" data-splitter-for="2"></div>
        <div class="window" id="activityPane">
          <div class="title-bar"><div class="title-text">OSS Activity Details</div></div>
          <div class="content-area" id="activityDetails">
            <div class="empty-state">Select a dependency to see its latest activity.</div>
          </div>
        </div>
      </div>
    </div>
    <div class="taskbar"><div class="start-button">start</div></div>
  </div>

  <script>
    const REPO_DATA = {{ items|tojson }};
    const repoListEl = document.getElementById('repoList');
    const depsListEl = document.getElementById('depsList');
    const activityDetailsEl = document.getElementById('activityDetails');
    const refreshBtn = document.getElementById('refreshBtn');

    refreshBtn.addEventListener('click', () => {
        refreshBtn.textContent = 'Refreshing...';
        refreshBtn.disabled = true;
        window.location.href = "{{ url_for('sync_my_repos_route') }}";
    });

    repoListEl.addEventListener('click', e => {
        const row = e.target.closest('.repo-row');
        if (!row) return;
        document.querySelectorAll('.repo-row').forEach(r => r.classList.remove('active'));
        row.classList.add('active');
        const repoId = row.dataset.repoId;
        const repo = REPO_DATA.find(r => r.id === repoId);
        renderDependencies(repo);
        clearActivityDetails();
    });

    function renderDependencies(repo) {
        if (!repo || !repo.dependencies || repo.dependencies.length === 0) {
            depsListEl.innerHTML = '<div class="empty-state">No dependencies found.</div>';
            return;
        }
        depsListEl.innerHTML = repo.dependencies.map(dep => {
            const [repoFullName, version] = dep.split(' ');
            return `<div class="dep-row" data-repo-full-name="${repoFullName}">
                        <span class="dep-name" title="${dep}">${repoFullName}</span>
                        <span class="chip">${version || 'N/A'}</span>
                    </div>`;
        }).join('');
    }

    depsListEl.addEventListener('click', e => {
        const row = e.target.closest('.dep-row');
        if (!row) return;
        document.querySelectorAll('.dep-row').forEach(r => r.classList.remove('active'));
        row.classList.add('active');
        const repoFullName = row.dataset.repoFullName;
        fetchAndRenderActivity(repoFullName);
    });

    async function fetchAndRenderActivity(repoFullName) {
        activityDetailsEl.innerHTML = `<div class="loading-state"><div class="loading-spinner"></div>Fetching latest activity for ${repoFullName}...</div>`;
        try {
            const response = await fetch(`/get_oss_activity/${repoFullName}`);

            if (response.status === 401) {
                alert('세션이 만료되었거나 인증에 실패했습니다. 다시 로그인해주세요.');
                window.location.href = "{{ url_for('login') }}";
                return;
            }

            const data = await response.json();
            if (!response.ok || data.error) {
                throw new Error(data.error || `HTTP error! status: ${response.status}`);
            }
            renderActivityDetails(data);
        } catch (error) {
            activityDetailsEl.innerHTML = `<div class="error-state"><strong>Failed to fetch activity:</strong><br>${error.message}</div>`;
        }
    }

    function renderActivityDetails(data) {
        const score = data.anomaly_score;
        let scoreColor = '#666';
        // [수정] score 타입이 숫자인지 먼저 확인하도록 조건 강화
        if (typeof score === 'number') {
            if (score > 0.8) scoreColor = '#e53e3e';
            else if (score > 0.5) scoreColor = '#dd6b20';
            else scoreColor = '#38a169';
        }
        
        const commitsHtml = (data.commits || []).map(c => `<li><strong>${c.author.name}:</strong> ${c.message.split('\\n')[0]}</li>`).join('');

        // [수정] 백엔드에서 'NoPushEvent' 타입을 보냈을 때를 위한 UI 처리 추가
        const detailsHtml = data.event_type === 'NoPushEvent' 
        ? `
            <div class="detail-section">
                <h4>Latest Push Event Details</h4>
                <ul class="detail-list">
                    <li><strong>Status:</strong> No recent push activity found. Considered low risk.</li>
                </ul>
            </div>
            <div class="detail-section">
                <h4>Commits in Push (0)</h4>
                <ul class="detail-list"><li>No recent push activity detected.</li></ul>
            </div>
        `
        : `
            <div class="detail-section">
                <h4>Latest Push Event Details</h4>
                <ul class="detail-list">
                    <li><strong>Actor:</strong> ${data.actor || 'N/A'}</li>
                    <li><strong>Event Time (UTC):</strong> ${new Date(data.created_at).toLocaleString()}</li>
                    <li><strong>Force Push:</strong> ${data.features.force_push === 1 ? 'Yes' : 'No'}</li>
                    <li><strong>Sensitive Path Touched:</strong> ${data.features.touched_sensitive_paths === 1 ? 'Yes' : 'No'}</li>
                    <li><strong>Dependency File Changed:</strong> ${data.features.dep_change_cnt === 1 ? 'Yes' : 'No'}</li>
                </ul>
            </div>
            <div class="detail-section">
                <h4>Commits in Push (${(data.commits || []).length})</h4>
                <ul class="detail-list">${commitsHtml || '<li>No commit info</li>'}</ul>
            </div>
        `;

        activityDetailsEl.innerHTML = `
            <div class="detail-content">
                <div class="detail-header">
                    <div class="detail-title">${data.repo_full_name}</div>
                    <div class="detail-meta">Last synced: ${new Date(data.last_synced).toLocaleString()}</div>
                </div>
                <div class="detail-section">
                    <h4>Anomaly Score</h4>
                    <div class="detail-score" style="background-color: ${scoreColor}; color: white;">
                        ${(typeof score === 'number') ? score.toFixed(2) : 'N/A'}
                    </div>
                </div>
                ${detailsHtml}
            </div>`;
    }

    function clearActivityDetails() {
        activityDetailsEl.innerHTML = '<div class="empty-state">Select a dependency to see its latest activity.</div>';
    }

    document.querySelectorAll('.handle').forEach(handle => {
        handle.addEventListener('mousedown', e => {
            const mainGrid = document.getElementById('mainGrid');
            const startX = e.clientX;
            const gridTemplate = getComputedStyle(mainGrid).gridTemplateColumns.split(' ').map(v => parseFloat(v));
            const splitterIndex = parseInt(handle.dataset.splitterFor) * 2 - 1;
            const onMouseMove = moveEvent => {
                const dx = moveEvent.clientX - startX;
                const newCols = [...gridTemplate];
                newCols[splitterIndex - 1] += dx;
                newCols[splitterIndex + 1] -= dx;
                mainGrid.style.gridTemplateColumns = newCols.map(v => `${v}px`).join(' ');
            };
            const onMouseUp = () => {
                window.removeEventListener('mousemove', onMouseMove);
                window.removeEventListener('mouseup', onMouseUp);
            };
            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('mouseup', onMouseUp);
        });
    });
  </script>
</body>
</html>
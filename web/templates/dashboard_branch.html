<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Project Guardian – Branch Activity</title>
  <style>
    /* 기본(XP풍 시스템) 폰트 */
    body, button, input, select { font-family: Tahoma, Geneva, Verdana, sans-serif; font-size: 12px; }

    /* 3-열 기본 레이아웃 */
    .layout { display: grid; grid-template-columns: 1fr 6px 1.2fr 6px 1.2fr; height: 100vh; margin: 0; }
    .col { display: flex; flex-direction: column; min-width: 0; }
    .col header { padding: 8px; border-bottom: 1px solid #ddd; }
    .col header h3 { margin: 0; font-size: 14px; }
    .col .body { flex: 1; overflow: auto; padding: 8px; }

    /* 수직 리사이저(드래그로 폭 조절) — 마우스 이동 방향과 같은 방향으로 동작 */
    .gutter { background:#eee; cursor: col-resize; }
    .gutter:hover { background:#ddd; }

    /* 날짜 블록 헤더 (상단 오렌지) */
    .date-header {
      margin: 12px 0 8px 0; padding: 10px 12px; border-radius: 6px;
      background: rgb(255,149,0); /* Apple system orange */
      color: #fff; display: flex; align-items: center; justify-content: space-between;
    }
    .date-header .meta { opacity: .9; }

    /* 브랜치 행 & 토글 */
    .branch-row { border: 1px solid #ccc; border-radius: 6px; margin-bottom: 8px; }
    .branch-head {
      display:flex; align-items:center; gap:8px; padding:8px 10px; background:#fafafa; cursor:pointer;
    }
    .branch-name { font-weight:bold; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #bbb; border-radius:999px; background:#f4f4f4; margin-left:4px; }
    .branch-body { display:none; max-height:320px; overflow:auto; padding:6px 8px 10px 8px; background:#fff; border-top:1px solid #e6e6e6; }
    .branch-row.open .branch-body { display:block; }

    /* 커밋 아이템 */
    .commit { display:flex; align-items:center; justify-content:space-between; gap:12px;
              padding:8px 10px; border:1px solid #e6e6e6; border-radius:6px; background:#fff; margin-bottom:6px; }
    .commit-msg { overflow:hidden; white-space:nowrap; text-overflow:ellipsis; max-width: calc(100% - 120px); }
    .sha { font-family: Consolas, "Courier New", monospace; background:#f2f6ff; border:1px solid #cfe0ff;
           padding:2px 8px; border-radius:999px; color:#2b5fd9; }
    .fresh { display:inline-flex; align-items:center; gap:4px;
             color:#1a7f37; font-weight:bold; margin-right:6px; }
    .fresh::before { content:"✔"; display:inline-block; }

    /* 오른쪽 패널(커밋 상세) */
    .kv { margin:0; padding:0; list-style:none; }
    .kv li { display:flex; gap:8px; border-bottom:1px solid #eee; padding:6px 0; }
    .kv b { width:110px; flex:0 0 110px; }

    /* 상단 툴바 */
    .toolbar { display:flex; gap:6px; align-items:center; }
    .toolbar input[type="text"]{ padding:6px; border:1px solid #bbb; border-radius:4px; min-width: 220px; }

    /* 비어있음/오류 */
    .empty { color:#666; padding:16px; border:1px dashed #ccc; border-radius:6px; background:#fafafa; }
    .error { color:#b00020; white-space:pre-wrap; word-break:break-all; padding:10px; border:1px solid #f0c0c0; background:#fff5f5; border-radius:6px; }
  </style>
</head>
<body>
  <div class="layout">
    <!-- Repositories -->
    <section class="col" id="col-repos">
      <header>
        <h3>Repositories</h3>
        <div class="toolbar">
          <input id="repoFilter" type="text" placeholder="owner/repo 필터" />
          <button id="btnSync">동기화</button>
          <a href="{{ url_for('logout') }}"><button>Logout</button></a>
        </div>
      </header>
      <div class="body" id="repoList"></div>
    </section>

    <div class="gutter" data-left="col-repos" data-right="col-days"></div>

    <!-- Days & Branches -->
    <section class="col" id="col-days">
      <header>
        <h3>Days &amp; Branches</h3>
        <div class="toolbar">
          <input id="dayFilter" type="text" placeholder="브랜치 또는 날짜(YYYY-MM-DD) 필터" />
          <button id="btnClearFilter">Clear</button>
          <span id="lastRefresh" style="margin-left:auto;color:#666;"></span>
        </div>
      </header>
      <div class="body" id="daysPane">
        <div class="empty">레포지토리를 선택하세요.</div>
      </div>
    </section>

    <div class="gutter" data-left="col-days" data-right="col-detail"></div>

    <!-- Commit Detail -->
    <section class="col" id="col-detail">
      <header><h3>Commit Detail</h3></header>
      <div class="body" id="detailPane"><div class="empty">커밋을 선택하세요.</div></div>
    </section>
  </div>

  <script>
    /* --------------------- 초기 데이터 --------------------- */
    const RAW_LOGS = {{ logs|tojson|safe }};      // /dashboard 에서 내려주는 사용자 branch_log 집합
    const USER_REPOS = {{ repos|tojson|safe }};   // 사용자의 저장소 목록
    const USER_ID = "{{ user_id }}";

    /* 상태: 선택/열림 유지 */
    let currentRepo = null;        // "owner/repo"
    const openBranchKeys = new Set(); // 예: "2025-09-12|webdevelop"
    const scrollMemory = { days: 0 }; // 스크롤 위치 유지
    let AUTO_TIMER = null;

    /* 도구 */
    const qs = (s, p=document) => p.querySelector(s);
    const qsa = (s, p=document) => [...p.querySelectorAll(s)];

    function fmtKST(iso){
      if(!iso) return '';
      return new Date(iso).toLocaleString("ko-KR", {
        timeZone: "Asia/Seoul", year:"numeric", month:"2-digit", day:"2-digit",
        hour:"2-digit", minute:"2-digit", second:"2-digit"
      });
    }
    function shortSha(sha){ return (sha||'').substring(0,7); }
    function isFresh(iso){
      if(!iso) return false;
      const now = Date.now();
      const d = new Date(iso).getTime();
      return (now - d) <= 3*60*1000; // 3분 이내
    }
    function branchKey(day, branch){ return `${day}|${branch}`; }

    /* --------------------- 리사이저 --------------------- */
    qsa('.gutter').forEach(g => {
      let startX, leftW, rightW, leftEl, rightEl;
      g.addEventListener('mousedown', (e)=>{
        leftEl = qs(`#${g.dataset.left}`); rightEl = qs(`#${g.dataset.right}`);
        const rectL = leftEl.getBoundingClientRect();
        const rectR = rightEl.getBoundingClientRect();
        startX = e.clientX; leftW = rectL.width; rightW = rectR.width;
        const onMove = (ev)=>{
          const dx = ev.clientX - startX;         // 마우스 이동 방향 = 패널 변경 방향
          leftEl.style.width  = (leftW + dx) + 'px';
          rightEl.style.width = (rightW - dx) + 'px';
        };
        const onUp = ()=>{
          window.removeEventListener('mousemove', onMove);
          window.removeEventListener('mouseup', onUp);
        };
        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', onUp);
      });
    });

    /* --------------------- 레포 렌더 --------------------- */
    const repoListEl = qs('#repoList');
    function renderRepos() {
      const f = qs('#repoFilter').value.trim().toLowerCase();
      const items = USER_REPOS
        .map(r => ({ full: r.repositoryName || r, name: (r.repositoryName||r).split('/').slice(-1)[0] }))
        .filter(x => !f || x.full.toLowerCase().includes(f));
      repoListEl.innerHTML = '';
      if(items.length === 0){ repoListEl.innerHTML = '<div class="empty">레포가 없습니다.</div>'; return;}
      items.forEach(x=>{
        const btn = document.createElement('button');
        btn.textContent = x.name; btn.style.margin='0 6px 6px 0';
        btn.addEventListener('click', ()=> selectRepo(x.full));
        repoListEl.appendChild(btn);
      });
    }

    /* --------------------- 날짜/브랜치 렌더 --------------------- */
    const daysPane = qs('#daysPane');

    function groupByDayAndBranch(logs) {
      // 입력: branch_log 문서들(여러 레포), 여기서는 currentRepo만 필터
      // 필드 가정: date, repo, branch, commits[], dep_changes, commit_count 등
      const by = {};
      logs.forEach(l=>{
        if(l.repo_full_name !== currentRepo) return;
        const day = l.date;                  // YYYY-MM-DD
        const branch = l.branch;
        if(!by[day]) by[day] = {};
        if(!by[day][branch]) by[day][branch] = { commits: [], commit_count: 0, dep_changes: 0 };
        const slot = by[day][branch];
        slot.commit_count += (l.counts && l.counts.commits) || l.commit_count || 0;
        slot.dep_changes += (l.counts && l.counts.dep_files_changed) || l.dep_changes || 0;
        (l.examples || l.commits || []).forEach(c=> slot.commits.push(c));
      });
      // 최신순으로 정렬
      const days = Object.keys(by).sort((a,b)=> (a>b?-1:1));
      return { days, by };
    }

    function renderDays() {
      const f = qs('#dayFilter').value.trim().toLowerCase();
      const { days, by } = groupByDayAndBranch(RAW_LOGS);
      // 스크롤 위치 기억/복원
      daysPane.scrollTop = scrollMemory.days || 0;
      daysPane.innerHTML = '';

      if(!currentRepo){ daysPane.innerHTML = '<div class="empty">레포지토리를 선택하세요.</div>'; return; }
      if(days.length===0){ daysPane.innerHTML = '<div class="empty">로그가 없습니다.</div>'; return; }

      days.forEach(day=>{
        // 날짜 헤더
        const dayBox = document.createElement('div');
        const header = document.createElement('div');
        header.className = 'date-header';
        header.innerHTML = `<div><b>${day}</b></div><div class="meta">${Object.keys(by[day]).length} item(s)</div>`;
        dayBox.appendChild(header);

        // 브랜치들(이름 오름차순)
        Object.keys(by[day]).sort().forEach(branch=>{
          const key = branchKey(day, branch);
          const info = by[day][branch];

          const row = document.createElement('div');
          row.className = 'branch-row' + (openBranchKeys.has(key)?' open':'');

          const head = document.createElement('div');
          head.className = 'branch-head';
          head.innerHTML =
            `<span class="branch-name">${branch}</span>
             <span class="pill">C ${info.commit_count||info.commits.length||0}</span>
             <span class="pill">D ${info.dep_changes||0}</span>
             <button style="margin-left:auto" class="btnToggle">${row.classList.contains('open')?'접기':'펼치기'}</button>`;
          head.addEventListener('click', (ev)=>{
            if(ev.target.classList.contains('btnToggle')){
              // 토글 버튼으로도 되지만 전체 영역 클릭 시에도 토글
            }
            row.classList.toggle('open');
            const opened = row.classList.contains('open');
            qs('.btnToggle', head).textContent = opened? '접기' : '펼치기';
            if(opened) openBranchKeys.add(key); else openBranchKeys.delete(key);
          });
          row.appendChild(head);

          const body = document.createElement('div');
          body.className = 'branch-body';

          // 커밋 최신순
          const commits = (info.commits || []).slice().sort((a,b)=>{
            const da = (a.timestamp || a.date || a.committer?.date || a.author?.date || '');
            const db = (b.timestamp || b.date || b.committer?.date || b.author?.date || '');
            return (da>db? -1: 1);
          });

          if(commits.length===0){
            body.innerHTML = `<div class="empty">커밋 없음</div>`;
          }else{
            commits.forEach(c=>{
              const iso = c.timestamp || c.date || c.committer?.date || c.author?.date || null;
              const item = document.createElement('div');
              item.className = 'commit';
              const left = document.createElement('div');
              left.className = 'commit-msg';
              // 메시지 한 줄
              const msg = (c.message || c.commit?.message || '').split('\n')[0] || '(no message)';
              // 좌측: (신규표시) 메시지
              left.innerHTML = `${isFresh(iso)?'<span class="fresh">NEW</span>':''}<span title="${msg}">${msg}</span>`;
              const right = document.createElement('div');
              right.innerHTML = `
                <span class="sha" title="${iso?fmtKST(iso):''}">${shortSha(c.sha || c.id || c.node_id || '')}</span>
              `;
              item.appendChild(left); item.appendChild(right);

              // 상세 요청
              item.addEventListener('click', ()=>{
                renderCommitDetail({
                  repo: currentRepo, branch,
                  sha: c.sha || c.id || '',
                  author: c.author?.name || c.commit?.author?.name || c.committer?.name || c.author || '',
                  date: iso,
                  message: msg,
                  url: c.html_url || c.url || ''
                });
              });

              body.appendChild(item);
            });
          }

          row.appendChild(body);
          dayBox.appendChild(row);
        });

        daysPane.appendChild(dayBox);
      });

      // 마지막 갱신 표시
      qs('#lastRefresh').textContent = `갱신: ${fmtKST(new Date().toISOString())}`;
    }

    /* --------------------- 커밋 상세 --------------------- */
    const detailPane = qs('#detailPane');
    async function renderCommitDetail(meta){
      try{
        // 백엔드 상세 API가 있다면 호출, 없으면 meta로 표시
        // const q = new URLSearchParams({ repo: meta.repo, sha: meta.sha });
        // const r = await fetch('/api/commit_detail?'+q); const d = await r.json();
        const d = meta; // 프론트 메타만으로 표시
        detailPane.innerHTML = `
          <ul class="kv">
            <li><b>Repository</b><span>${d.repo}</span></li>
            <li><b>Branch</b><span>${d.branch||''}</span></li>
            <li><b>SHA</b><span>${d.sha||''}</span></li>
            <li><b>Author</b><span>${d.author||''}</span></li>
            <li><b>When</b><span>${d.date?fmtKST(d.date):''}</span></li>
            <li><b>Message</b><span>${(d.message||'').replace(/</g,'&lt;')}</span></li>
            ${d.url?`<li><b>Link</b><a href="${d.url}" target="_blank" rel="noopener">View on GitHub</a></li>`:''}
          </ul>
        `;
      }catch(err){
        detailPane.innerHTML = `<div class="error">${err.message||String(err)}</div>`;
      }
    }

    /* --------------------- 동작 --------------------- */
    function selectRepo(full){
      currentRepo = full;
      // Days 스크롤/열림 유지 초기화
      scrollMemory.days = 0;
      openBranchKeys.clear();
      renderDays();
    }

    // 필터 & 버튼
    qs('#btnClearFilter').addEventListener('click', ()=>{ qs('#dayFilter').value=''; renderDays(); });
    qs('#repoFilter').addEventListener('input', renderRepos);
    qs('#dayFilter').addEventListener('input', renderDays);
    qs('#btnSync').addEventListener('click', ()=>{ window.location.href = "{{ url_for('sync_my_repos_route') }}"; });

    // 창 열림 상태/스크롤 유지하며 갱신
    async function autoRefresh(){
      try{
        // 현재 스크롤/열림 상태 기억
        scrollMemory.days = daysPane.scrollTop;

        // 서버에서 최신 데이터를 다시 가져오기 (페이지 리로드 없이)
        const r = await fetch("{{ url_for('dashboard') }}", { headers:{ 'X-Requested-With':'fetch' }});
        const html = await r.text();

        // 응답에서 RAW_LOGS/USER_REPOS json만 추출하도록 백엔드가 지원하면 좋지만,
        // 여기서는 간단히 window.location.reload() 대체 없이 기존 데이터를 사용한다고 가정.
        // ※ 실제 최신화를 원하면 별도 /api/branch_logs 같은 JSON 엔드포인트를 두는 것을 권장.
        // ----> 이미 백엔드에 /dashboard 가 템플릿을 렌더하므로, 아래는 예비: noop

      }catch(_e){
        // 네트워크 실패 시 조용히 무시
      }finally{
        renderDays(); // 열린 상태/스크롤 유지 반영하여 다시 렌더
      }
    }

    function startAutoRefresh(){
      if(AUTO_TIMER) clearInterval(AUTO_TIMER);
      AUTO_TIMER = setInterval(autoRefresh, 60*1000); // 1분
    }

    // 초기 렌더
    renderRepos();
    startAutoRefresh();

    // 최초 자동 선택(첫 레포)
    if(USER_REPOS && USER_REPOS.length){
      const first = (USER_REPOS[0].repositoryName || USER_REPOS[0]);
      selectRepo(first);
    }

    // 페이지 이탈 시 타이머 정리
    window.addEventListener('beforeunload', ()=> AUTO_TIMER && clearInterval(AUTO_TIMER));
  </script>
</body>
</html>

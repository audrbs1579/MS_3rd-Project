<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <title>Branch Activity – {{ user_id }}</title>
  <style>
    body{margin:0;font:14px/1.4 Tahoma, Geneva, Verdana, sans-serif;color:#111;}
    header{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-bottom:1px solid #ddd}
    .hint{color:#666;font-size:12px;margin-left:8px}
    .btn{padding:6px 10px;border:1px solid #ccc;background:#f7f7f7;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .wrap{display:grid;grid-template-columns: 320px 8px 1fr 8px 520px; height: calc(100vh - 50px);}
    .pane{overflow:auto}
    .handle{background:#e5e5e5;cursor:col-resize}

    /* repo chips */
    .repo-bar{padding:12px}
    .chip{display:inline-block;border:1px solid #ccc;border-radius:14px;padding:4px 10px;margin:0 8px 8px 0;background:#fafafa;cursor:pointer}
    .chip.active{background:#e7f1ff;border-color:#7fb3ff}
    .filter{width:100%;padding:7px;border:1px solid #ccc;margin-bottom:10px}

    /* day header */
    .day{margin:12px 12px 8px 12px;background:rgb(255,149,0);color:#fff;border-radius:6px;padding:10px 12px;display:flex;justify-content:space-between;align-items:center}
    .box{margin:0 12px 12px 12px;border:1px dashed #ccc;border-radius:6px;padding:10px}

    .branch-row{display:flex;align-items:center;gap:8px;margin:10px 12px}
    .branch-name{font-weight:bold}
    .pill{font-size:12px;border:1px solid #ccc;border-radius:999px;padding:2px 8px;background:#f5f5f5}
    .toggle{margin-left:auto}

    .commit{display:flex;justify-content:space-between;align-items:center;border:1px solid #eee;border-radius:6px;padding:8px 10px;margin:6px 0;background:#fff}
    .sha{font-family:monospace;border:1px solid #cfe2ff;background:#eaf3ff;border-radius:12px;padding:2px 8px}
    .newdot{width:10px;height:10px;border-radius:50%;background:#25b45a;margin-right:6px;display:inline-block;vertical-align:middle}
    .muted{color:#666;font-size:12px}
    .empty{color:#666;padding:12px}

    /* commit detail */
    #detail{padding:12px}
    pre{white-space:pre-wrap;background:#fafafa;border:1px solid #eee;border-radius:6px;padding:10px}
  </style>
</head>
<body>
  <header>
    <div>
      <strong>Branch Activity – {{ user_id }}</strong>
      <span class="hint">KST로 표시 / 1분마다 자동 새로고침</span>
    </div>
    <div>
      <button id="btnSync" class="btn">동기화</button>
      <a href="{{ url_for('logout') }}"><button class="btn">Logout</button></a>
    </div>
  </header>

  <div class="wrap" id="grid">
    <!-- Repositories -->
    <section class="pane" id="reposPane">
      <div class="repo-bar">
        <input id="repoFilter" class="filter" placeholder="owner/repo 필터"/>
        <div id="repoChips"></div>
      </div>
    </section>
    <div class="handle" id="split1"></div>

    <!-- Days & Branches -->
    <section class="pane" id="daysPane">
      <div id="daysRoot"></div>
    </section>
    <div class="handle" id="split2"></div>

    <!-- Commit Detail -->
    <section class="pane" id="detailPane">
      <div id="detail" class="muted">왼쪽에서 커밋을 선택하세요.</div>
    </section>
  </div>

  <script>
    // ----- Server data -----
    const RAW_LOGS = {{ logs|tojson|safe }};
    const USER_REPOS = {{ repos|tojson|safe }};
    const USER_ID = "{{ user_id }}";

    // ----- State keepers -----
    let currentRepo = null;
    const openBranches = new Set();        // 'YYYY-MM-DD::branch'
    const selectedCommit = { repo:null, sha:null };

    // ----- Helpers -----
    const qs = sel => document.querySelector(sel);
    const ce = (t, cls) => { const e=document.createElement(t); if(cls) e.className=cls; return e; };
    const fmtKST = iso => {
      if (!iso) return '';
      const d = new Date(iso);
      return d.toLocaleString("ko-KR", { timeZone:"Asia/Seoul", year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit", second:"2-digit" });
    };
    const withinMin = (iso, m) => {
      if (!iso) return false;
      const t = new Date(iso).getTime();
      return (Date.now() - t) <= m*60*1000;
    };

    // ----- Build repo chips -----
    const chipWrap = qs('#repoChips');
    function renderRepoChips(repos) {
      chipWrap.innerHTML = '';
      (repos || []).forEach(full => {
        const short = full.split('/').pop();
        const chip = ce('span','chip');
        chip.textContent = short;
        chip.title = full;
        chip.addEventListener('click', ()=>{ document.querySelectorAll('.chip').forEach(c=>c.classList.remove('active')); chip.classList.add('active'); currentRepo = full; loadLogs(full); });
        chipWrap.appendChild(chip);
      });
    }
    renderRepoChips(USER_REPOS);

    // Filter
    qs('#repoFilter').addEventListener('input', e=>{
      const q = e.target.value.toLowerCase();
      [...chipWrap.children].forEach(ch=>{
        ch.style.display = ch.title.toLowerCase().includes(q) ? '' : 'none';
      });
    });

    // ----- Days & Branches renderer -----
    const daysRoot = qs('#daysRoot');

    function groupByDay(logs){
      const map = new Map(); // day -> [docs]
      logs.forEach(d=>{
        const day = d.date;
        if(!map.has(day)) map.set(day, []);
        map.get(day).push(d);
      });
      // sort day desc
      return [...map.entries()].sort((a,b)=> b[0].localeCompare(a[0]));
    }

    function renderDays(logs){
      daysRoot.innerHTML = '';
      if(!logs || !logs.length){
        daysRoot.innerHTML = '<div class="empty">선택한 저장소의 기록이 없습니다.</div>';
        return;
      }
      const grouped = groupByDay(logs);
      grouped.forEach(([day, arr])=>{
        const header = ce('div','day');
        header.innerHTML = `<div>${day}</div><div class="muted">${arr.length} item(s)</div>`;
        daysRoot.appendChild(header);

        arr.forEach(doc=>{
          const row = ce('div','branch-row');
          const pillC = ce('span','pill'); pillC.textContent = `C ${doc.counts?.commits ?? doc.commit_count ?? 0}`;
          const pillD = ce('span','pill'); pillD.textContent = `D ${doc.counts?.dep_files ?? doc.dep_changed ?? 0}`;
          const name = ce('span','branch-name'); name.textContent = doc.branch;

          const btn = ce('button','btn toggle'); btn.textContent = '접기';
          const key = `${day}::${doc.branch}`;
          if(!openBranches.has(key)) openBranches.add(key);

          const box = ce('div','box');
          if(!doc.examples || !doc.examples.length){
            box.innerHTML = '<div class="muted">커밋 없음</div>';
          }else{
            box.innerHTML = '';
            doc.examples
              .sort((a,b)=> (b.commit_time||'').localeCompare(a.commit_time||''))
              .forEach(c=>{
                const item = ce('div','commit');
                const left = ce('div');
                const right = ce('div');
                const newIcon = withinMin(c.commit_time,3) ? '<span class="newdot"></span>' : '';
                left.innerHTML = `${newIcon}${(c.message||'').replace(/[<>&]/g,s=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]))}`;
                right.innerHTML = `<span class="sha">${(c.sha||'').slice(0,7)}</span>`;
                item.appendChild(left); item.appendChild(right);
                item.addEventListener('click',()=> showCommitDetail(doc.repo_full_name, c.sha));
                box.appendChild(item);
              });
          }

          btn.addEventListener('click', ()=>{
            if(box.style.display==='none'){ box.style.display=''; btn.textContent='접기'; openBranches.add(key); }
            else { box.style.display='none'; btn.textContent='펼치기'; openBranches.delete(key); }
          });
          if(!openBranches.has(key)){ box.style.display='none'; btn.textContent='펼치기'; }

          row.appendChild(name);
          row.appendChild(pillC);
          row.appendChild(pillD);
          row.appendChild(btn);
          daysRoot.appendChild(row);
          daysRoot.appendChild(box);
        });
      });
    }

    // ----- Load logs for repo -----
    async function loadLogs(repoFull){
      try{
        const r = await fetch(`/api/branch_logs?userId=${encodeURIComponent(USER_ID)}&repo=${encodeURIComponent(repoFull)}`);
        const data = await r.json();
        renderDays(data);
      }catch(e){
        console.error(e);
        daysRoot.innerHTML = '<div class="empty">불러오기 실패</div>';
      }
    }

    // ----- Commit detail -----
    const detailEl = qs('#detail');
    async function showCommitDetail(repo, sha){
      selectedCommit.repo = repo; selectedCommit.sha = sha;
      detailEl.innerHTML = '불러오는 중...';
      try{
        const r = await fetch(`/api/commit_detail?repo=${encodeURIComponent(repo)}&sha=${encodeURIComponent(sha)}`);
        const d = await r.json();
        if(d.error){ detailEl.textContent = d.error; return; }
        const info = d.commit || {};
        const msg = (info.message||'').trim();
        const author = info.author?.name || d.author?.login || 'unknown';
        const when = info.author?.date || info.committer?.date;
        const files = (d.files||[]).map(f=>`- ${f.filename} (${f.status}) +${f.additions} -${f.deletions}`).join('\n');
        detailEl.innerHTML = `
          <div><strong>${repo}</strong> @ <code>${sha.slice(0,7)}</code></div>
          <div class="muted">by ${author} • ${fmtKST(when)}</div>
          <h4>Message</h4>
          <pre>${msg.replace(/[<>&]/g,s=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]))}</pre>
          <h4>Files</h4>
          <pre>${files || '(no files)'}</pre>
        `;
      }catch(e){
        detailEl.textContent = '상세 조회 실패';
      }
    }

    // ----- Initial render from RAW_LOGS -----
    // 초기엔 repo 칩만 그려져 있고, 사용자가 클릭 시 해당 repo 로딩
    // 혹은 최근에 가장 많이 등장한 repo 자동 선택
    if (USER_REPOS && USER_REPOS.length){
      currentRepo = USER_REPOS[0];
      // 첫 칩 활성화
      const firstChip = document.querySelector('.chip');
      if(firstChip){ firstChip.classList.add('active'); }
      loadLogs(currentRepo);
    }

    // ----- Auto refresh (keep open & selection) -----
    setInterval(async ()=>{
      if(!currentRepo) return;
      const prevOpen = new Set(openBranches);
      const prevSel = {...selectedCommit};
      await loadLogs(currentRepo);
      openBranches.clear(); prevOpen.forEach(k=>openBranches.add(k));
      if(prevSel.repo && prevSel.sha){
        // detail은 다시 열어줌
        showCommitDetail(prevSel.repo, prevSel.sha);
      }
    }, 60*1000);

    // ----- Splitters (정방향) -----
    function bindSplitter(handleId, leftPane, rightPane){
      const handle = document.getElementById(handleId);
      let startX, startLeftW, startRightW;
      handle.addEventListener('mousedown', (e)=>{
        startX = e.clientX;
        const l = document.getElementById(leftPane);
        const r = document.getElementById(rightPane);
        startLeftW = l.getBoundingClientRect().width;
        startRightW = r.getBoundingClientRect().width;

        function move(ev){
          const dx = ev.clientX - startX;
          l.style.width = (startLeftW + dx) + 'px';
          r.style.width = (startRightW - dx) + 'px';
        }
        function up(){
          window.removeEventListener('mousemove', move);
          window.removeEventListener('mouseup', up);
        }
        window.addEventListener('mousemove', move);
        window.addEventListener('mouseup', up);
      });
    }
    bindSplitter('split1','reposPane','daysPane');
    bindSplitter('split2','daysPane','detailPane');

    // ----- Buttons -----
    qs('#btnSync').addEventListener('click', ()=>{ window.location.href = "{{ url_for('sync_my_repos') }}"; });
  </script>
</body>
</html>

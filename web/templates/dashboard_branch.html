<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>대시보드</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* --- 기본 환경 및 색상 재설정 --- */
    :root{
      --bg: #f9fafb; /* 완전 흰색보다 눈이 편한 아주 옅은 회색 */
      --panel: #ffffff;
      --border: #e5e7eb;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --text-main: #111827;
      --text-muted: #6b7280;
      --text-accent: #3b82f6;
      --panel-hover: #f9fafb;
      --vh: 100vh;
    }
    *{box-sizing:border-box}

    /* --- 폰트 및 기본 스타일 개선 --- */
    html,body{
      margin:0; padding:0; height:100%;
      background:var(--bg); color:var(--text-main);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      font-size: 15px; /* 기본 폰트 크기 증가 */
      line-height: 1.5;
    }
    a{color:var(--text-accent); text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1400px; margin:0 auto; padding:24px}
    .monospace{font-family: ui-monospace,"Fira Code",Consolas,Menlo,monospace;}

    /* --- 툴바 및 버튼 스타일 개선 --- */
    .toolbar{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:20px}
    .toolbar-left{display:flex; gap:8px; align-items:center; flex:1 1 480px}
    .toolbar-right{display:flex; gap:8px; align-items:center}
    .input{
      width:100%; padding:10px 14px; border:1px solid var(--border); background:var(--panel); color:var(--text-main);
      border-radius:8px; outline:none; font-size:15px;
      box-shadow: var(--shadow);
    }
    .input:focus{border-color: var(--text-accent); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);}
    button{
      padding:8px 16px; border:1px solid var(--border); border-radius:8px; background:var(--panel);
      font-size: 14px; font-weight:500; cursor:pointer;
      box-shadow: var(--shadow); transition: background-color 0.2s;
    }
    button:hover{background-color: #f3f4f6;}

    /* --- 3열 레이아웃 및 카드 스타일 개선 --- */
    .row{
      display:grid; grid-template-columns:minmax(360px, 1.2fr) 2fr minmax(420px, 1.5fr); gap:20px;
      height:calc(var(--vh) - 100px); min-height:500px;
    }
    .card{
      display:flex; flex-direction:column; border:1px solid var(--border);
      border-radius:12px; background:var(--panel); min-height:0;
      box-shadow: var(--shadow);
    }
    .card h2{
      margin:0; padding:12px 20px; border-bottom:1px solid var(--border);
      font-size:16px; font-weight:600;
    }
    .body{padding:12px; overflow:auto; min-height:0; display:flex; flex-direction:column; gap:8px}
    .stamp{padding:0 8px 8px 8px; font-size:12px; color:var(--text-muted)}

    /* --- 목록 스타일 개선 (리포지토리, 브랜치 등) --- */
    .repo-item{
      display:flex; align-items:center; gap:12px; justify-content:space-between;
      padding:12px 14px; border:none; border-radius:8px;
      background:transparent; cursor:pointer; overflow:hidden; width:100%; text-align:left;
      transition: background-color 0.2s;
    }
    .repo-item:hover{background-color: var(--panel-hover);}
    .repo-name{font-weight:500; flex:1 1 auto; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .repo-meta{font-size:13px; color:var(--text-muted); flex:0 0 140px; text-align:right; white-space:nowrap;}

    /* --- 브랜치/커밋 카드 스타일 --- */
    .branch{border:1px solid var(--border); border-radius:10px; overflow:hidden;}
    .branch-head{
      display:flex; gap:12px; align-items:center; background:var(--panel-hover);
      padding:10px 16px; font-size:16px;
    }
    .branch-head b{flex-grow:1;}
    .sha-tag{
      border:1px solid var(--border); border-radius:999px; padding:2px 8px;
      font-size:12px; color:var(--text-muted); background: var(--panel);
    }
    .panel{padding:8px; overflow:auto}
    .commit{
      display:grid; grid-template-columns:1fr auto; gap:12px;
      border:none; border-radius:8px; padding:10px 12px; margin-bottom:4px; cursor:pointer;
      transition: background-color 0.2s;
    }
    .commit:hover{background:var(--panel-hover)}
    .commit .sha{color:var(--text-muted); font-size:13px;}

    /* --- 커밋 상세 정보 스타일 개선 --- */
    .detail{display:flex; flex-direction:column; gap:16px; padding:8px;}
    .field{border:1px solid var(--border); border-radius:10px; overflow:hidden}
    .field h3{
      margin:0; padding:8px 14px; background:var(--panel-hover);
      font-size:13px; font-weight:600; color:var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.5px;
    }
    .field .val{padding:12px 14px; font-size:15px;}
    .plus{color:#16a34a}.minus{color:#dc2626}
    .field .val a{font-weight:500;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <div class="toolbar-left">
        <input id="repoFilter" class="input" placeholder="리포지토리 검색 (owner/name)..." />
      </div>
      <div class="toolbar-right">
        <button id="btnSync">새로고침</button>
        <a href="{{ url_for('logout') }}"><button type="button">로그아웃</button></a>
        <span>로그인 사용자: <b id="userId">{{ user_id }}</b></span>
      </div>
    </div>

    <div class="row">
      <section class="card">
        <h2>나의 리포지토리</h2>
        <div class="body">
          <div id="repoList"></div>
        </div>
        <div id="repoStamp" class="stamp"></div>
      </section>

      <section class="card">
        <h2>브랜치 & 커밋</h2>
        <div class="body" id="midBody">
          <div id="branches">리포를 선택하세요.</div>
        </div>
        <div id="branchStamp" class="stamp"></div>
      </section>

      <section class="card">
        <h2>커밋 상세</h2>
        <div class="body">
          <div id="detail" class="detail">
            <div class="field"><h3>안내</h3><div class="val">왼쪽 커밋을 선택하세요.</div></div>
          </div>
        </div>
        <div id="detailStamp" class="stamp"></div>
      </section>
    </div>
  </div>

  <script>
  (()=>{ /* 스크립트는 변경 없음 */
    const $ = (s,el=document)=>el.querySelector(s);
    const $$= (s,el=document)=>Array.from(el.querySelectorAll(s));
    const setVH = ()=>document.documentElement.style.setProperty('--vh', window.innerHeight + 'px');
    window.addEventListener('resize', setVH); setVH();
    function sizePanelToBottom(panel){
      const midBody = $('#midBody'); if(!midBody) return;
      const bodyRect = midBody.getBoundingClientRect();
      const pRect    = panel.getBoundingClientRect();
      const h = Math.max(80, Math.floor(bodyRect.bottom - pRect.top - 10));
      panel.style.maxHeight = h + 'px';
    }
    function syncAllPanels(){ $$('.panel').forEach(sizePanelToBottom); }
    window.addEventListener('resize', syncAllPanels);
    window.__syncCommitPanelHeights = syncAllPanels;
    const S = { repos:[], repo:null, branches:{}, opened:new Set(), selCommit:null };
    const repoList = $('#repoList'), repoStamp=$('#repoStamp');
    const branchesBox = $('#branches'), branchStamp=$('#branchStamp');
    const detailBox = $('#detail'), detailStamp=$('#detailStamp');
    const filter = $('#repoFilter'); $('#btnSync').addEventListener('click', refreshAll);
    filter.addEventListener('input', renderRepos);
    document.addEventListener('DOMContentLoaded', init);
    async function init(){
      await loadRepos(); stampAll();
      const obs = new MutationObserver(syncAllPanels);
      obs.observe($('#midBody'), {childList:true, subtree:true});
      setInterval(refreshAll, 60000);
    }
    function stamp(el){ const now=new Date().toLocaleString('ko-KR',{hour12:false,timeZone:'Asia/Seoul'}); el.textContent=`마지막 새로 고침: ${now} (KST)`; }
    function stampAll(){ [repoStamp,branchStamp,detailStamp].forEach(x=>x&&stamp(x)); }
    async function api(path, params={}){
      const qs = new URLSearchParams(params); const url = path + (qs.toString()?`?${qs}`:'');
      const r = await fetch(url); if(!r.ok){ if(r.status===401) location.href="{{ url_for('index') }}"; throw new Error(r.statusText); }
      return r.json();
    }
    async function loadRepos(){ const d=await api('/api/my_repos'); S.repos=d.repos||[]; renderRepos(); stamp(repoStamp); }
    function renderRepos(){
      const q=(filter.value||'').toLowerCase(); const frag=document.createDocumentFragment();
      (S.repos||[])
        .filter(r=>(r.full_name||'').toLowerCase().includes(q))
        .forEach(r=>{
          const b=document.createElement('button'); b.className='repo-item';
          b.innerHTML=`<span class="repo-name">${esc(r.full_name||r.name)}</span><span class="repo-meta">${r.pushed_at?('pushed '+ago(new Date(r.pushed_at))):''}</span>`;
          b.onclick=()=>selectRepo(r.full_name); frag.appendChild(b);
        });
      repoList.replaceChildren(frag);
    }
    async function selectRepo(repo){
      S.repo=repo; branchesBox.textContent='브랜치 불러오는 중...';
      const d=await api('/api/branches',{repo});
      S.branches[repo] = sortBranchesMainFirst(d.branches || []);
      renderBranches(); stamp(branchStamp);
      requestAnimationFrame(syncAllPanels);
    }
    function sortBranchesMainFirst(list){
      const copy=[...(list||[])];
      copy.sort((a,b)=>{
        const an=(a.name||''), bn=(b.name||'');
        if(an==='main') return -1;
        if(bn==='main') return  1;
        return an.localeCompare(bn, undefined, {sensitivity:'base'});
      });
      return copy;
    }
    function renderBranches(){
      const repo=S.repo; const list=S.branches[repo]||[];
      if(!list.length){ branchesBox.textContent='브랜치가 없습니다.'; return; }
      const frag=document.createDocumentFragment();
      list.forEach(b=>{
        const key=`${repo}|${b.name}`; const open=S.opened.has(key);
        const wrap=document.createElement('div'); wrap.className='branch';
        wrap.innerHTML=`
          <div class="branch-head">
            <b class="monospace">${esc(b.name)}</b>
            <span class="sha-tag monospace">${(b.sha||'').slice(0,7)}</span>
            <button type="button">${open?'닫기':'열기'}</button>
          </div>
          <div class="panel" ${open?'':'style="display:none"'}></div>`;
        const btn = wrap.querySelector('button');
        const panel = wrap.querySelector('.panel');
        btn.addEventListener('click', async ()=>{
          if (panel.style.display==='none'){
            S.opened.add(key); btn.textContent='닫기'; panel.style.display='';
            await loadCommits(repo,b.name,panel);
          } else {
            S.opened.delete(key); btn.textContent='열기'; panel.style.display='none';
          }
          requestAnimationFrame(()=>sizePanelToBottom(panel));
        });
        if (open) loadCommits(repo,b.name,panel).then(()=>sizePanelToBottom(panel)).catch(()=>{});
        frag.appendChild(wrap);
      });
      branchesBox.replaceChildren(frag);
    }
    async function loadCommits(repo, branch, panel){
      panel.textContent='커밋 불러오는 중...';
      const d=await api('/api/commits',{repo,branch}); const items=d.commits||[];
      const frag=document.createDocumentFragment();
      items.forEach(c=>{
        const row=document.createElement('div'); row.className='commit';
        row.innerHTML=`<div><div>${esc(c.message||'(no message)')}</div><div class="repo-meta">${esc(c.author||'')} · ${c.date?ago(new Date(c.date)):''}</div></div><div class="sha monospace">${(c.sha||'').slice(0,7)}</div>`;
        row.onclick=()=>showCommit(repo,c.sha);
        frag.appendChild(row);
      });
      panel.replaceChildren(frag);
      requestAnimationFrame(()=>sizePanelToBottom(panel));
    }
    async function showCommit(repo, sha){
      S.selCommit={repo,sha};
      detailBox.innerHTML='<div class="field"><h3>로딩</h3><div class="val">상세 불러오는 중...</div></div>';
      const d=await api('/api/commit_detail',{repo,sha});
      const files=(d.files||[]).slice(0,50).map(f=>{
        const diff=(f.additions||0)-(f.deletions||0);
        const s = diff>=0?`<span class="plus">+${diff}</span>`:`<span class="minus">${diff}</span>`;
        return `<div class="field"><h3>${esc(f.filename)}</h3><div class="val monospace">${esc(f.status||'')} · +${f.additions||0} / -${f.deletions||0} (${s})</div></div>`;
      }).join('');
      detailBox.innerHTML = `
        <div class="field"><h3>제목</h3><div class="val">${esc((d.message||'').split('\n')[0])}</div></div>
        <div class="field"><h3>작성자</h3><div class="val">${esc(d.author||'')}</div></div>
        <div class="field"><h3>날짜(KST)</h3><div class="val">${d.date?new Date(d.date).toLocaleString('ko-KR',{hour12:false,timeZone:'Asia/Seoul'}):''}</div></div>
        <div class="field"><h3>SHA</h3><div class="val monospace">${esc(d.sha||'')}</div></div>
        <div class="field"><h3>변경</h3><div class="val">총 ${d.stats?.total??0} (<span class="plus">+${d.stats?.additions??0}</span> / <span class="minus">-${d.stats?.deletions??0}</span>)</div></div>
        <div class="field"><h3>GitHub에서 보기</h3><div class="val"><a href="${d.html_url}" target="_blank" rel="noopener">열기</a></div></div>
        <div class="field"><h3>Files (상위)</h3><div class="val">${files || '없음'}</div></div>`;
      stamp(detailStamp);
    }
    async function refreshAll(){
      await loadRepos();
      if (S.repo){
        const d=await api('/api/branches',{repo:S.repo});
        S.branches[S.repo]=sortBranchesMainFirst(d.branches||[]);
        renderBranches();
        for (const key of [...S.opened]) {
          const [repo,branch]=key.split('|');
          const card=[...$$('.branch')].find(x=>x.querySelector('.branch-head b')?.textContent===branch);
          if(card){ const panel=card.querySelector('.panel'); await loadCommits(repo,branch,panel); }
        }
      }
      if (S.selCommit){ await showCommit(S.selCommit.repo, S.selCommit.sha); }
      stampAll(); requestAnimationFrame(syncAllPanels);
    }
    function esc(s){return (s||'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m]));}
    function ago(d){const s=Math.floor((Date.now()-d.getTime())/1000); if(s<5)return'방금'; const u=[['일',86400],['시간',3600],['분',60]]; for(const[k,t]of u){const v=Math.floor(s/t); if(v>=1)return`${v}${k} 전`;} return`${s}초 전`; }
  })();
  </script>
</body>
</html>
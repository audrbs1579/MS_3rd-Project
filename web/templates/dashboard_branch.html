<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>대시보드 – Branch Activity (CLI)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Optional mono font (falls back to system monospace if unavailable) -->
  <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* ===== CLI Theme ===== */
    :root{
      --bg:#2a0a2a;              /* deep burgundy */
      --panel:#2f0d2f;           /* slightly brighter panel */
      --panel-2:#351235;         /* headers / strip */
      --fg:#f2e9f3;              /* main text */
      --muted:#c8b8cc;           /* secondary text */
      --accent:#ffd166;          /* links / highlight */
      --good:#18c36e;
      --bad:#ff5a5f;
      --border:#8a4f8a;
      --shadow:0 2px 16px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{
      margin:0;padding:0;background:var(--bg);color:var(--fg);
      font-family:"Fira Code","Cascadia Mono","Consolas",monospace;
      font-size:14px; line-height:1.4;
      height:100%;
    }

    .wrap{max-width:1280px;margin:0 auto;padding:16px}
    .toolbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:10px}
    .toolbar-left{display:flex;gap:8px;align-items:center;max-width:420px;width:100%}
    input[type="text"]{
      width:100%; padding:10px 12px; border-radius:8px;
      background:transparent; color:var(--fg); border:1px solid var(--border);
      outline:none;
    }
    .btn{padding:10px 14px;border:1px solid var(--border);background:var(--panel-2);color:var(--fg);
      border-radius:8px; cursor:pointer; font-weight:600}
    .btn:hover{filter:brightness(1.1)}

    /* ===== 3-column layout with synchronized heights ===== */
    .row{
      display:grid;
      grid-template-columns: 360px 1fr 420px;
      gap:16px;
      align-items:stretch;
      /* Full viewport height minus toolbar & outer paddings */
      height: calc(100vh - 16px - 10px - 16px);
      /* top/btm paddings: wrap(16) + toolbar-margin(10) */
    }

    .card{
      display:flex; flex-direction:column;
      background:var(--panel); border:1px solid var(--border); border-radius:10px;
      box-shadow:var(--shadow); min-height:0; /* allow children to shrink */
    }
    .card h2{
      margin:0; padding:10px 12px; background:var(--panel-2); border-bottom:1px solid var(--border);
      font-size:14px; font-weight:600;
    }
    .card-inner{padding:10px 12px; overflow:auto; min-height:0; flex:1}
    .stamp{color:var(--muted); font-size:12px; margin-bottom:8px}

    /* ===== Left: Repo list ===== */
    .repo-item{
      display:flex; justify-content:space-between; align-items:center; gap:8px;
      width:100%; text-align:left; padding:8px 10px; margin-bottom:8px;
      border:1px solid var(--border); border-radius:8px; background:transparent; color:var(--fg);
      cursor:pointer;
    }
    .repo-item:hover{background:#3b123b}
    .repo-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:230px}
    .repo-meta{color:var(--muted);font-size:12px}

    /* ===== Middle: Branch cards & commits ===== */
    .branch-card{border:1px solid var(--border); border-radius:10px; overflow:hidden; margin-bottom:12px}
    .branch-head{
      display:grid; grid-template-columns: 1fr auto auto; gap:8px; align-items:center;
      padding:8px 10px; background:#300e30; border-bottom:1px solid var(--border);
    }
    .branch-title{display:flex; align-items:center; gap:8px}
    .branch-title .name{font-weight:600}
    .tag{border:1px solid var(--border); border-radius:999px; padding:1px 8px; font-size:12px; color:var(--muted)}

    /* Scrollable commit list INSIDE each branch, height sync to center column */
    .commit-panel{
      padding:8px 10px;
      max-height: 38vh;           /* default when multiple branches open */
      overflow:auto;
    }
    /* when the branch is the only open one, we can allow more height dynamically via JS if needed */

    .commit-item{
      display:grid; grid-template-columns: 1fr auto; gap:8px;
      border:1px solid var(--border); border-radius:8px; padding:8px; margin-bottom:8px;
      cursor:pointer;
    }
    .commit-item:hover{background:#3b123b}
    .sha{font-family:inherit; color:var(--muted)}

    /* ===== Right: Commit detail with parent/child grid ===== */
    .detail-grid{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap:8px;
    }
    .kv{
      display:contents;  /* dt, dd take grid cells */
    }
    .kv dt{
      padding:6px 8px; border:1px solid var(--border); border-radius:8px;
      background:#300e30; color:var(--muted); /* parent cell */
    }
    .kv dd{
      margin:0;
      padding:6px 8px; border:1px solid var(--border); border-radius:8px;
      background:#2c0d2c; /* child cell */
    }
    .diff-line{white-space:nowrap}
    .plus{color:var(--good)} .minus{color:var(--bad)}
    .only-link a{color:var(--accent); text-decoration:none}

    /* make right panel scroll within card */
    #detail { overflow:auto; min-height:0 }

    /* unify font sizes in right pane */
    #detail, #detail *{ font-size:14px; line-height:1.4 }

    /* Links */
    a{color:var(--accent)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <div class="toolbar-left">
        <input id="repoFilter" type="text" placeholder="리포지토리 검색 (owner/name)...">
        <button id="btnSync" class="btn">새로고침</button>
      </div>
      <div style="color:var(--muted)">로그인 사용자: <span id="userId">{{ user_id }}</span></div>
    </div>

    <div class="row">
      <!-- Left -->
      <section class="card">
        <h2>나의 리포지토리</h2>
        <div class="card-inner">
          <div id="repoStamp" class="stamp"></div>
          <div id="repoList"></div>
        </div>
      </section>

      <!-- Middle -->
      <section class="card">
        <h2>브랜치 & 커밋</h2>
        <div class="card-inner">
          <div id="branchStamp" class="stamp"></div>
          <div id="dayBranch">리포를 선택하세요.</div>
        </div>
      </section>

      <!-- Right -->
      <section class="card">
        <h2>커밋 상세</h2>
        <div class="card-inner">
          <div id="detailStamp" class="stamp"></div>
          <div id="detail">
            <div class="detail-grid">
              <!-- JS will replace this content -->
              <dl class="kv"><dt>안내</dt><dd>왼쪽에서 커밋을 선택하세요.</dd></dl>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // small helper qsa missing in some earlier versions
    const qsa = (s, el = document) => Array.from(el.querySelectorAll(s));
    const qs  = (s, el = document) => el.querySelector(s);

    // OPTIONAL: auto-limit commit panel height to match the middle column space
    // so each opened branch's commit list scrolls within its box.
    function syncCommitPanelHeights(){
      const middleCardInner = document.querySelectorAll('.card-inner')[1];
      if(!middleCardInner) return;
      const totalH = middleCardInner.clientHeight;
      // When multiple branches open, each panel keeps max-height; this keeps it responsive.
      qsa('.commit-panel').forEach(p => {
        // If a single branch is open (heuristic: only one .commit-panel), give it more room
        if(qsa('.commit-panel').length === 1){
          p.style.maxHeight = Math.max(160, Math.floor(totalH * 0.82)) + 'px';
        }else{
          p.style.maxHeight = Math.max(120, Math.floor(totalH * 0.38)) + 'px';
        }
      });
    }
    window.addEventListener('resize', syncCommitPanelHeights);
    // expose for your existing script to call after it renders branches
    window.__syncCommitPanelHeights = syncCommitPanelHeights;
  </script>

  <!-- NOTE:
       Keep your original dashboard script inclusion below.
       It should populate #repoList, #dayBranch (branch cards -> .commit-panel inside), and #detail.
       After (re)rendering branches, call window.__syncCommitPanelHeights?.()
  -->
</body>
</html>

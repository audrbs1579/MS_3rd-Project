<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>Branch Activity – {{ user_id }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* XP 느낌의 기본 폰트 */
    html,body{font-family:Tahoma, Arial, sans-serif;margin:0;padding:0}
    header,footer{padding:8px 12px;border-bottom:1px solid #ddd;display:flex;gap:8px;align-items:center;justify-content:space-between}
    main{display:grid;grid-template-columns:320px 1fr 1fr;gap:12px;padding:12px}
    .col{border-left:1px solid #e5e5e5;padding:8px}
    .col:first-child{border-left:none}
    h2{margin:0 0 8px 0;font-size:16px}
    input[type=text]{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px}
    .btn{padding:8px 12px;border:1px solid #333;border-radius:4px;background:#fff;cursor:pointer}
    .btn:hover{background:#f6f6f6}
    .tag{display:inline-block;padding:2px 8px;border:1px solid #ccc;border-radius:999px;font-size:12px;margin-left:6px}
    .repo-chip{display:inline-block;margin:4px 6px 0 0;padding:6px 10px;border:1px solid #ddd;border-radius:12px;cursor:pointer}
    .repo-chip:hover{background:#f7f7f7}

    .date-head{margin:12px 0 8px 0;padding:10px 12px;border-radius:6px;background:rgb(255,149,0);color:#fff;display:flex;align-items:center;justify-content:space-between}
    .branch-row{padding:8px 4px;border-bottom:1px solid #eee}
    .commit-panel{border:1px dashed #ccc;border-radius:6px;padding:10px;max-height:360px;overflow:auto}
    .commit-item{display:flex;align-items:center;justify-content:space-between;border:1px solid #eee;border-radius:8px;padding:10px;margin:6px 0}
    .sha{font-family:ui-monospace, Consolas, monospace;font-size:12px;border:1px solid #ddd;border-radius:999px;padding:2px 8px}
    .green-dot{display:inline-block;width:10px;height:10px;border-radius:50%;background:#28a745;margin-right:6px}
    .muted{color:#666;font-size:12px}
    .detail{white-space:pre-wrap}
  </style>
</head>
<body>
<header>
  <div><strong>Branch Activity – {{ user_id }}</strong> <span class="muted">KST로 표시 / 클릭 시에만 조회</span></div>
  <div>
    <button id="btnSync" class="btn">동기화(로그인 유지)</button>
    <a class="btn" href="{{ url_for('logout') }}">Logout</a>
  </div>
</header>

<main>
  <!-- Repositories -->
  <section class="col">
    <h2>Repositories</h2>
    <input id="repoFilter" type="text" placeholder="owner/repo 필터">
    <div id="repoList" style="margin-top:8px"></div>
  </section>

  <!-- Days & Branches -->
  <section class="col">
    <h2>Days & Branches</h2>
    <div id="dayBranch"></div>
  </section>

  <!-- Commit Detail -->
  <section class="col">
    <h2>Commit Detail</h2>
    <div id="detail">왼쪽에서 커밋을 선택하세요.</div>
  </section>
</main>

<footer>
  <span class="muted">© dashboard</span>
</footer>

<script>
  const USER_ID = "{{ user_id }}";

  // -------------- DOM 헬퍼 --------------
  const qs = (s, el=document)=>el.querySelector(s);
  const qsa = (s, el=document)=>Array.from(el.querySelectorAll(s));
  const elRepoList = qs('#repoList');
  const elDayBranch = qs('#dayBranch');
  const elDetail = qs('#detail');
  const elRepoFilter = qs('#repoFilter');

  // -------------- 상태 --------------
  let allRepos = [];        // API로 가져온 전체 repo
  let selectedRepo = null;  // "owner/repo"
  let branchesCache = {};   // { repo : [ {name, sha}, ... ] }
  let commitsCache = {};    // { repo|branch : [ commits ] }

  // -------------- 초기화 --------------
  document.addEventListener('DOMContentLoaded', async () => {
    await loadRepos();
    wireEvents();
  });

  function wireEvents() {
    elRepoFilter.addEventListener('input', renderRepos);
    qs('#btnSync').addEventListener('click', async ()=>{
      // 단순히 repo 재조회만 수행 (GitHub API 호출)
      await loadRepos(true);
    });
  }

  // -------------- API 호출 --------------
  async function apiGet(url, params={}) {
    const q = new URLSearchParams(params);
    const res = await fetch(url + (q.toString() ? `?${q}` : ''));
    if (!res.ok) {
      let err = await res.text();
      throw new Error(err || res.statusText);
    }
    return res.json();
  }

  async function loadRepos(force=false) {
    const data = await apiGet('/api/my_repos');
    allRepos = data.repos || [];
    // 이름만 보여달라 했으므로 chip에는 repo.name 만 표시, 클릭 시 full_name 사용
    renderRepos();
    if (force) {
      // 캐시 초기화
      branchesCache = {};
      commitsCache = {};
      elDayBranch.innerHTML = '';
      elDetail.textContent = '왼쪽에서 커밋을 선택하세요.';
    }
  }

  function renderRepos() {
    const f = (elRepoFilter.value || '').toLowerCase();
    elRepoList.innerHTML = '';
    allRepos
      .filter(r => (r.full_name||'').toLowerCase().includes(f))
      .forEach(r => {
        const chip = document.createElement('button');
        chip.className = 'repo-chip';
        chip.textContent = r.name || r.full_name;
        chip.title = r.full_name;
        chip.onclick = ()=>selectRepo(r.full_name);
        elRepoList.appendChild(chip);
      });
  }

  async function selectRepo(full_name) {
    selectedRepo = full_name;
    elDayBranch.innerHTML = '브랜치 불러오는 중...';

    if (!branchesCache[full_name]) {
      const data = await apiGet('/api/branches', {repo: full_name});
      branchesCache[full_name] = data.branches || [];
    }
    const branches = branchesCache[full_name];

    // 브랜치 목록을 간단히 렌더. 각 브랜치를 클릭하면 해당 커밋을 '지금' 조회.
    const wrap = document.createElement('div');
    if (!branches.length) {
      wrap.textContent = '브랜치 없음';
      elDayBranch.replaceChildren(wrap);
      return;
    }

    branches.forEach(b => {
      const row = document.createElement('div');
      row.className = 'branch-row';

      const head = document.createElement('div');
      head.style.display = 'flex';
      head.style.alignItems = 'center';
      head.style.justifyContent = 'space-between';
      head.innerHTML = `
        <div>
          <strong>${b.name}</strong>
          <span class="tag">C ?</span>
        </div>
        <button class="btn">열기</button>
      `;

      const panel = document.createElement('div');
      panel.className = 'commit-panel';
      panel.style.display = 'none';
      panel.textContent = '커밋을 불러오려면 "열기"를 누르세요.';

      head.querySelector('.btn').onclick = async () => {
        // 버튼 토글
        const opened = panel.style.display !== 'none';
        if (opened) {
          panel.style.display = 'none';
          head.querySelector('.btn').textContent = '열기';
          return;
        }
        head.querySelector('.btn').textContent = '닫기';
        panel.style.display = 'block';
        await loadCommitsForBranch(full_name, b.name, panel, head);
      };

      row.appendChild(head);
      row.appendChild(panel);
      wrap.appendChild(row);
    });

    elDayBranch.replaceChildren(wrap);
  }

  async function loadCommitsForBranch(repo, branch, panel, headEl) {
    panel.innerHTML = '조회 중...';

    const key = `${repo}|${branch}`;
    if (!commitsCache[key]) {
      // since는 선택 안하면 전체(페이지 제한 내). 필요 시 UI 만들어서 기간 지정 가능
      const data = await apiGet('/api/commits', {repo, branch});
      commitsCache[key] = data.commits || [];
    }
    const commits = commitsCache[key];

    // 헤더의 C 배지 갱신
    const tag = headEl.querySelector('.tag');
    tag.textContent = `C ${commits.length}`;

    if (!commits.length) {
      panel.textContent = '커밋 없음';
      return;
    }

    // 최신순으로 표시, 3분 이내 커밋엔 초록 체크
    panel.innerHTML = '';
    const now = Date.now();
    commits.forEach(c => {
      const item = document.createElement('div');
      item.className = 'commit-item';

      const isFresh = (() => {
        if (!c.date) return false;
        const d = new Date(c.date).getTime();
        return (now - d) <= 3 * 60 * 1000; // 3분
      })();

      const left = document.createElement('div');
      left.style.display = 'flex';
      left.style.alignItems = 'center';
      left.style.gap = '6px';
      left.innerHTML = `
        ${isFresh ? '<span class="green-dot" title="3분 이내"></span>' : ''}
        <span>${escapeHtml(c.message || '(no message)')}</span>
      `;

      const right = document.createElement('div');
      right.innerHTML = `<span class="sha">${(c.sha || '').slice(0,7)}</span>`;

      item.appendChild(left);
      item.appendChild(right);

      item.onclick = ()=>showCommitDetail(repo, c.sha);
      panel.appendChild(item);
    });
  }

  async function showCommitDetail(repo, sha) {
    elDetail.textContent = '상세 조회 중...';
    const d = await apiGet('/api/commit_detail', {repo, sha});

    // KST로 변환 표기
    let kst = '';
    if (d.date) {
      kst = new Date(d.date).toLocaleString("ko-KR", {
        timeZone: "Asia/Seoul",
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit"
      });
    }

    const files = d.files || [];
    const stats = d.stats || {};

    const html = `
      <div class="detail">
        <div><strong>${escapeHtml(d.message || '')}</strong></div>
        <div class="muted" style="margin:6px 0">${escapeHtml(d.author||'')} • ${kst}</div>
        <div style="margin:6px 0">SHA: <code>${d.sha}</code> · <a href="${d.html_url}" target="_blank">GitHub에서 보기</a></div>
        <div style="margin:6px 0">총 변경: ${stats.total ?? 0} (+${stats.additions ?? 0} / -${stats.deletions ?? 0})</div>
        <hr>
        <div><strong>Files</strong></div>
        <ul>
          ${files.map(f => `
            <li>${escapeHtml(f.filename)} — ${f.status} (+${f.additions} / -${f.deletions})</li>
          `).join("")}
        </ul>
      </div>
    `;
    elDetail.innerHTML = html;
  }

  function escapeHtml(s){
    return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
</script>
</body>
</html>

<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
  <style>
    /* --- NEW LAYOUT STYLES --- */
    .main-container {
      display: grid;
      grid-template-columns: minmax(300px, 1.2fr) minmax(250px, 1fr) minmax(300px, 1.5fr);
      gap: 16px;
      height: 65vh; /* 뷰포트 높이에 기반한 높이 설정 */
      margin-bottom: 16px;
    }
    .column {
      display: flex;
      flex-direction: column;
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      overflow: hidden; /* 내부 컨텐츠가 넘치면 스크롤되도록 */
    }
    .column h2 {
      font-size: 1rem;
      padding: 12px 16px;
      margin: 0;
      border-bottom: 1px solid #e5e7eb;
      flex-shrink: 0;
    }
    .column .body {
      padding: 8px;
      overflow-y: auto;
      flex-grow: 1;
    }
    .column .empty-state {
      padding: 16px;
      color: #6b7280;
    }
    .detail-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    /* --- List Item Styles --- */
    .list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-radius: 6px;
      cursor: pointer;
      border: 1px solid transparent;
      transition: background-color 0.2s, border-color 0.2s;
    }
    .list-item:hover {
      background-color: #f9fafb;
    }
    .list-item.selected {
      background-color: #eef2ff;
      border-color: #c7d2fe;
      font-weight: 600;
    }
    .repo-meta, .branch-meta, .commit-meta {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .commit-info { flex-grow: 1; }
    .commit-message { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .commit-author { font-size: 0.8rem; color: #6b7280; margin-top: 2px; }
    .commit-sha { font-family: monospace; font-size: 0.85rem; }

    /* --- Security Summary Card Styles --- */
    #security-summary-card { transition: all 0.3s; }

    /* 기존 commit, indicator 스타일은 유지 또는 약간 수정 */
    .commit-indicators { display: flex; gap: 5px; padding: 0 8px; }
    .indicator {
      width: 10px; height: 10px; border-radius: 50%;
      background-color: #e5e7eb; transition: background-color 0.3s;
      box-shadow: inset 0 0 2px rgba(0,0,0,0.1);
    }
    .indicator.status-good { background-color: #22c55e; }
    .indicator.status-warn { background-color: #f59e0b; }
    .indicator.status-bad { background-color: #ef4444; }
    .indicator.status-unknown { background-color: #9ca3af; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <input id="repoFilter" class="input" placeholder="저장소 검색..." />
      <div class="toolbar-actions">
        <button id="btnVsConfig" type="button">VS Code 경로</button>
        <button id="btnSync" type="button">새로고침</button>
        <span>Signed in as <b>{{ user_id }}</b></span>
        <a href="/logout"><button type="button">로그아웃</button></a>
      </div>
    </div>

    <div class="main-container">
      <div class="column" id="repo-column">
        <h2>내 저장소</h2>
        <div class="body repo-list" id="repoList">
          <div class="empty-state">데이터 로딩 중...</div>
        </div>
        <div id="repoStamp" class="stamp"></div>
      </div>

      <div class="column" id="branch-column">
        <h2>브랜치</h2>
        <div class="body" id="branchList">
          <div class="empty-state">저장소를 선택하세요.</div>
        </div>
      </div>

      <div class="column" id="commit-column">
        <h2>커밋</h2>
        <div class="body" id="commitList">
          <div class="empty-state">브랜치를 선택하세요.</div>
        </div>
      </div>
    </div>

    <div class="detail-container">
      <section id="security-summary-card" class="card status-unknown">
        <div class="security-summary-body">
          <div class="security-status">
            <div id="status-icon-container" class="status-icon"></div>
            <div class="status-text">
              <h3 id="security-summary-title">보안 요약</h3>
              <p id="security-summary-text">분석할 커밋을 선택하세요.</p>
            </div>
          </div>
          <button id="btn-view-details" disabled>상세 보기</button>
        </div>
      </section>

      <section id="detail-view-card" class="card" style="display: none;">
        <h2>커밋 상세 정보</h2>
        <div id="detail-container" class="body detail"></div>
      </section>
    </div>
  </div>

<script>
(()=>{
  const $ = (s, el = document) => el.querySelector(s);
  const $$ = (s, el = document) => el.querySelectorAll(s);

  // --- State Management ---
  const S = {
    repo: null,
    branch: null, // NEW: Selected branch state
    selCommit: null,
    repos: [],
    branches: {},
    commits: {},
    securityByCommit: {},
  };
  
  // --- Constants (ICONS, IDENTITY_LEVELS, etc. - unchanged) ---
  const ICONS = { /* ... 기존 코드와 동일 ... */ };
  const IDENTITY_LEVELS = { /* ... 기존 코드와 동일 ... */ };

  // --- DOM Elements ---
  const repoFilter = $('#repoFilter'), repoListEl = $('#repoList'), repoStamp = $('#repoStamp');
  const branchListEl = $('#branchList'), commitListEl = $('#commitList');
  const detailViewCard = $('#detail-view-card'), detailContainerEl = $('#detail-container');
  const securityCard = $('#security-summary-card'), statusIcon = $('#status-icon-container');
  const summaryTitle = $('#security-summary-title'), summaryText = $('#security-summary-text');
  const btnSync = $('#btnSync'), btnVsConfig = $('#btnVsConfig'), btnDetails = $('#btn-view-details');

  // --- Cache & API (api function is unchanged) ---
  const CACHE_KEY = 'dashboardCache';
  async function api(path, options={}) { /* ... 기존 코드와 동일 ... */ }
  function loadCache() { /* ... 기존 코드와 동일 ... */ }
  
  // --- RENDER FUNCTIONS (Heavily Modified) ---

  function renderRepos() {
    const q = repoFilter.value.toLowerCase();
    const frag = document.createDocumentFragment();
    S.repos
      .filter(r => (r.full_name || '').toLowerCase().includes(q))
      .forEach(r => {
        const el = document.createElement('div');
        el.className = 'list-item repo-item';
        el.dataset.repo = r.full_name;
        el.onclick = () => selectRepo(r.full_name);
        el.innerHTML = `
          <span class="repo-name">${esc(r.full_name)}</span>
          <span class="repo-meta">${r.pushed_at ? ago(new Date(r.pushed_at)) : ''}</span>`;
        frag.appendChild(el);
      });
    repoListEl.innerHTML = '';
    repoListEl.appendChild(frag.children.length ? frag : el('div', 'empty-state', '결과 없음'));
    highlightSelection();
  }

  function renderBranches() {
    const list = S.branches[S.repo] || [];
    if (!list.length) {
      branchListEl.innerHTML = `<div class="empty-state">브랜치가 없습니다.</div>`;
      return;
    }
    const frag = document.createDocumentFragment();
    list.forEach(b => {
      const el = document.createElement('div');
      el.className = 'list-item branch-item';
      el.dataset.branch = b.name;
      el.onclick = () => selectBranch(b.name);
      el.innerHTML = `
        <span class="branch-name">${esc(b.name)}</span>
        <span class="branch-meta">${esc((b.sha || '').slice(0, 7))}</span>`;
      frag.appendChild(el);
    });
    branchListEl.innerHTML = '';
    branchListEl.appendChild(frag);
    highlightSelection();
  }
  
  function renderCommits() {
    const key = `${S.repo}|${S.branch}`;
    const list = S.commits[key] || [];
    if (!list.length) {
      commitListEl.innerHTML = `<div class="empty-state">커밋이 없습니다.</div>`;
      return;
    }
    const frag = document.createDocumentFragment();
    list.forEach(c => {
      const el = document.createElement('div');
      el.className = 'list-item commit-item';
      el.dataset.sha = c.sha;
      el.onclick = () => selectCommit(c.sha);
      el.innerHTML = `
        <div class="commit-info">
            <span class="commit-message">${esc(c.message)}</span>
            <span class="commit-author">${esc(c.author)} · ${ago(c.date)}</span>
        </div>
        <div class="commit-indicators" data-role="indicators">
            <span class="indicator" title="CodeQL"></span><span class="indicator" title="계정"></span><span class="indicator" title="BRICKS"></span>
        </div>
        <span class="commit-sha">${esc(c.sha.slice(0, 7))}</span>`;
      frag.appendChild(el);
      // Fetch status for each commit
      fetchAndRenderCommitStatus(S.repo, S.branch, c.sha);
    });
    commitListEl.innerHTML = '';
    commitListEl.appendChild(frag);
    highlightSelection();
  }
  
  // --- SELECTION & WORKFLOW LOGIC ---

  function selectRepo(repoName) {
    if (S.repo === repoName) return;
    S.repo = repoName;
    S.branch = null;
    S.selCommit = null;

    // Clear subsequent columns and details
    branchListEl.innerHTML = `<div class="empty-state">브랜치 로딩 중...</div>`;
    commitListEl.innerHTML = `<div class="empty-state">브랜치를 선택하세요.</div>`;
    resetDetailView();
    
    renderBranches();
    highlightSelection();
  }
  
  function selectBranch(branchName) {
    if (S.branch === branchName) return;
    S.branch = branchName;
    S.selCommit = null;

    // Clear commit column and details
    commitListEl.innerHTML = `<div class="empty-state">커밋 로딩 중...</div>`;
    resetDetailView();

    renderCommits();
    highlightSelection();
  }

  async function selectCommit(sha) {
    if (S.selCommit?.sha === sha) return;
    S.selCommit = { repo: S.repo, branch: S.branch, sha };

    highlightSelection();
    updateSecuritySummary('loading');
    detailViewCard.style.display = 'block';
    detailContainerEl.innerHTML = '<div class="empty-state">커밋 상세 정보 로딩 중...</div>';
    
    try {
      const security = S.securityByCommit[sha] || await api('/security_status', { query: { repo: S.repo, commit: sha, branch: S.branch } });
      S.securityByCommit[sha] = security;
      
      const details = await api('/commit_detail', { query: { repo: S.repo, sha } });
      
      renderCommitDetails(details); // NEW function to render details in the bottom card
      updateSecuritySummary(security);
      updateCommitIndicators(sha, security);
    } catch (e) {
      console.error('Error fetching commit details:', e);
      detailContainerEl.innerHTML = `<div class="detail-error">상세 정보를 불러오지 못했습니다: ${esc(e.message)}</div>`;
      updateSecuritySummary('unknown');
    }
  }

  // --- DETAIL & STATUS RENDERING ---
  
  function resetDetailView() {
    detailViewCard.style.display = 'none';
    detailContainerEl.innerHTML = '';
    updateSecuritySummary('unknown');
  }
  
  function renderCommitDetails(details) {
    const files = details.files || [];
    const fileList = files.length ? files.map(file => {
      const stats = `+${file.additions} -${file.deletions}`;
      return `<li>${esc(file.filename)} <span class="commit-meta">(${esc(stats)})</span></li>`;
    }).join('') : '<li>변경된 파일 없음</li>';

    detailContainerEl.innerHTML = `
      <h4>${esc(details.message.split('\n')[0])}</h4>
      <p class="commit-meta">${esc(details.author)} · ${ago(details.date)}</p>
      <hr>
      <p><b>변경 파일:</b></p>
      <ul>${fileList}</ul>
    `;
  }
  
  function highlightSelection() {
    $$('.list-item.selected').forEach(el => el.classList.remove('selected'));
    if (S.repo) $(`.repo-item[data-repo="${S.repo}"]`)?.classList.add('selected');
    if (S.branch) $(`.branch-item[data-branch="${S.branch}"]`)?.classList.add('selected');
    if (S.selCommit) $(`.commit-item[data-sha="${S.selCommit.sha}"]`)?.classList.add('selected');
  }
  
  async function fetchAndRenderCommitStatus(repo, branch, sha) {
    if (S.securityByCommit[sha]) {
      updateCommitIndicators(sha, S.securityByCommit[sha]);
      return;
    }
    try {
      const status = await api('/security_status', { query: { repo, commit: sha, branch } });
      S.securityByCommit[sha] = status;
      updateCommitIndicators(sha, status);
    } catch (e) {
      console.error(`Failed to fetch security status for ${sha}`, e);
      const failure = { defender:{status:'unknown'}, sentinel:{status:'unknown'}, bricks:{status:'unknown'} };
      S.securityByCommit[sha] = failure;
      updateCommitIndicators(sha, failure);
    }
  }

  function updateCommitIndicators(sha, status) {
    const commitEl = $(`.commit-item[data-sha="${sha}"]`);
    if (!commitEl) return;
    const indicators = $$('.indicator', commitEl);
    if (indicators.length !== 3) return;
    indicators[0].className = `indicator status-${status?.defender?.status || 'unknown'}`;
    indicators[1].className = `indicator status-${status?.sentinel?.status || 'unknown'}`;
    indicators[2].className = `indicator status-${status?.bricks?.status || 'unknown'}`;
  }

  function updateSecuritySummary(data) {
    // This function remains largely the same as before.
    btnDetails.disabled = true;
    if (data === 'loading' || data === 'unknown' || !data || !data.defender) {
      securityCard.className = 'card status-unknown';
      statusIcon.innerHTML = ICONS?.unknown || '?';
      summaryTitle.textContent = data === 'loading' ? '분석 중...' : '보안 요약';
      summaryText.innerHTML = data === 'loading' ? '잠시만 기다려주세요.' : '분석할 커밋을 선택하세요.';
      return;
    }
    const statuses = [data.defender.status, data.sentinel?.status, data.bricks?.status].filter(Boolean);
    const overall = statuses.includes('bad') ? 'bad' : statuses.includes('warn') ? 'warn' : 'good';
    securityCard.className = `card status-${overall}`;
    statusIcon.innerHTML = ICONS?.[overall] || '?';
    summaryTitle.textContent = { good: '안전', warn: '주의', bad: '위험' }[overall];
    const issues = statuses.filter(s => s === 'bad' || s === 'warn').length;
    summaryText.textContent = issues > 0 ? `${issues}건의 잠재적 이슈 발견` : '모든 점검 통과';
    btnDetails.disabled = false;
  }
  
  // --- HELPERS (unchanged) ---
  function esc(s) { /* ... */ }
  function ago(d) { /* ... */ }
  function el(tag, cls, content) {
    const e = document.createElement(tag);
    if(cls) e.className = cls;
    if(content) e.textContent = content;
    return e;
  }

  // --- Initial Load & Event Listeners ---
  document.addEventListener('DOMContentLoaded', () => {
    if (loadCache()) {
      renderRepos();
    } else {
      window.location.href = '/loading';
    }
  });
  
  repoFilter.addEventListener('input', renderRepos);
  btnSync.addEventListener('click', () => {
    sessionStorage.removeItem(CACHE_KEY);
    window.location.href = '/loading';
  });
  btnDetails.addEventListener('click', () => {
    if (S.selCommit) {
      const { repo, sha, branch } = S.selCommit;
      window.location.href = `/details?repo=${repo}&sha=${sha}&branch=${branch || ''}`;
    }
  });

  // Helper functions like `esc`, `ago`, `ICONS` etc. need to be copied from the old file if they are not here
  const isRecent = (d) => d && (Date.now() - new Date(d).getTime()) < (5 * 60 * 1000);
  /* Paste existing ICONS, IDENTITY_LEVELS, esc, ago, etc. here */
  
})();
</script>
</body>
</html>
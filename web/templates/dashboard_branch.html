<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Project Guardian - Branch Logs</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* ===== 기본(심플) 레이아웃 ===== */
    :root{
      --gap:12px;
      --border:#ccc;
      --muted:#666;
      --badge:#eee;
      --accent:#ff9500; /* Apple system orange */
      --chip:#f5f5f5;
      --ok:#22c55e;
    }
    html,body{height:100%;margin:0;font-family:Tahoma, "MS Sans Serif", "굴림", sans-serif;font-size:14px;color:#111;}
    .app{display:grid;grid-template-columns: 1fr 6px 1.2fr 6px 1.2fr;grid-template-rows: auto 1fr; height:100%;}
    header{grid-column:1 / -1; padding:10px var(--gap); border-bottom:1px solid var(--border); display:flex; align-items:center; gap:10px;}
    header h1{margin:0;font-size:16px;font-weight:bold;}
    .pane{display:flex;flex-direction:column;overflow:hidden;}
    .pane h2{margin:10px var(--gap); font-size:15px;}
    .scroller{flex:1; overflow:auto; padding:0 var(--gap) var(--gap);}

    /* Repos */
    .toolbar{display:flex; gap:8px; align-items:center; padding:0 var(--gap) 10px;}
    .toolbar input{height:30px; padding:0 8px; width:260px;}
    .repo-list{display:flex; flex-wrap:wrap; gap:8px; padding:0 var(--gap) var(--gap);}
    .repo-chip{padding:6px 10px; border:1px solid var(--border); background:var(--chip); cursor:pointer; border-radius:16px; user-select:none;}
    .repo-chip.active{outline:2px solid #000;}

    /* Day group */
    .day-header{margin:12px 0 8px 0; padding:10px 12px; border-radius:6px; background: var(--accent); color:#fff; display:flex; align-items:center; justify-content:space-between;}
    .day-header small{opacity:.9;}
    .group{border:1px solid var(--border); border-radius:6px; padding:10px; margin-bottom:12px;}

    /* Branch row */
    .branch-row{display:flex; align-items:center; gap:10px; margin-bottom:8px;}
    .branch-name{font-weight:bold;}
    .badge{font-size:12px; padding:2px 8px; border:1px solid var(--border); border-radius:12px; background:var(--badge); color:#333;}
    .btn{height:28px; padding:0 10px; cursor:pointer;}
    details{border:1px dashed var(--border); border-radius:6px; padding:8px; background:#fafafa;}
    details[open]{background:#fff;}

    /* Commit list */
    .commit-list{max-height:280px; overflow:auto; display:flex; flex-direction:column; gap:8px;}
    .commit-item{display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border:1px solid var(--border); border-radius:6px; background:#fff;}
    .commit-left{display:flex; align-items:center; gap:10px; min-width:0;}
    .commit-msg{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:56ch;}
    .sha{font-family:Consolas, Menlo, monospace; border:1px solid var(--border); border-radius:12px; padding:2px 8px; background:#f7f7f7;}
    .new-dot{width:10px;height:10px;border-radius:50%;background:var(--ok);border:1px solid #0f7a34;flex:0 0 auto;}

    /* Commit detail pane */
    .kv{display:grid; grid-template-columns: 120px 1fr; gap:6px; margin-bottom:10px;}
    .muted{color:var(--muted);}
    pre{background:#f7f7f7;border:1px solid var(--border); padding:8px; border-radius:6px; overflow:auto;}

    /* Resizer */
    .resizer{background:#e5e5e5; cursor:col-resize;}
    .resizer:hover{background:#dcdcdc;}

    /* 작은 화면 대응 */
    @media (max-width: 1024px){
      .app{grid-template-columns: 1fr; grid-template-rows: auto auto auto auto; }
      .resizer{display:none;}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Branch Activity – {{ user_id }}</h1>
      <span class="muted">KST로 표시 / 1분마다 자동 새로고침</span>
      <span class="muted" id="lastRefresh"></span>
      <div style="flex:1"></div>
      <button class="btn" id="btnSync">동기화</button>
      <a href="{{ url_for('logout') }}"><button class="btn">Logout</button></a>
    </header>

    <!-- Left: Repos -->
    <section class="pane" id="paneRepos">
      <h2>Repositories</h2>
      <div class="toolbar">
        <input id="repoFilter" type="text" placeholder="owner/repo 필터" />
      </div>
      <div class="repo-list" id="repoList"></div>
    </section>

    <div class="resizer" id="resizer1"></div>

    <!-- Middle: Days & Branches -->
    <section class="pane">
      <h2>Days & Branches</h2>
      <div class="scroller" id="daysPane">
        <!-- filled by JS -->
      </div>
    </section>

    <div class="resizer" id="resizer2"></div>

    <!-- Right: Commit Detail -->
    <section class="pane">
      <h2>Commit Detail</h2>
      <div class="scroller" id="detailPane">
        <p class="muted">왼쪽에서 커밋을 선택하세요.</p>
      </div>
    </section>
  </div>

  <script>
    /* ===== 템플릿 데이터 ===== */
    const RAW_LOGS = {{ logs|tojson|safe }};
    const USER_REPOS = {{ repos|tojson|safe }};
    const USER_ID = "{{ user_id }}";

    /* ===== 상태 ===== */
    let currentRepoFull = null;          // 'owner/repo'
    let logsByRepo = {};                 // repo -> [{...}]
    let openGroups = new Set();          // key: `${date}|${branch}`
    let lastRenderTs = Date.now();

    // 초기 변환
    function normalizeLogs(raw){
      const byRepo = {};
      for(const doc of raw){
        const k = doc.repo_full_name;
        if(!byRepo[k]) byRepo[k] = [];
        byRepo[k].push(doc);
      }
      // sort by date desc
      for(const k of Object.keys(byRepo)){
        byRepo[k].sort((a,b)=> (b.date||'').localeCompare(a.date||'') || (a.branch||'').localeCompare(b.branch||''));
      }
      return byRepo;
    }
    logsByRepo = normalizeLogs(RAW_LOGS);

    /* ===== 유틸 ===== */
    const qs = (s, el=document)=>el.querySelector(s);
    const qsa = (s, el=document)=>[...el.querySelectorAll(s)];
    const kst = (iso)=> {
      try{
        return new Date(iso).toLocaleString("ko-KR", { timeZone: "Asia/Seoul", year:"numeric", month:"2-digit", day:"2-digit", hour:"2-digit", minute:"2-digit", second:"2-digit" });
      }catch{ return iso || ""; }
    }
    const dayOnly = (iso)=>{
      try { return new Date(iso).toLocaleDateString("ko-KR", { timeZone:"Asia/Seoul", year:"numeric", month:"2-digit", day:"2-digit" }); }
      catch { return iso?.slice(0,10) || ""; }
    }
    function repoBase(full){ const p = full.split('/'); return p[p.length-1] || full; }

    /* ===== Repos 렌더 ===== */
    function renderRepos(){
      const list = qs('#repoList'); list.innerHTML = '';
      const filt = qs('#repoFilter').value.trim().toLowerCase();
      const fulls = [...new Set(USER_REPOS.map(r=>r.repositoryName))].sort();
      for(const full of fulls){
        if(filt && !full.toLowerCase().includes(filt)) continue;
        const chip = document.createElement('div');
        chip.className = 'repo-chip';
        if(full === currentRepoFull) chip.classList.add('active');
        chip.textContent = repoBase(full);
        chip.title = full;
        chip.addEventListener('click', ()=>{
          currentRepoFull = full;
          renderRepos();
          renderDays();
        });
        list.appendChild(chip);
      }
      // default select
      if(!currentRepoFull && fulls.length){
        currentRepoFull = fulls[0];
        renderRepos();
      }
    }
    qs('#repoFilter').addEventListener('input', renderRepos);

    /* ===== Days & Branches 렌더 ===== */
    function renderDays(){
      const host = qs('#daysPane'); host.innerHTML = '';
      const logs = (logsByRepo[currentRepoFull] || []);
      if(!logs.length){ host.innerHTML = '<p class="muted">로그가 없습니다.</p>'; return; }

      // group by day -> branch
      const byDay = {};
      for(const l of logs){
        const d = (l.date||l.created_at||'').slice(0,10);
        if(!byDay[d]) byDay[d] = {};
        const br = l.branch || l.ref || 'unknown';
        if(!byDay[d][br]) byDay[d][br] = [];
        byDay[d][br].push(l);
      }
      const days = Object.keys(byDay).sort().reverse();

      for(const day of days){
        const totalBranches = Object.keys(byDay[day]).length;
        const hdr = document.createElement('div');
        hdr.className = 'day-header';
        hdr.innerHTML = `<strong>${day}</strong><small>${totalBranches} item(s)</small>`;
        host.appendChild(hdr);

        const box = document.createElement('div');
        box.className = 'group';
        host.appendChild(box);

        for(const br of Object.keys(byDay[day]).sort()){
          const items = byDay[day][br];

          const row = document.createElement('div');
          row.className = 'branch-row';
          row.innerHTML = `
            <div class="branch-name">${br}</div>
            <span class="badge">C ${sum(items.map(x=>x.commit_count||x.counts?.commits||0))}</span>
            <span class="badge">D ${sum(items.map(x=>x.dep_changed||x.counts?.dep_files||0))}</span>
            <div style="flex:1"></div>
            <button class="btn btn-toggle">접기</button>
          `;
          box.appendChild(row);

          const det = document.createElement('details');
          const key = `${day}|${br}`;
          if(openGroups.has(key)) det.setAttribute('open','');
          det.innerHTML = `
            <summary class="muted">커밋 목록</summary>
            <div class="commit-list"></div>
          `;
          box.appendChild(det);

          const list = qs('.commit-list', det);
          const commitsSorted = [...items].sort((a,b)=> (b.commit_time||b.date||'').localeCompare(a.commit_time||a.date||''));
          for(const c of commitsSorted){
            // 각각 문서가 하루 집계가 아니라 커밋 단위로 온다면 그대로 표시
            const msg = (c.message || c.examples?.[0]?.message || '커밋').split('\n')[0];
            const sha = (c.sha || c.examples?.[0]?.sha || '').slice(0,7);
            const ts = (c.commit_time || c.date || c.created_at || '');
            const fresh = isFresh(ts, 3); // 3분 이내이면 true

            const item = document.createElement('div');
            item.className = 'commit-item';
            item.innerHTML = `
              <div class="commit-left">
                ${fresh?'<span class="new-dot" title="3분 이내 업데이트"></span>':''}
                <div class="commit-msg" title="${msg}">${escapeHtml(msg)}</div>
              </div>
              <div class="commit-right">
                <button class="sha" title="${kst(ts)}">${sha || '…'}</button>
              </div>
            `;
            // detail fetch
            qs('.sha', item).addEventListener('click', ()=> showCommitDetail(c));
            list.appendChild(item);
          }

          // 토글 버튼/상태 저장
          const btn = qs('.btn-toggle', row);
          const syncOpenState = ()=>{
            if(det.open) openGroups.add(key); else openGroups.delete(key);
            btn.textContent = det.open ? '접기' : '펼치기';
          };
          btn.addEventListener('click', ()=>{ det.open = !det.open; syncOpenState(); });
          det.addEventListener('toggle', syncOpenState);
          syncOpenState();
        }
      }
      qs('#lastRefresh').textContent = `마지막 새로고침: ${kst(new Date().toISOString())}`;
      lastRenderTs = Date.now();
    }

    function sum(arr){ return arr.reduce((a,b)=>a+(+b||0),0); }
    function isFresh(iso, mins){
      if(!iso) return false;
      const dt = new Date(iso).getTime();
      return (Date.now() - dt) <= mins*60*1000;
    }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    /* ===== 커밋 상세 ===== */
    async function showCommitDetail(doc){
      const pane = qs('#detailPane');
      pane.innerHTML = '<p class="muted">불러오는 중…</p>';
      try{
        const q = new URLSearchParams({
          repo: doc.repo_full_name || currentRepoFull,
          branch: doc.branch || '',
          sha: (doc.sha || doc.examples?.[0]?.sha || ''),
          date: (doc.date || doc.commit_time || '')
        });
        const r = await fetch('/api/commit_detail?'+q.toString());
        const d = await r.json();
        if(!r.ok) throw new Error(d.error||'fetch failed');

        const when = d.date ? kst(d.date) : '';
        const files = (d.files||[]).map(f=>`- ${f.filename} (${f.status}${f.additions?`, +${f.additions}`:''}${f.deletions?`, -${f.deletions}`:''})`).join('\n');

        pane.innerHTML = `
          <div class="kv">
            <div class="muted">Repo</div><div>${escapeHtml(d.repo||doc.repo_full_name||currentRepoFull||'')}</div>
            <div class="muted">Branch</div><div>${escapeHtml(d.branch||doc.branch||'')}</div>
            <div class="muted">Author</div><div>${escapeHtml(d.author||'')}</div>
            <div class="muted">When (KST)</div><div>${when}</div>
            <div class="muted">SHA</div><div><code>${escapeHtml(d.sha||'')}</code></div>
          </div>
          <div>
            <div class="muted">Message</div>
            <pre>${escapeHtml(d.message||'')}</pre>
          </div>
          <div>
            <div class="muted">Files</div>
            <pre>${escapeHtml(files||'')}</pre>
          </div>
        `;
      }catch(e){
        pane.innerHTML = `<p style="color:#c00">불러오기 실패: ${escapeHtml(e.message)}</p>`;
      }
    }

    /* ===== 자동 새로고침 (1분) – 펼친 상태 유지 & 새로운 커밋 표시 ===== */
    async function refreshLogs({keepOpen=true}={}){
      try{
        const r = await fetch('/api/branch_logs?userId='+encodeURIComponent(USER_ID));
        const data = await r.json();
        if(!r.ok) throw new Error(data.error||'refresh failed');

        if(keepOpen){
          // openGroups는 그대로 보존
        } else {
          openGroups.clear();
        }
        logsByRepo = normalizeLogs(data);
        renderRepos();   // 현재 repo 하이라이트 유지
        renderDays();    // 새 데이터 반영
      }catch(e){
        console.warn('refresh failed', e);
      }
    }
    setInterval(()=> refreshLogs({keepOpen:true}), 60*1000);

    /* ===== 초기 렌더 ===== */
    renderRepos();
    renderDays();

    /* ===== 동기화 버튼 ===== */
    qs('#btnSync').addEventListener('click', ()=>{
      // 백엔드 엔드포인트 이름은 sync_my_repos 로 사용
      window.location.href = "{{ url_for('sync_my_repos') }}";
    });

    /* ===== 수평 리사이저 (드래그 방향 자연스럽게) ===== */
    (function(){
      const app = qs('.app');
      const r1 = qs('#resizer1'), r2 = qs('#resizer2');
      // 현재 col widths(px) 읽기
      function getCols(){
        return getComputedStyle(app).gridTemplateColumns.split(' ').map(v => v.endsWith('px')? parseFloat(v): v);
      }
      function setCols(cols){ app.style.gridTemplateColumns = cols.map(v => (typeof v==='number'? `${v}px` : v)).join(' '); }

      function startDrag(resizer, leftIdx, rightIdx){
        const startX = event.clientX;
        const cols0 = getCols().map(v => (typeof v==='number'? v : parseFloat(v)));
        const move = (e)=>{
          const dx = e.clientX - startX;
          // 자연스러운 방향: 오른쪽으로 드래그하면 왼쪽 pane 넓어지고 오른쪽은 줄어듦
          const cols = [...cols0];
          cols[leftIdx]  = Math.max(120, cols0[leftIdx]  + dx);
          cols[rightIdx] = Math.max(200, cols0[rightIdx] - dx);
          setCols(cols);
        };
        const up = ()=>{ window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', up); };
        window.addEventListener('mousemove', move);
        window.addEventListener('mouseup', up);
      }
      r1.addEventListener('mousedown', (e)=>{ e.preventDefault(); startDrag(r1, 0, 2); });
      r2.addEventListener('mousedown', (e)=>{ e.preventDefault(); startDrag(r2, 2, 4); });
    })();
  </script>
</body>
</html>

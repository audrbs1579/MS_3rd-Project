<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Project Guardian â€“ Branch Activity</title>
  <style>
    /* ê¸°ë³¸(XPí’ ì‹œìŠ¤í…œ) í°íŠ¸ */
    body, button, input, select { font-family: Tahoma, Geneva, Verdana, sans-serif; font-size: 12px; }

    /* 3-ì—´ ê¸°ë³¸ ë ˆì´ì•„ì›ƒ */
    .layout { display: grid; grid-template-columns: 1fr 6px 1.2fr 6px 1.2fr; height: 100vh; margin: 0; }
    .col { display: flex; flex-direction: column; min-width: 0; }
    .col header { padding: 8px; border-bottom: 1px solid #ddd; }
    .col header h3 { margin: 0; font-size: 14px; }
    .col .body { flex: 1; overflow: auto; padding: 8px; }

    /* ìˆ˜ì§ ë¦¬ì‚¬ì´ì €(ë“œë˜ê·¸ë¡œ í­ ì¡°ì ˆ) â€” ë§ˆìš°ìŠ¤ ì´ë™ ë°©í–¥ê³¼ ê°™ì€ ë°©í–¥ìœ¼ë¡œ ë™ì‘ */
    .gutter { background:#eee; cursor: col-resize; }
    .gutter:hover { background:#ddd; }

    /* ë‚ ì§œ ë¸”ë¡ í—¤ë” (ìƒë‹¨ ì˜¤ë Œì§€) */
    .date-header {
      margin: 12px 0 8px 0; padding: 10px 12px; border-radius: 6px;
      background: rgb(255,149,0); /* Apple system orange */
      color: #fff; display: flex; align-items: center; justify-content: space-between;
    }
    .date-header .meta { opacity: .9; }

    /* ë¸Œëœì¹˜ í–‰ & í† ê¸€ */
    .branch-row { border: 1px solid #ccc; border-radius: 6px; margin-bottom: 8px; }
    .branch-head {
      display:flex; align-items:center; gap:8px; padding:8px 10px; background:#fafafa; cursor:pointer;
    }
    .branch-name { font-weight:bold; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #bbb; border-radius:999px; background:#f4f4f4; margin-left:4px; }
    .branch-body { display:none; max-height:320px; overflow:auto; padding:6px 8px 10px 8px; background:#fff; border-top:1px solid #e6e6e6; }
    .branch-row.open .branch-body { display:block; }

    /* ì»¤ë°‹ ì•„ì´í…œ */
    .commit { display:flex; align-items:center; justify-content:space-between; gap:12px;
              padding:8px 10px; border:1px solid #e6e6e6; border-radius:6px; background:#fff; margin-bottom:6px; }
    .commit-msg { overflow:hidden; white-space:nowrap; text-overflow:ellipsis; max-width: calc(100% - 120px); }
    .sha { font-family: Consolas, "Courier New", monospace; background:#f2f6ff; border:1px solid #cfe0ff;
           padding:2px 8px; border-radius:999px; color:#2b5fd9; }
    .fresh { display:inline-flex; align-items:center; gap:4px;
             color:#1a7f37; font-weight:bold; margin-right:6px; }
    .fresh::before { content:"âœ”"; display:inline-block; }

    /* ì˜¤ë¥¸ìª½ íŒ¨ë„(ì»¤ë°‹ ìƒì„¸) */
    .kv { margin:0; padding:0; list-style:none; }
    .kv li { display:flex; gap:8px; border-bottom:1px solid #eee; padding:6px 0; }
    .kv b { width:110px; flex:0 0 110px; }

    /* ìƒë‹¨ íˆ´ë°” */
    .toolbar { display:flex; gap:6px; align-items:center; }
    .toolbar input[type="text"]{ padding:6px; border:1px solid #bbb; border-radius:4px; min-width: 220px; }

    /* ë¹„ì–´ìˆìŒ/ì˜¤ë¥˜ */
    .empty { color:#666; padding:16px; border:1px dashed #ccc; border-radius:6px; background:#fafafa; }
    .error { color:#b00020; white-space:pre-wrap; word-break:break-all; padding:10px; border:1px solid #f0c0c0; background:#fff5f5; border-radius:6px; }
  </style>
</head>
<body>
  <div class="layout">
    <!-- Repositories -->
    <section class="col" id="col-repos">
      <header>
        <h3>Repositories</h3>
        <div class="toolbar">
          <input id="repoFilter" type="text" placeholder="owner/repo í•„í„°" />
          <button id="btnSync">ë™ê¸°í™”</button>
          <a href="{{ url_for('logout') }}"><button>Logout</button></a>
        </div>
      </header>
      <div class="body" id="repoList"></div>
    </section>

    <div class="gutter" data-left="col-repos" data-right="col-days"></div>

    <!-- Days & Branches -->
    <section class="col" id="col-days">
      <header>
        <h3>Days &amp; Branches</h3>
        <div class="toolbar">
          <input id="dayFilter" type="text" placeholder="ë¸Œëœì¹˜ ë˜ëŠ” ë‚ ì§œ(YYYY-MM-DD) í•„í„°" />
          <button id="btnClearFilter">Clear</button>
          <span id="lastRefresh" style="margin-left:auto;color:#666;"></span>
        </div>
      </header>
      <div class="body" id="daysPane">
        <div class="empty">ë ˆí¬ì§€í† ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>
      </div>
    </section>

    <div class="gutter" data-left="col-days" data-right="col-detail"></div>

    <!-- Commit Detail -->
    <section class="col" id="col-detail">
      <header><h3>Commit Detail</h3></header>
      <div class="body" id="detailPane"><div class="empty">ì»¤ë°‹ì„ ì„ íƒí•˜ì„¸ìš”.</div></div>
    </section>
  </div>

  <script>
    /* --------------------- ì´ˆê¸° ë°ì´í„° --------------------- */
    const RAW_LOGS = {{ logs|tojson|safe }};
    const USER_REPOS = {{ repos|tojson|safe }};
    const USER_ID = "{{ user_id }}";

    /* ìƒíƒœ: ì„ íƒ/ì—´ë¦¼ ìœ ì§€ */
    let currentRepo = null;
    const openBranchKeys = new Set();
    const scrollMemory = { days: 0 };
    let AUTO_TIMER = null;

    /* ë„êµ¬ */
    const qs = (s, p=document) => p.querySelector(s);
    const qsa = (s, p=document) => [...p.querySelectorAll(s)];

    function fmtKST(iso){
      if(!iso) return '';
      return new Date(iso).toLocaleString("ko-KR", {
        timeZone: "Asia/Seoul", year:"numeric", month:"2-digit", day:"2-digit",
        hour:"2-digit", minute:"2-digit", second:"2-digit"
      });
    }
    function shortSha(sha){ return (sha||'').substring(0,7); }
    function isFresh(iso){
      if(!iso) return false;
      const now = Date.now();
      const d = new Date(iso).getTime();
      return (now - d) <= 3*60*1000; // 3ë¶„ ì´ë‚´
    }
    function branchKey(day, branch){ return `${day}|${branch}`; }

    /* --------------------- ë¦¬ì‚¬ì´ì € --------------------- */
    qsa('.gutter').forEach(g => {
      let startX, leftW, rightW, leftEl, rightEl;
      g.addEventListener('mousedown', (e)=>{
        leftEl = qs(`#${g.dataset.left}`); rightEl = qs(`#${g.dataset.right}`);
        const rectL = leftEl.getBoundingClientRect();
        const rectR = rightEl.getBoundingClientRect();
        startX = e.clientX; leftW = rectL.width; rightW = rectR.width;
        const onMove = (ev)=>{
          const dx = ev.clientX - startX;         // ë§ˆìš°ìŠ¤ ì´ë™ ë°©í–¥ = íŒ¨ë„ ë³€ê²½ ë°©í–¥
          leftEl.style.width  = (leftW + dx) + 'px';
          rightEl.style.width = (rightW - dx) + 'px';
        };
        const onUp = ()=>{
          window.removeEventListener('mousemove', onMove);
          window.removeEventListener('mouseup', onUp);
        };
        window.addEventListener('mousemove', onMove);
        window.addEventListener('mouseup', onUp);
      });
    });

    /* --------------------- ë ˆí¬ ë Œë” --------------------- */
    const repoListEl = qs('#repoList');
    function renderRepos() {
      const f = qs('#repoFilter').value.trim().toLowerCase();
      const items = USER_REPOS
        .map(r => ({ full: r.repositoryName || r, name: (r.repositoryName||r).split('/').slice(-1)[0] }))
        .filter(x => !f || x.full.toLowerCase().includes(f));
      repoListEl.innerHTML = '';
      if(items.length === 0){ repoListEl.innerHTML = '<div class="empty">ë ˆí¬ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return;}
      items.forEach(x=>{
        const btn = document.createElement('button');
        btn.textContent = x.name; btn.style.margin='0 6px 6px 0';
        btn.addEventListener('click', ()=> selectRepo(x.full));
        repoListEl.appendChild(btn);
      });
    }

    /* --------------------- ë‚ ì§œ/ë¸Œëœì¹˜ ë Œë” --------------------- */
    const daysPane = qs('#daysPane');

    function groupByDayAndBranch(logs) {
      const by = {};
      logs.forEach(l=>{
        if(l.repo_full_name !== currentRepo) return;
        const day = l.date;
        const branch = l.branch;
        if(!by[day]) by[day] = {};
        if(!by[day][branch]) by[day][branch] = { commits: [], commit_count: 0, dep_changes: 0 };
        const slot = by[day][branch];
        slot.commit_count += (l.counts && l.counts.commits) || l.commit_count || 0;
        slot.dep_changes += (l.counts && l.counts.dep_files_changed) || l.dep_changes || 0;
        (l.examples || l.commits || []).forEach(c=> slot.commits.push(c));
      });
      const days = Object.keys(by).sort((a,b)=> (a>b?-1:1));
      return { days, by };
    }

    function renderDays() {
      const f = qs('#dayFilter').value.trim().toLowerCase();
      const { days, by } = groupByDayAndBranch(RAW_LOGS);
      daysPane.scrollTop = scrollMemory.days || 0;
      daysPane.innerHTML = '';

      if(!currentRepo){ daysPane.innerHTML = '<div class="empty">ë ˆí¬ì§€í† ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>'; return; }
      if(days.length===0){ daysPane.innerHTML = '<div class="empty">ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }

      days.forEach(day=>{
        const dayBox = document.createElement('div');
        const header = document.createElement('div');
        header.className = 'date-header';
        header.innerHTML = `<div><b>${day}</b></div><div class="meta">${Object.keys(by[day]).length} item(s)</div>`;
        dayBox.appendChild(header);

        Object.keys(by[day]).sort().forEach(branch=>{
          const key = branchKey(day, branch);
          const info = by[day][branch];

          const row = document.createElement('div');
          row.className = 'branch-row' + (openBranchKeys.has(key)?' open':'');

          const head = document.createElement('div');
          head.className = 'branch-head';
          head.innerHTML =
            `<span class="branch-name">${branch}</span>
             <span class="pill">C ${info.commit_count||info.commits.length||0}</span>
             <span class="pill">D ${info.dep_changes||0}</span>
             <button style="margin-left:auto" class="btnToggle">${row.classList.contains('open')?'ì ‘ê¸°':'í¼ì¹˜ê¸°'}</button>`;
          head.addEventListener('click', (ev)=>{
            row.classList.toggle('open');
            const opened = row.classList.contains('open');
            qs('.btnToggle', head).textContent = opened? 'ì ‘ê¸°' : 'í¼ì¹˜ê¸°';
            if(opened) openBranchKeys.add(key); else openBranchKeys.delete(key);
          });
          row.appendChild(head);

          const body = document.createElement('div');
          body.className = 'branch-body';

          const commits = (info.commits || []).slice().sort((a,b)=>{
            const da = (a.timestamp || a.date || a.committer?.date || a.author?.date || '');
            const db = (b.timestamp || b.date || b.committer?.date || b.author?.date || '');
            return (da>db? -1: 1);
          });

          if(commits.length===0){
            body.innerHTML = `<div class="empty">ì»¤ë°‹ ì—†ìŒ</div>`;
          }else{
            commits.forEach(c=>{
              const iso = c.timestamp || c.date || c.committer?.date || c.author?.date || null;
              const item = document.createElement('div');
              item.className = 'commit';
              const left = document.createElement('div');
              left.className = 'commit-msg';
              const msg = (c.message || c.commit?.message || '').split('\n')[0] || '(no message)';
              left.innerHTML = `${isFresh(iso)?'<span class="fresh">NEW</span>':''}<span title="${msg}">${msg}</span>`;
              const right = document.createElement('div');
              right.innerHTML = `<span class="sha" title="${iso?fmtKST(iso):''}">${shortSha(c.sha || c.id || c.node_id || '')}</span>`;
              item.appendChild(left); item.appendChild(right);

              item.addEventListener('click', ()=>{
                renderCommitDetail({
                  repo: currentRepo, branch,
                  sha: c.sha || c.id || '',
                  author: c.author?.name || c.commit?.author?.name || c.committer?.name || c.author || '',
                  date: iso,
                  message: msg,
                  url: c.html_url || c.url || ''
                });
              });

              body.appendChild(item);
            });
          }

          row.appendChild(body);
          dayBox.appendChild(row);
        });

        daysPane.appendChild(dayBox);
      });

      qs('#lastRefresh').textContent = `ê°±ì‹ : ${fmtKST(new Date().toISOString())}`;
    }

    /* --------------------- ì»¤ë°‹ ìƒì„¸ --------------------- */
    const detailPane = qs('#detailPane');
    async function renderCommitDetail(meta){
      try{
        const d = meta;
        detailPane.innerHTML = `
          <ul class="kv">
            <li><b>Repository</b><span>${d.repo}</span></li>
            <li><b>Branch</b><span>${d.branch||''}</span></li>
            <li><b>SHA</b><span>${d.sha||''}</span></li>
            <li><b>Author</b><span>${d.author||''}</span></li>
            <li><b>When</b><span>${d.date?fmtKST(d.date):''}</span></li>
            <li><b>Message</b><span>${(d.message||'').replace(/</g,'&lt;')}</span></li>
            ${d.url?`<li><b>Link</b><a href="${d.url}" target="_blank" rel="noopener">View on GitHub</a></li>`:''}
          </ul>
        `;
      }catch(err){
        detailPane.innerHTML = `<div class="error">${err.message||String(err)}</div>`;
      }
    }

    /* --------------------- ë™ì‘ --------------------- */
    function selectRepo(full){
      currentRepo = full;
      scrollMemory.days = 0;
      openBranchKeys.clear();
      renderDays();
    }

    // í•„í„° & ë²„íŠ¼
    qs('#btnClearFilter').addEventListener('click', ()=>{ qs('#dayFilter').value=''; renderDays(); });
    qs('#repoFilter').addEventListener('input', renderRepos);
    qs('#dayFilter').addEventListener('input', renderDays);
    // ğŸ”§ ì—”ë“œí¬ì¸íŠ¸ ì´ë¦„ ìˆ˜ì •: sync_my_repos
    qs('#btnSync').addEventListener('click', ()=>{ window.location.href = "{{ url_for('sync_my_repos') }}"; });

    // ì°½ ì—´ë¦¼ ìƒíƒœ/ìŠ¤í¬ë¡¤ ìœ ì§€í•˜ë©° ê°±ì‹ 
    async function autoRefresh(){
      try{
        scrollMemory.days = daysPane.scrollTop;
        // (APIë¡œ RAW_LOGSë¥¼ ê°±ì‹ í•˜ëŠ” ë¶€ë¶„ì„ ë¶™ì¼ ìˆ˜ ìˆìŒ)
      }catch(_e){
      }finally{
        renderDays();
      }
    }

    function startAutoRefresh(){
      if(AUTO_TIMER) clearInterval(AUTO_TIMER);
      AUTO_TIMER = setInterval(autoRefresh, 60*1000); // 1ë¶„
    }

    // ì´ˆê¸° ë Œë”
    renderRepos();
    startAutoRefresh();

    if(USER_REPOS && USER_REPOS.length){
      const first = (USER_REPOS[0].repositoryName || USER_REPOS[0]);
      selectRepo(first);
    }

    window.addEventListener('beforeunload', ()=> AUTO_TIMER && clearInterval(AUTO_TIMER));
  </script>
</body>
</html>

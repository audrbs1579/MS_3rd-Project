<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf--8" />
  <title>Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🛡️</text></svg>">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
  <style>
    .main-container { display: grid; grid-template-columns: minmax(300px, 1.2fr) minmax(250px, 1fr) minmax(300px, 1.5fr); gap: 16px; height: 65vh; margin-bottom: 16px; }
    .column { display: flex; flex-direction: column; background-color: #fff; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); overflow: hidden; }
    .column h2 { font-size: 1rem; padding: 12px 16px; margin: 0; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; }
    .column .body { padding: 8px; overflow-y: auto; flex-grow: 1; }
    .column .empty-state { padding: 16px; color: #6b7280; }
    .detail-container { display: grid; grid-template-columns: 1fr; gap: 16px; }
    .list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-radius: 6px; cursor: pointer; border: 1px solid transparent; transition: background-color 0.2s, border-color 0.2s; }
    .list-item:hover { background-color: #f9fafb; }
    .list-item.selected { background-color: #eef2ff; border-color: #c7d2fe; font-weight: 600; }
    .commit-info { flex-grow: 1; overflow: hidden; margin-right: 8px; }
    .commit-message { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .commit-author { font-size: 0.8rem; color: #6b7280; margin-top: 2px; }
    .commit-sha { font-family: monospace; font-size: 0.85rem; }
    .commit-indicators { display: flex; gap: 5px; padding: 0 8px; width: 44px; justify-content: center; align-items: center; flex-shrink: 0; }
    .indicator { width: 10px; height: 10px; border-radius: 50%; background-color: #e5e7eb; }
    .indicator.status-good { background-color: #22c55e; }
    .indicator.status-warn { background-color: #f59e0b; }
    .indicator.status-bad { background-color: #ef4444; }
    .indicator.status-unknown { background-color: #9ca3af; }
    .spinner { border: 2px solid #f3f4f6; border-top: 2px solid #4f46e5; border-radius: 50%; width: 12px; height: 12px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .stamp { font-size: 0.75rem; color: #9ca3af; text-align: right; margin-top: 8px; padding-right: 4px; }
    .stamp.highlight { transition: color 0.2s; color: #4f46e5; }
    
    /* --- NEW: 커밋 새로고침 버튼 스타일 --- */
    .commit-actions { flex-shrink: 0; }
    .btn-refresh {
      background: none; border: none; cursor: pointer; padding: 4px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      color: #9ca3af;
    }
    .btn-refresh:hover { background-color: #e5e7eb; color: #111827; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <input id="repoFilter" class="input" placeholder="저장소 검색..." />
      <div class="toolbar-actions">
        <a href="/issues"><button type="button">보안 이슈 보기</button></a>
        <button id="btnVsConfig" type="button">VS Code</button>
        <button id="btnSync" type="button">새로고침</button>
        <span>Signed in as <b>{{ user_id }}</b></span>
        <a href="/logout"><button type="button">로그아웃</button></a>
      </div>
    </div>
    <div class="main-container">
      <div class="column" id="repo-column">
        <h2>내 저장소</h2>
        <div class="body repo-list" id="repoList"><div class="empty-state">데이터 로딩 중...</div></div>
      </div>
      <div class="column" id="branch-column">
        <h2>브랜치</h2>
        <div class="body" id="branchList"><div class="empty-state">저장소를 선택하세요.</div></div>
      </div>
      <div class="column" id="commit-column">
        <h2>커밋</h2>
        <div class="body" id="commitList"><div class="empty-state">브랜치를 선택하세요.</div></div>
      </div>
    </div>
    <div class="detail-container">
      <section id="security-summary-card" class="card status-unknown">
        <div class="security-summary-body">
          <div class="security-status">
            <div id="status-icon-container" class="status-icon"></div>
            <div class="status-text">
              <h3 id="security-summary-title">보안 요약</h3>
              <p id="security-summary-text">분석할 커밋을 선택하세요.</p>
            </div>
          </div>
          <button id="btn-view-details" disabled>상세 보기</button>
        </div>
        <div id="lastUpdatedStamp" class="stamp"></div>
      </section>
      <section id="detail-view-card" class="card" style="display: none;">
        <h2>커밋 상세 정보</h2>
        <div id="detail-container" class="body detail"></div>
      </section>
    </div>
  </div>

<script>
(()=>{
  const $ = (s, el = document) => el.querySelector(s);
  const $$ = (s, el = document) => el.querySelectorAll(s);

  const S = { repo: null, branch: null, selCommit: null, repos: [], branches: {}, securityByCommit: {}, commits_page: 1, commits_loading: false, commits_has_more: true, };
  const CACHE_KEY = 'dashboardCache';
  const CACHE_VERSION = 'v2';
  const ICONS = {
    good: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
    warn: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>`,
    bad: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" /></svg>`,
    unknown: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" /></svg>`
  };

  const repoFilter = $('#repoFilter'), repoListEl = $('#repoList');
  const branchListEl = $('#branchList'), commitListEl = $('#commitList');
  const detailViewCard = $('#detail-view-card'), detailContainerEl = $('#detail-container');
  const securityCard = $('#security-summary-card'), statusIcon = $('#status-icon-container');
  const summaryTitle = $('#security-summary-title'), summaryText = $('#security-summary-text');
  const btnSync = $('#btnSync'), btnVsConfig = $('#btnVsConfig'), btnDetails = $('#btn-view-details');
  const lastUpdatedStamp = $('#lastUpdatedStamp');

  function formatToKST(isoString) { /* ... */ }
  function loadCache() { /* ... */ }
  async function silentSync() { /* ... */ }
  async function api(path, options = {}) { /* ... */ }
  function renderRepos() { /* ... */ }
  function renderBranches() { /* ... */ }
  function selectRepo(repoName) { /* ... */ }
  function selectBranch(branchName) { /* ... */ }
  async function loadMoreCommits() { /* ... */ }
  async function analyzeCommitInBackground(sha) { /* ... */ }
  async function selectCommit(sha) { /* ... */ }
  async function refreshCommit(sha) { /* ... */ }
  function resetDetailView() { /* ... */ }
  function renderCommitDetails(details) { /* ... */ }
  function highlightSelection() { /* ... */ }
  function updateCommitIndicators(sha, status) { /* ... */ }
  function updateSecuritySummary(data) { /* ... */ }
  function esc(s) { /* ... */ }
  function ago(d) { /* ... */ }
  function el(tag, cls, content) { /* ... */ }

  document.addEventListener('DOMContentLoaded', () => {
    if (loadCache()) {
      renderRepos();
      setInterval(silentSync, 60000);
    } else {
      window.location.href = '/loading';
    }
  });

  $('#repoFilter').addEventListener('input', renderRepos);
  $('#btnSync').addEventListener('click', () => {
    sessionStorage.removeItem(CACHE_KEY);
    window.location.href = '/loading';
  });
  $('#btn-view-details').addEventListener('click', () => {
    if (S.selCommit) {
      const { repo, sha, branch } = S.selCommit;
      window.location.href = `/details?repo=${repo}&sha=${sha}&branch=${branch || ''}`;
    }
  });
  commitListEl.addEventListener('scroll', () => {
    if (S.repo && S.branch && commitListEl.scrollTop + commitListEl.clientHeight >= commitListEl.scrollHeight - 100) {
      loadMoreCommits();
    }
  });
  commitListEl.addEventListener('click', (e) => {
    const refreshButton = e.target.closest('.btn-refresh');
    if (refreshButton) {
      e.stopPropagation();
      const sha = refreshButton.dataset.sha;
      if (sha) {
        refreshCommit(sha);
      }
    }
  });
})();
</script>
</body>
</html>

<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#f9fafb; --card:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb;
      --ok:#22c55e; --ok-soft:#22c55e55;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;}
    .wrap{padding:16px;max-width:1200px;margin:0 auto}
    .toolbar{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .toolbar input{flex:1;border:1px solid var(--border);border-radius:8px;padding:10px 12px;background:#fff}
    .toolbar .btn{border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .grid{display:grid;grid-template-columns:1fr 1fr 1.2fr;gap:16px;min-height:520px}
    .col{background:var(--card);border:1px solid var(--border);border-radius:12px;display:flex;flex-direction:column;overflow:hidden}
    .col h2{margin:0;padding:12px 16px;border-bottom:1px solid var(--border);font-size:15px}
    .body{padding:8px;overflow:auto;flex:1}
    .empty{color:var(--muted);padding:12px}
    .item{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;margin:6px 4px;cursor:pointer}
    .item.active{outline:2px solid #3b82f622}
    .left{min-width:0}
    .title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sub{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .dots{display:flex;gap:6px;align-items:center}
    .dot{width:8px;height:8px;border-radius:50%;background:#d1d5db}
    .recent{box-shadow: inset 0 0 0 2px var(--ok-soft); position:relative}
    .recent::after{content:"";position:absolute;right:8px;top:50%;transform:translateY(-50%);width:8px;height:8px;border-radius:50%;background:var(--ok)}
    .footer{margin-top:14px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 16px;display:flex;justify-content:space-between;align-items:center}
    .link{border:1px solid var(--border);padding:8px 12px;border-radius:10px;background:#fff;text-decoration:none;color:inherit}
    .highlight{animation:flash 0.8s}
    @keyframes flash{from{background:#fef9c3} to{background:transparent}}
  </style>
</head>
<body>
<div class="wrap">
  <div class="toolbar">
    <input id="search" placeholder="저장소 검색..." />
    <button id="btn-issues" class="btn">보안 이슈 보기</button>
    <button id="btn-vscode" class="btn">VS Code</button>
    <button id="btn-refresh" class="btn">새로고침</button>
  </div>

  <div class="grid">
    <div class="col">
      <h2>Repositories</h2>
      <div id="repoList" class="body"><div class="empty">데이터 로딩 중...</div></div>
    </div>
    <div class="col">
      <h2>Branches</h2>
      <div id="branchList" class="body"><div class="empty">브랜치를 먼저 선택하세요.</div></div>
    </div>
    <div class="col">
      <h2>Commits</h2>
      <div id="commitList" class="body"><div class="empty">브랜치를 선택하면 커밋이 표시됩니다.</div></div>
    </div>
  </div>

  <div class="footer">
    <div>
      <div id="lastUpdated" class="sub">마지막 갱신: -</div>
      <div class="sub">선택 레포: <span id="selRepo">-</span> &nbsp; 선택 브랜치: <span id="selBranch">-</span> &nbsp; 선택 커밋: <span id="selCommit">-</span></div>
    </div>
    <a id="btn-detail" class="link" href="#" target="_blank">상세 보기</a>
  </div>
</div>

<script>
(()=> {
  // ====== 상태 ======
  const S = {
    repo:null, branch:null, commit:null,
    repos:[], branches:[], commits:[],
    page:1, hasMore:true, loading:false,
  };

  const elRepo = document.getElementById('repoList');
  const elBranch = document.getElementById('branchList');
  const elCommit = document.getElementById('commitList');
  const elSelRepo = document.getElementById('selRepo');
  const elSelBranch = document.getElementById('selBranch');
  const elSelCommit = document.getElementById('selCommit');
  const elLast = document.getElementById('lastUpdated');
  const btnDetail = document.getElementById('btn-detail');

  const THREE_MIN = 3 * 60 * 1000;

  // ====== 유틸 ======
  const normRepo = (full) => (full||"").replace(/\\/g,"/"); // 역슬래시 → 슬래시
  const esc = (s)=> String(s??"").replace(/[&<>"'`]/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;","`":"&#96;" }[m]));
  const ago = (iso)=>{
    if(!iso) return "-";
    const t = new Date(iso).getTime(), d = Date.now()-t;
    const sec = Math.floor(d/1000); if(sec<60) return `${sec}초 전`;
    const min = Math.floor(sec/60); if(min<60) return `${min}분 전`;
    const hr = Math.floor(min/60); if(hr<24) return `${hr}시간 전`;
    const day = Math.floor(hr/24); return `${day}일 전`;
  };
  const isRecent = (iso)=>{ if(!iso) return false; return (Date.now()-new Date(iso).getTime())<=THREE_MIN; };
  const stamp = ()=> new Date().toLocaleString('ko-KR',{hour12:false});

  async function api(path, query) {
    const qs = query ? `?${new URLSearchParams(query).toString()}` : "";
    const res = await fetch(path+qs, {credentials:'same-origin'});
    if(!res.ok) throw new Error(`${path} ${res.status}`);
    return await res.json();
  }

  function markRecentChain() {
    // 커밋이 최근이면 해당 커밋/브랜치/레포 요소에 .recent
    if(!S.commits || !S.commits.length) return;
    const c = S.commits.find(x=>x.sha===S.commit);
    if(!c || !isRecent(c.date)) return;

    const repoEl = elRepo.querySelector(`.item[data-repo="${CSS.escape(S.repo)}"]`);
    const brEl = elBranch.querySelector(`.item[data-branch="${CSS.escape(S.branch)}"]`);
    const cmEl = elCommit.querySelector(`.item[data-sha="${CSS.escape(S.commit)}"]`);
    repoEl?.classList.add('recent');
    brEl?.classList.add('recent');
    cmEl?.classList.add('recent');
  }

  // ====== 렌더 ======
  function renderRepos() {
    if(!S.repos.length){ elRepo.innerHTML = `<div class="empty">저장소 없음</div>`; return; }
    elRepo.innerHTML = "";
    S.repos.forEach(r=>{
      const full = normRepo(r.full_name);
      const div = document.createElement('div');
      div.className = `item repo-item${S.repo===full?' active':''}`;
      div.dataset.repo = full;
      div.innerHTML = `<div class="left"><div class="title">${esc(full)}</div><div class="sub">${esc(r.pushed_at||'')}</div></div><div class="dots"><span class="dot"></span></div>`;
      div.onclick = ()=> selectRepo(full);
      elRepo.appendChild(div);
    });
  }

  function renderBranches() {
    if(!S.branches.length){ elBranch.innerHTML = `<div class="empty">브랜치 없음</div>`; return; }
    elBranch.innerHTML = "";
    S.branches.forEach(b=>{
      const div = document.createElement('div');
      div.className = `item branch-item${S.branch===b.name?' active':''}`;
      div.dataset.branch = b.name;
      div.innerHTML = `<div class="left"><div class="title">${esc(b.name)}</div><div class="sub">최근: ${esc(b.commit?.sha?.slice(0,7)||'-')}</div></div><div class="dots"><span class="dot"></span></div>`;
      div.onclick = ()=> selectBranch(b.name);
      elBranch.appendChild(div);
    });
  }

  function renderCommits(append=false) {
    if(!append) elCommit.innerHTML = "";
    if(!S.commits.length){ elCommit.innerHTML = `<div class="empty">커밋 없음</div>`; return; }

    const frag = document.createDocumentFragment();
    S.commits.forEach(c=>{
      const div = document.createElement('div');
      div.className = `item commit-item${S.commit===c.sha?' active':''}`;
      div.dataset.sha = c.sha;
      div.innerHTML = `
        <div class="left">
          <div class="title">${esc(c.message||c.sha)}</div>
          <div class="sub">${esc(c.author||'-')} · ${ago(c.date)}</div>
        </div>
        <div class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
      `;
      div.onclick = ()=> selectCommit(c.sha);
      frag.appendChild(div);
    });
    elCommit.appendChild(frag);
    markRecentChain();
  }

  // ====== 선택/로드 ======
  async function selectRepo(full) {
    S.repo = normRepo(full);
    S.branch = null; S.commit = null;
    elSelRepo.textContent = S.repo; elSelBranch.textContent='-'; elSelCommit.textContent='-';
    elBranch.innerHTML = `<div class="empty">브랜치 로딩 중...</div>`;
    elCommit.innerHTML = `<div class="empty">브랜치를 선택하면 커밋이 표시됩니다.</div>`;
    const data = await api('/api/branches', { repo: S.repo }); // repo에 슬래시 보장
    S.branches = data.branches || [];
    renderBranches();
  }

  async function selectBranch(name) {
    S.branch = name; S.commit = null;
    elSelBranch.textContent = name; elSelCommit.textContent='-';
    S.page = 1; S.hasMore = true; S.loading=false; S.commits=[];
    elCommit.innerHTML = `<div class="empty">커밋 로딩 중...</div>`;
    await loadMoreCommits(true);
  }

  async function selectCommit(sha) {
    S.commit = sha;
    elSelCommit.textContent = sha.slice(0,7);
    const url = `/details?repo=${encodeURIComponent(S.repo)}&branch=${encodeURIComponent(S.branch||'')}&sha=${encodeURIComponent(S.commit)}`;
    document.getElementById('btn-detail').href = url;
    renderCommits(); // active 표시 갱신
  }

  async function loadRepos() {
    const data = await api('/api/get_initial_data');
    S.repos = (data.repos||[]).map(r=>({full_name:normRepo(r.full_name), pushed_at:r.pushed_at}));
    renderRepos();
    elLast.textContent = `마지막 갱신: ${stamp()}`;
  }

  async function loadMoreCommits(reset=false) {
    if(S.loading || !S.hasMore) return;
    S.loading = true;
    try{
      const data = await api('/api/commits', { repo:S.repo, branch:S.branch, page:S.page });
      const list = data.commits||[];
      if(reset) S.commits = list; else S.commits = S.commits.concat(list);
      S.hasMore = !!data.has_more;
      S.page += 1;
      renderCommits(!reset);
    } finally {
      S.loading = false;
    }
  }

  // ====== 자동 새로고침(상태 유지) ======
  async function autoRefresh() {
    const keep = { repo:S.repo, branch:S.branch, commit:S.commit };
    await loadRepos();
    if(keep.repo){
      S.repo = keep.repo;
      const b = await api('/api/branches', { repo:S.repo });
      S.branches = b.branches||[];
      renderBranches();
    }
    if(keep.repo && keep.branch){
      S.branch = keep.branch; S.page=1; S.hasMore=true; S.commits=[];
      await loadMoreCommits(true);
    }
    if(keep.commit){
      S.commit = keep.commit;
      renderCommits(); // active 복원
    }
    elLast.classList.add('highlight');
    setTimeout(()=>elLast.classList.remove('highlight'), 800);
  }

  // ====== 이벤트 ======
  document.getElementById('btn-refresh').onclick = autoRefresh;
  document.getElementById('btn-issues').onclick = ()=> location.href='/issues';
  document.getElementById('btn-vscode').onclick = ()=> alert('VS Code 연동 예정');
  elCommit.addEventListener('scroll', e=>{
    const nearBottom = e.target.scrollTop + e.target.clientHeight >= e.target.scrollHeight - 60;
    if(nearBottom) loadMoreCommits();
  });

  // 초기 & 30초 자동 새로고침
  (async ()=>{
    await loadRepos();
    setInterval(autoRefresh, 30000);
  })();
})();
</script>
</body>
</html>

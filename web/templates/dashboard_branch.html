<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>대시보드</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg: #f9fafb; --panel: #ffffff; --border: #e5e7eb; --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --text-main: #111827; --text-muted: #6b7280; --text-accent: #3b82f6; --panel-hover: #f9fafb;
      --status-good-bg: #f0fdf4; --status-good-text: #166534; --status-good-icon: #22c55e;
      --status-warn-bg: #fefce8; --status-warn-text: #854d0e; --status-warn-icon: #f59e0b;
      --status-bad-bg: #fef2f2; --status-bad-text: #991b1b; --status-bad-icon: #ef4444;
      --status-unknown-bg: #f3f4f6; --status-unknown-text: #4b5563;
      --status-recent: #22c55e;
    }
    *{box-sizing:border-box}
    html,body{ margin:0; padding:0; height:100%; background:var(--bg); color:var(--text-main); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; font-size: 15px; }
    .wrap{max-width:1400px; margin:0 auto; padding:24px; display:flex; flex-direction:column; height:100%;}
    .monospace{font-family: ui-monospace, Consolas, Menlo, monospace;}
    .toolbar{display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:16px;}
    .input{ width:100%; padding:10px 14px; border:1px solid var(--border); background:var(--panel); border-radius:8px; font-size:15px; box-shadow: var(--shadow); }
    button{ padding:8px 16px; border:1px solid var(--border); border-radius:8px; background:var(--panel); font-size: 14px; font-weight:500; cursor:pointer; box-shadow: var(--shadow); transition: background-color 0.2s; }
    button:hover{background-color: #f3f4f6;}
    .main-grid { display: grid; grid-template-rows: auto 1fr auto; gap: 16px; flex-grow: 1; min-height: 0; }
    .grid-row-mid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 16px; min-height: 0; }
    .card{ display:flex; flex-direction:column; border:1px solid var(--border); border-radius:12px; background:var(--panel); min-height:0; box-shadow: var(--shadow); }
    .card h2{ margin:0; padding:10px 16px; border-bottom:1px solid var(--border); font-size:14px; font-weight:600; }
    .body{padding:12px; overflow:auto;}
    .stamp{padding:0 8px 8px 8px; font-size:12px; color:var(--text-muted)}
    .repo-item{ display:flex; align-items:center; gap:12px; padding:10px 12px; border:none; border-radius:8px; cursor:pointer; width:100%; text-align:left; transition: background-color 0.2s; }
    .repo-item:hover{background-color: var(--panel-hover);}
    .repo-item.selected { background-color: #eef2ff; }
    .repo-name{font-weight:500; font-size:14px; }
    .repo-meta{font-size:12px; color:var(--text-muted); margin-left: auto; }
    .status-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; background-color: var(--status-recent); }
    #branches-container, #detail-container { padding: 12px; }
    .branch{border:1px solid var(--border); border-radius:8px; overflow:hidden; margin-top: 8px;}
    .branch-head{ display:flex; gap:8px; align-items:center; background:var(--panel-hover); padding:8px 12px; font-size:14px; }
    .sha-tag{ border:1px solid var(--border); border-radius:999px; padding:1px 6px; font-size:11px; color:var(--text-muted); background: var(--panel); }
    .panel{padding:6px;}
    .commit{ display:grid; grid-template-columns:1fr auto; gap:8px; border-radius:6px; padding:8px 10px; margin-bottom:4px; cursor:pointer; transition: background-color 0.2s; }
    .commit:hover{background:var(--panel-hover)}
    .commit.selected { background-color: #eef2ff; }
    .commit .msg { font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .commit .meta { font-size: 11px; color: var(--text-muted); }
    .detail .field { border:1px solid var(--border); border-radius:6px; overflow:hidden; margin-bottom:6px; }
    .detail .field h3{ margin:0; padding:3px 8px; background:var(--panel-hover); font-size:10px; font-weight:600; color:var(--text-muted); text-transform: uppercase; }
    .detail .field .val{ padding:5px 8px; font-size:13px; }
    
    #security-summary-card { transition: background-color 0.3s; }
    .security-summary-body { display: flex; align-items: center; justify-content: space-between; padding: 16px; }
    .security-status { display: flex; align-items: center; gap: 12px; }
    .status-icon { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
    .status-icon svg { width: 20px; height: 20px; }
    .status-text h3 { margin: 0; font-size: 16px; }
    .status-text p { margin: 0; font-size: 14px; color: var(--text-muted); }
    #btn-view-details { padding: 8px 20px; font-weight: 600; }
    #btn-view-details:disabled { background-color: #e5e7eb; cursor: not-allowed; opacity: 0.7; }

    .status-good { background-color: var(--status-good-bg); color: var(--status-good-text); }
    .status-warn { background-color: var(--status-warn-bg); color: var(--status-warn-text); }
    .status-bad { background-color: var(--status-bad-bg); color: var(--status-bad-text); }
    .status-unknown { background-color: var(--status-unknown-bg); color: var(--status-unknown-text); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <input id="repoFilter" class="input" placeholder="리포지토리 검색..." />
      <div>
        <button id="btnSync">새로고침</button>
        <span>사용자: <b>{{ user_id }}</b></span>
        <a href="/logout"><button type="button">로그아웃</button></a>
      </div>
    </div>
    
    <div class="main-grid">
      <section class="card">
        <h2>나의 리포지토리</h2>
        <div class="body" id="repoList" style="max-height: 200px;"></div>
        <div id="repoStamp" class="stamp"></div>
      </section>

      <div class="grid-row-mid">
        <section class="card">
          <h2>브랜치 & 커밋</h2>
          <div id="branches-container" class="body">리포를 선택하세요.</div>
        </section>
        <section class="card">
          <h2>커밋 상세</h2>
          <div id="detail-container" class="body detail"></div>
        </section>
      </div>
      
      <section id="security-summary-card" class="card status-unknown">
        <div class="security-summary-body">
          <div class="security-status">
            <div id="status-icon-container" class="status-icon"></div>
            <div class="status-text">
              <h3 id="security-summary-title">통합 보안 현황</h3>
              <p id="security-summary-text">분석할 커밋을 선택하세요.</p>
            </div>
          </div>
          <button id="btn-view-details" disabled>상세 분석 보기</button>
        </div>
      </section>
    </div>
  </div>

  <script>
  (()=>{
    const $ = (s,el=document)=>el.querySelector(s);
    const S = { repo:null, selCommit:null, repos:[], branches:{}, opened:new Set() };
    const REFRESH_INTERVAL_MS = 60000;
    let refreshInFlight = false;
    const repoList = $('#repoList'), repoStamp=$('#repoStamp');
    const btnSync = $('#btnSync');
    const branchesBox = $('#branches-container'), detailBox = $('#detail-container');
    const securityCard = $('#security-summary-card'), statusIcon = $('#status-icon-container');
    const summaryTitle = $('#security-summary-title'), summaryText = $('#security-summary-text');
    const btnDetails = $('#btn-view-details');
    
    const ICONS = {
        good: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
        warn: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" /></svg>`,
        bad: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" /></svg>`,
        unknown: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" /></svg>`
    };

    async function api(path, params={}) {
        const qs = new URLSearchParams(params);
        const url = `${path}?${qs.toString()}`;
        const r = await fetch(url);
        if(r.status===401) { location.href='/'; throw new Error('Unauthorized'); }
        if (!r.ok) { 
            const errData = await r.json().catch(()=>({error: r.statusText}));
            throw new Error(errData.error || `HTTP error ${r.status}`);
        }
        return r.json();
    }
    
    async function loadRepos(){ 
        try{
          S.repos = (await api('/api/my_repos')).repos || [];
          renderRepos();
        }catch(e){
          console.error('Failed to load repos:', e);
          repoList.innerHTML = `<div style="color:#b91c1c">레포지토리를 불러오는 중 오류: ${e.message}</div>`;
        }
    }
    
    function renderRepos() {
        const q=($('#repoFilter').value||'').toLowerCase();
        const frag = document.createDocumentFragment();
        (S.repos||[])
            .filter(r=>(r.full_name||'').toLowerCase().includes(q))
            .forEach(r => {
                const b = document.createElement('button');
                b.className = 'repo-item';
                b.onclick = () => selectRepo(r.full_name);
                b.innerHTML = `<span class="repo-name">${isRecent(r.pushed_at)?'<span class="status-indicator"></span>':''}${esc(r.full_name)}</span><span class="repo-meta">${r.pushed_at?('pushed '+ago(new Date(r.pushed_at))):''}</span>`;
                if (S.repo === r.full_name) { b.classList.add('selected'); }
                frag.appendChild(b);
            });
        repoList.innerHTML = '';
        repoList.appendChild(frag);
    }
    
    async function selectRepo(repo) {
      try {
        S.repo=repo; 
        document.querySelectorAll('.repo-item.selected').forEach(el => el.classList.remove('selected'));
        const currentRepoEl = Array.from(document.querySelectorAll('.repo-item')).find(el => el.textContent.includes(repo));
        if (currentRepoEl) currentRepoEl.classList.add('selected');

        branchesBox.textContent='...'; 
        detailBox.innerHTML = ''; 
        S.selCommit=null;

        // 안전하게 초기화
        updateSecuritySummary('unknown');

        const res = await api('/api/branches',{repo});
        S.branches[repo] = res.branches || [];
        renderBranches(repo);
      } catch (e) {
        console.error('Failed to load branches:', e);
        branchesBox.textContent = `브랜치를 불러오는 중 오류: ${e.message}`;
      }
    };
    
    function renderBranches(repo) {
        const list=S.branches[repo]||[];
        const frag = document.createDocumentFragment();
        if(!list.length) {
            branchesBox.textContent = '브랜치가 없습니다.';
            return;
        }
        list.forEach(b => {
            const key=`${repo}|${b.name}`; 
            const open=S.opened.has(key);
            const branchEl = document.createElement('div');
            branchEl.className = 'branch';
            branchEl.innerHTML = `<div class="branch-head"><b class="monospace">${isRecent(b.last_commit_date)?'<span class="status-indicator"></span>':''}${esc(b.name)}</b><span class="sha-tag">${(b.sha||'').slice(0,7)}</span><button>${open?'닫기':'열기'}</button></div><div class="panel" ${open?'':'style="display:none"'}></div>`;
            
            const btn = branchEl.querySelector('button');
            const panel = branchEl.querySelector('.panel');

            btn.addEventListener('click', async () => {
                if (panel.style.display==='none') { 
                    S.opened.add(key); 
                    btn.textContent='닫기'; 
                    panel.style.display=''; 
                    await loadCommits(key, panel); 
                } else { 
                    S.opened.delete(key); 
                    btn.textContent='열기'; 
                    panel.style.display='none'; 
                }
            });

            if(open) loadCommits(key, panel);

            frag.appendChild(branchEl);
        });
        branchesBox.innerHTML = '';
        branchesBox.appendChild(frag);
    }

    function highlightSelectedCommit() {
        document.querySelectorAll('.commit.selected').forEach(el => el.classList.remove('selected'));
        if (!S.selCommit) return;
        document.querySelectorAll('.commit').forEach(el => {
            if (el.dataset.repo === S.selCommit.repo && el.dataset.sha === S.selCommit.sha) {
                el.classList.add('selected');
            }
        });
    }

    async function loadCommits(key, panel) {
      try {
        const [repo, branch] = key.split('|');   // ← 핵심 분리
        panel.textContent='...';
        const d=await api('/api/commits',{repo,branch});
        const frag = document.createDocumentFragment();
        (d.commits||[]).forEach(c => {
            const commitEl = document.createElement('div');
            commitEl.className = 'commit';
            commitEl.dataset.repo = repo;
            commitEl.dataset.sha = c.sha;
            commitEl.onclick = () => showCommit(repo, c.sha);
            commitEl.innerHTML = `<div class="commit-info"><div class="msg">${isRecent(c.date)?'<span class="status-indicator"></span>':''}${esc(c.message)}</div><div class="meta">${esc(c.author)} · ${ago(new Date(c.date))}</div></div><div class="monospace sha">${c.sha.slice(0,7)}</div>`;
            if (S.selCommit && S.selCommit.repo === repo && S.selCommit.sha === c.sha) { commitEl.classList.add('selected'); }
            frag.appendChild(commitEl);
        });
        panel.innerHTML = '';
        panel.appendChild(frag);

        highlightSelectedCommit();
      } catch (e) {
        console.error('Failed to load commits:', e);
        panel.textContent = `커밋을 불러오는 중 오류: ${e.message}`;
      }
    }

    async function showCommit(repo, sha) {
        S.selCommit = { repo, sha };
        highlightSelectedCommit();
        detailBox.textContent='...';
        updateSecuritySummary('loading');
        
        try{
          const [details, security] = await Promise.all([
              api('/api/commit_detail', {repo, sha}),
              api('/api/security_status', {repo, ref: sha})
          ]);
          detailBox.innerHTML = `<div class="field"><h3>제목</h3><div class="val">${esc(details.message.split('\n')[0])}</div></div><div class="field"><h3>작성자</h3><div class="val">${esc(details.author)}</div></div><div class="field"><h3>SHA</h3><div class="val monospace">${sha.slice(0,12)}...</div></div>`;
          updateSecuritySummary(security);
        }catch(e){
          console.error('Failed to load commit detail/security:', e);
          detailBox.innerHTML = `<div style="color:#b91c1c">상세 조회 중 오류: ${e.message}</div>`;
          updateSecuritySummary('unknown');
        }
    }

    // ✅ 방어 로직 보강
    function updateSecuritySummary(data) {
        btnDetails.disabled = true;

        const isLoading = data === 'loading';
        const isUnknownInput =
          data === 'unknown' ||
          !data ||
          typeof data !== 'object' ||
          !('defender' in data) ||
          !('sentinel' in data) ||
          !('bricks' in data);

        if (isLoading || isUnknownInput) {
            securityCard.className = 'card status-unknown';
            statusIcon.innerHTML = ICONS.unknown;
            summaryTitle.textContent = isLoading ? '보안 현황 분석 중...' : '통합 보안 현황';
            summaryText.textContent = isLoading ? '잠시만 기다려 주세요.' : '분석할 커밋을 선택하세요.';
            return;
        }

        const statuses = [data.defender?.status, data.sentinel?.status, data.bricks?.status].filter(Boolean);
        if (statuses.length === 0) {
            securityCard.className = 'card status-unknown';
            statusIcon.innerHTML = ICONS.unknown;
            summaryTitle.textContent = '통합 보안 현황';
            summaryText.textContent = '분석할 커밋을 선택하세요.';
            return;
        }

        const overallStatus = statuses.includes('bad') ? 'bad' : statuses.includes('warn') ? 'warn' : 'good';
        const issues = statuses.filter(s => s === 'bad' || s === 'warn').length;

        securityCard.className = `card status-${overallStatus}`;
        statusIcon.innerHTML = ICONS[overallStatus];
        statusIcon.style.backgroundColor = `var(--status-${overallStatus}-icon)`;
        statusIcon.style.color = `var(--status-${overallStatus}-bg)`;
        
        summaryTitle.textContent = {good: '양호', warn: '주의 필요', bad: '심각'}[overallStatus];
        summaryText.textContent = issues > 0 ? `${issues}개 항목 확인 필요` : '모든 항목이 안전합니다.';
        btnDetails.disabled = false;
    }

    async function refreshAll() {
        if (refreshInFlight) { return; }
        refreshInFlight = true;
        if (btnSync) { btnSync.disabled = true; }

        const prevRepo = S.repo;
        const prevSelCommit = S.selCommit ? { ...S.selCommit } : null;
        const prevOpened = new Set(S.opened);

        try {
            await loadRepos();

            if (prevRepo) {
                try {
                    const branchRes = await api('/api/branches', { repo: prevRepo });
                    S.branches[prevRepo] = branchRes.branches || [];

                    const validKeys = new Set((S.branches[prevRepo] || []).map(b => `${prevRepo}|${b.name}`));
                    const merged = new Set();
                    prevOpened.forEach(key => {
                        if (key.startsWith(`${prevRepo}|`)) {
                            if (validKeys.has(key)) { merged.add(key); }
                        } else {
                            merged.add(key);
                        }
                    });
                    S.opened = merged;

                    S.selCommit = prevSelCommit;
                    renderBranches(prevRepo);

                    if (prevSelCommit && prevSelCommit.repo === prevRepo) {
                        try {
                            await showCommit(prevSelCommit.repo, prevSelCommit.sha);
                        } catch (commitErr) {
                            console.error('Failed to refresh selected commit:', commitErr);
                            S.selCommit = null;
                            highlightSelectedCommit();
                        }
                    } else {
                        highlightSelectedCommit();
                    }
                } catch (branchErr) {
                    console.error('Failed to refresh branches:', branchErr);
                }
            }

            stamp(repoStamp);
        } catch (err) {
            console.error('Failed to refresh dashboard:', err);
        } finally {
            if (btnSync) { btnSync.disabled = false; }
            refreshInFlight = false;
        }
    }
    
    // --- Init & Helpers ---
    document.addEventListener('DOMContentLoaded', () => {
        refreshAll().catch(err => console.error('Initial refresh failed:', err));
        setInterval(() => {
            refreshAll().catch(err => console.error('Auto refresh failed:', err));
        }, REFRESH_INTERVAL_MS);
    });
    $('#repoFilter').addEventListener('input', renderRepos);
    btnSync.addEventListener('click', () => refreshAll());
    btnDetails.addEventListener('click', () => {
        if (S.selCommit) {
            window.location.href = `/details?repo=${S.selCommit.repo}&sha=${S.selCommit.sha}`;
        }
    });

    function stamp(el){ const now=new Date().toLocaleString('ko-KR',{hour12:false}); el.textContent=`마지막 새로 고침: ${now}`; }
    function esc(s){return (s||'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m]));}
    function isRecent(d) { return d && (Date.now() - new Date(d).getTime()) < 180000*10; }
    function ago(d){const s=(Date.now()-new Date(d).getTime())/1000; if(s<60)return'방금 전';if(s<3600)return`${Math.floor(s/60)}분 전`;if(s<86400)return`${Math.floor(s/3600)}시간 전`;return`${Math.floor(s/86400)}일 전`;}
    
  })();
  </script>
</body>
</html>

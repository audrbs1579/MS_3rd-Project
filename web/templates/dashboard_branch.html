<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>대시보드</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='14' font-size='14'>⌘</text></svg>">
  <style>
    :root{
      --bg:#241026; --panel:#2d1530; --panel2:#371a3a;
      --fg:#f0e9f3; --muted:#bcaec5; --border:#7b4b85; --accent:#ffd166;
      --vh:100vh;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);
      font-family:ui-monospace, "Fira Code", Consolas, Menlo, monospace; font-size:14px; line-height:1.45; height:100%;}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:1280px;margin:0 auto;padding:16px}
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-bottom:10px}
    .toolbar-left{display:flex;gap:8px;align-items:center;flex:1 1 480px}
    .toolbar-right{display:flex;gap:8px;align-items:center}
    .input{width:100%;padding:10px 12px;border:1px solid var(--border);background:transparent;color:var(--fg);border-radius:8px;outline:none}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border:1px solid var(--border);border-radius:8px;background:var(--panel2);color:var(--fg);cursor:pointer;font-weight:600}
    .btn:hover{filter:brightness(1.05)}
    .row{display:grid;grid-template-columns:340px 1fr 420px;gap:14px;height:calc(var(--vh) - 74px);min-height:420px}
    .card{display:flex;flex-direction:column;border:1px solid var(--border);border-radius:10px;background:var(--panel);min-height:0}
    .card h2{margin:0;padding:10px 12px;background:var(--panel2);border-bottom:1px solid var(--border);font-size:14px}
    .body{padding:10px 12px;overflow:auto;min-height:0;display:flex;flex-direction:column;gap:8px}
    .stamp{color:var(--muted);font-size:12px}
    .repo-item{display:flex;justify-content:space-between;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--border);border-radius:8px;background:transparent;cursor:pointer}
    .repo-item:hover{background:#3a1940}
    .repo-name{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:220px}
    .repo-meta{color:var(--muted);font-size:12px}
    .branch{border:1px solid var(--border);border-radius:10px;overflow:hidden}
    .branch-head{display:grid;grid-template-columns:1fr auto auto;gap:8px;align-items:center;background:#321737;padding:8px 10px;border-bottom:1px solid var(--border)}
    .tag{color:var(--muted);border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px}
    .panel{padding:8px 10px;max-height:38vh;overflow:auto}
    .commit{display:grid;grid-template-columns:1fr auto;gap:8px;border:1px solid var(--border);border-radius:8px;padding:8px;margin-bottom:8px;cursor:pointer}
    .commit:hover{background:#3a1940}
    .sha{color:var(--muted)}
    /* ----- 상세: 세로(레이블 위, 값 아래) ----- */
    .detail{display:flex;flex-direction:column;gap:10px}
    .field{border:1px solid var(--border);border-radius:8px;overflow:hidden}
    .field h3{margin:0;padding:8px 10px;background:var(--panel2);border-bottom:1px solid var(--border);font-size:13px;color:var(--muted)}
    .field .val{padding:10px}
    .plus{color:#18c36e}.minus{color:#ff5a5f}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="toolbar">
      <div class="toolbar-left">
        <input id="repoFilter" class="input" placeholder="리포지토리 검색 (owner/name)..." />
      </div>
      <div class="toolbar-right">
        <button id="btnSync" class="btn">새로고침</button>
        <a class="btn" href="{{ url_for('logout') }}">로그아웃</a>
        <span style="color:var(--muted)">로그인 사용자: <b id="userId">{{ user_id }}</b></span>
      </div>
    </div>

    <div class="row">
      <section class="card">
        <h2>나의 리포지토리</h2>
        <div class="body">
          <div id="repoStamp" class="stamp"></div>
          <div id="repoList"></div>
        </div>
      </section>

      <section class="card">
        <h2>브랜치 & 커밋</h2>
        <div class="body">
          <div id="branchStamp" class="stamp"></div>
          <div id="branches">리포를 선택하세요.</div>
        </div>
      </section>

      <section class="card">
        <h2>커밋 상세</h2>
        <div class="body">
          <div id="detailStamp" class="stamp"></div>
          <div id="detail" class="detail">
            <div class="field"><h3>안내</h3><div class="val">왼쪽 커밋을 선택하세요.</div></div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
  (()=>{ // 안전한 단일 초기화
    const $ = (s,el=document)=>el.querySelector(s);
    const $$= (s,el=document)=>Array.from(el.querySelectorAll(s));

    // ----- 높이 동기화 -----
    const setVH = ()=>document.documentElement.style.setProperty('--vh', window.innerHeight + 'px');
    window.addEventListener('resize', setVH); setVH();

    function syncPanels(){
      const mid = $$('.body')[1]; if(!mid) return;
      const H = mid.clientHeight; const panels = $$('.panel');
      panels.forEach(p=>p.style.maxHeight = (panels.length>1? Math.max(120, H*0.38): Math.max(160, H*0.82))+'px');
    }
    window.addEventListener('resize', syncPanels);
    window.__syncCommitPanelHeights = syncPanels;

    // ----- 상태 -----
    const S = { repos:[], repo:null, branches:{}, commits:{}, opened:new Set(), selCommit:null };

    // ----- DOM -----
    const repoList = $('#repoList'), repoStamp=$('#repoStamp');
    const branchBox = $('#branches'), branchStamp=$('#branchStamp');
    const detailBox = $('#detail'), detailStamp=$('#detailStamp');
    const filter = $('#repoFilter'), btnSync = $('#btnSync');

    filter.addEventListener('input', renderRepos);
    btnSync.addEventListener('click', refreshAll);
    document.addEventListener('DOMContentLoaded', init);

    async function init(){ await loadRepos(); stampAll(); setInterval(refreshAll, 60000); }

    function stamp(el){ const now=new Date().toLocaleString('ko-KR',{hour12:false,timeZone:'Asia/Seoul'}); el.textContent=`마지막 새로 고침: ${now} (KST)`; }
    function stampAll(){ [repoStamp,branchStamp,detailStamp].forEach(x=>x&&stamp(x)); }

    async function api(path, params={}){
      const qs = new URLSearchParams(params); const url = path + (qs.toString()?`?${qs}`:'');
      const r = await fetch(url); if(!r.ok){ if(r.status===401) location.href="{{ url_for('index') }}"; throw new Error(r.statusText); }
      return r.json();
    }

    // ----- Repos -----
    async function loadRepos(){ const d=await api('/api/my_repos'); S.repos=d.repos||[]; renderRepos(); stamp(repoStamp); }
    function renderRepos(){
      const q=(filter.value||'').toLowerCase(); const frag=document.createDocumentFragment();
      (S.repos||[]).filter(r=>(r.full_name||'').toLowerCase().includes(q)).forEach(r=>{
        const b=document.createElement('button'); b.className='repo-item';
        b.innerHTML=`<span class="repo-name">${esc(r.full_name||r.name)}</span><span class="repo-meta">${r.pushed_at?('pushed '+ago(new Date(r.pushed_at))):''}</span>`;
        b.onclick=()=>selectRepo(r.full_name); frag.appendChild(b);
      });
      repoList.replaceChildren(frag);
    }

    async function selectRepo(repo){
      S.repo=repo; branchBox.textContent='브랜치 불러오는 중...';
      const d=await api('/api/branches',{repo}); S.branches[repo]=(d.branches||[]).sort((a,b)=>a.name.localeCompare(b.name));
      renderBranches(); stamp(branchStamp); requestAnimationFrame(syncPanels);
    }

    // ----- Branches / Commits -----
    function renderBranches(){
      const repo=S.repo; const list=S.branches[repo]||[]; if(!list.length){branchBox.textContent='브랜치가 없습니다.';return;}
      const frag=document.createDocumentFragment();
      list.forEach(b=>{
        const key=`${repo}|${b.name}`; const open=S.opened.has(key);
        const wrap=document.createElement('div'); wrap.className='branch';
        wrap.innerHTML=`
          <div class="branch-head">
            <div><b>${esc(b.name)}</b></div>
            <span class="tag">${(b.sha||'').slice(0,7)}</span>
            <button class="btn btn-sm">${open?'닫기':'열기'}</button>
          </div>
          <div class="panel" ${open?'':'style="display:none"'}></div>`;
        const btn = $('button', wrap), panel=$('.panel', wrap);
        btn.onclick=async ()=>{
          if(panel.style.display==='none'){ S.opened.add(key); btn.textContent='닫기'; panel.style.display=''; await loadCommits(repo,b.name,panel);}
          else{ S.opened.delete(key); btn.textContent='열기'; panel.style.display='none'; }
          requestAnimationFrame(syncPanels);
        };
        if(open) loadCommits(repo,b.name,panel).catch(()=>{});
        frag.appendChild(wrap);
      });
      branchBox.replaceChildren(frag);
    }

    async function loadCommits(repo, branch, panel){
      panel.textContent='커밋 불러오는 중...';
      const d=await api('/api/commits',{repo,branch}); const items=d.commits||[];
      const frag=document.createDocumentFragment();
      items.forEach(c=>{
        const row=document.createElement('div'); row.className='commit';
        row.innerHTML=`<div><div>${esc(c.message||'(no message)')}</div><div class="repo-meta">${esc(c.author||'')} · ${c.date?ago(new Date(c.date)):''}</div></div><div class="sha">${(c.sha||'').slice(0,7)}</div>`;
        row.onclick=()=>showCommit(repo,c.sha); frag.appendChild(row);
      });
      panel.replaceChildren(frag);
    }

    // ----- Detail: 세로 배치 -----
    async function showCommit(repo, sha){
      S.selCommit={repo,sha}; detailBox.innerHTML='<div class="field"><h3>로딩</h3><div class="val">상세 불러오는 중...</div></div>';
      const d=await api('/api/commit_detail',{repo,sha});
      const files=(d.files||[]).slice(0,50).map(f=>{
        const diff=(f.additions||0)-(f.deletions||0);
        const s = diff>=0?`<span class="plus">+${diff}</span>`:`<span class="minus">${diff}</span>`;
        return `<div class="field"><h3>${esc(f.filename)}</h3><div class="val">${esc(f.status||'')} · +${f.additions||0} / -${f.deletions||0} (${s})</div></div>`;
      }).join('');

      detailBox.innerHTML = `
        <div class="field"><h3>제목</h3><div class="val">${esc((d.message||'').split('\n')[0])}</div></div>
        <div class="field"><h3>작성자</h3><div class="val">${esc(d.author||'')}</div></div>
        <div class="field"><h3>날짜(KST)</h3><div class="val">${d.date?new Date(d.date).toLocaleString('ko-KR',{hour12:false,timeZone:'Asia/Seoul'}):''}</div></div>
        <div class="field"><h3>SHA</h3><div class="val">${esc(d.sha||'')}</div></div>
        <div class="field"><h3>변경</h3><div class="val">총 ${d.stats?.total??0} (<span class="plus">+${d.stats?.additions??0}</span> / <span class="minus">-${d.stats?.deletions??0}</span>)</div></div>
        <div class="field"><h3>GitHub에서 보기</h3><div class="val"><a href="${d.html_url}" target="_blank" rel="noopener">열기</a></div></div>
        <div class="field"><h3>Files (상위)</h3><div class="val">${files || '없음'}</div></div>`;
      stamp(detailStamp);
    }

    // ----- 주기 갱신 -----
    async function refreshAll(){
      await loadRepos();
      if (S.repo){ // 열려있는 브랜치 유지 갱신
        const d=await api('/api/branches',{repo:S.repo}); S.branches[S.repo]=(d.branches||[]).sort((a,b)=>a.name.localeCompare(b.name));
        renderBranches();
        for (const key of [...S.opened]) {
          const [repo,branch]=key.split('|'); const card=[...$$('.branch')].find(x=>$('.branch-head b',x)?.textContent===branch);
          if(card){ const panel=$('.panel',card); await loadCommits(repo,branch,panel); }
        }
      }
      if (S.selCommit){ await showCommit(S.selCommit.repo, S.selCommit.sha); }
      stampAll(); requestAnimationFrame(syncPanels);
    }

    // ----- helpers -----
    function esc(s){return (s||'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m]));}
    function ago(d){const s=Math.floor((Date.now()-d.getTime())/1000); if(s<5)return'방금'; const u=[['일',86400],['시간',3600],['분',60]]; for(const[k,t]of u){const v=Math.floor(s/t); if(v>=1)return`${v}${k} 전`;} return`${s}초 전`; }
  })();
  </script>
</body>
</html>

<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>Branch Activity – {{ user_id }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --bg:#f7f7f8; --panel:#ffffff; --text:#222; --muted:#6b7280; --border:#e5e7eb;
      --ring:#3b82f6; --accent:#ff9500; --chip:#f1f5f9; --chip-border:#e2e8f0;
      --shadow-sm:0 1px 8px rgba(0,0,0,.05); --shadow-md:0 6px 24px rgba(0,0,0,.08);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0c0d0f; --panel:#121317; --text:#eaeaea; --muted:#a6adbb; --border:#23262d;
        --ring:#60a5fa; --accent:#ffb86b; --chip:#151821; --chip-border:#222630;
        --shadow-sm:0 1px 8px rgba(0,0,0,.6); --shadow-md:0 6px 24px rgba(0,0,0,.55);
      }
    }
    *{box-sizing:border-box}
    html,body{font-family:Tahoma, Arial, sans-serif;margin:0;padding:0;background:var(--bg);color:var(--text)}
    a{color:inherit}
    code{font-family:ui-monospace,Consolas,monaco,monospace}

    header,footer{
      padding:10px 14px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;justify-content:space-between;background:var(--panel)
    }
    footer{border-top:1px solid var(--border);border-bottom:none;color:var(--muted)}
    header strong{font-weight:700}
    .muted{color:var(--muted);font-size:12px}

    main{
      display:grid;grid-template-columns:320px 1fr 1fr;gap:14px;padding:14px;max-width:1400px;margin:0 auto
    }
    @media (max-width: 1080px){
      main{grid-template-columns:1fr;gap:12px}
    }
    .col{
      border:1px solid var(--border);border-radius:12px;background:var(--panel);padding:12px;box-shadow:var(--shadow-sm)
    }
    h2{margin:0 0 10px 0;font-size:15px;letter-spacing:.2px}
    input[type=text]{
      width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:transparent;color:inherit;
      outline:none;transition:border .15s ease, box-shadow .15s ease
    }
    input[type=text]:focus{border-color:var(--ring);box-shadow:0 0 0 3px color-mix(in oklab, var(--ring) 25%, transparent)}
    .btn{
      padding:8px 12px;border:1px solid var(--text);border-radius:10px;background:transparent;cursor:pointer;transition:.15s ease;font-weight:600
    }
    .btn:hover{background:color-mix(in oklab, var(--text) 6%, transparent)}
    .btn:focus{outline:3px solid var(--ring);outline-offset:2px}

    /* Chips */
    .repo-chip{
      display:inline-block;margin:6px 6px 0 0;padding:8px 12px;border:1px solid var(--chip-border);
      border-radius:999px;cursor:pointer;background:var(--chip);transition:.15s ease;font-size:13px
    }
    .repo-chip:hover{transform:translateY(-1px);box-shadow:var(--shadow-sm)}
    .repo-chip:focus{outline:3px solid var(--ring);outline-offset:2px}

    /* Branch & commits */
    .branch-row{padding:8px 4px;border-bottom:1px dashed var(--border)}
    .tag{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;margin-left:6px;background:rgba(0,0,0,.03)}
    .date-head{
      margin:12px 0 8px 0;padding:10px 12px;border-radius:10px;background:var(--accent);
      color:#fff;display:flex;align-items:center;justify-content:space-between
    }
    .commit-panel{border:1px dashed var(--border);border-radius:10px;padding:10px;max-height:420px;overflow:auto;background:color-mix(in oklab, var(--panel) 80%, var(--bg))}
    .commit-item{
      display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border);border-radius:10px;
      padding:10px;margin:8px 0;background:var(--panel);box-shadow:var(--shadow-sm);transition:.15s ease
    }
    .commit-item:hover{transform:translateY(-1px);box-shadow:var(--shadow-md)}
    .sha{font-family:ui-monospace,Consolas,monospace;font-size:12px;border:1px solid var(--border);border-radius:999px;padding:2px 8px}
    .green-dot{display:inline-block;width:10px;height:10px;border-radius:50%;background:#28a745;margin-right:6px;box-shadow:0 0 0 3px rgba(40,167,69,.15)}
    .detail{white-space:pre-wrap;line-height:1.6}

    /* Small helpers */
    .row-head{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .kicker{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<header>
  <div><strong>Branch Activity – {{ user_id }}</strong> <span class="muted">KST로 표시 / 클릭 시에만 조회</span></div>
  <div>
    <button id="btnSync" class="btn">동기화(로그인 유지)</button>
    <a class="btn" href="{{ url_for('logout') }}">Logout</a>
  </div>
</header>

<main>
  <!-- Repositories -->
  <section class="col">
    <h2>Repositories</h2>
    <input id="repoFilter" type="text" placeholder="owner/repo 필터">
    <div id="repoList" style="margin-top:8px"></div>
  </section>

  <!-- Days & Branches -->
  <section class="col">
    <h2>Branches</h2>
    <div class="kicker">브랜치를 클릭해 커밋 패널을 열고 조회하세요.</div>
    <div id="dayBranch" style="margin-top:8px"></div>
  </section>

  <!-- Commit Detail -->
  <section class="col">
    <h2>Commit Detail</h2>
    <div id="detail" class="kicker">왼쪽에서 커밋을 선택하세요.</div>
  </section>
</main>

<footer>
  <span class="muted">© dashboard</span>
</footer>

<script>
  const USER_ID = "{{ user_id }}";

  // -------------- DOM 헬퍼 --------------
  const qs = (s, el=document)=>el.querySelector(s);
  const qsa = (s, el=document)=>Array.from(el.querySelectorAll(s));
  const elRepoList = qs('#repoList');
  const elDayBranch = qs('#dayBranch');
  const elDetail = qs('#detail');
  const elRepoFilter = qs('#repoFilter');

  // -------------- 상태 --------------
  let allRepos = [];        // API로 가져온 전체 repo
  let selectedRepo = null;  // "owner/repo"
  let branchesCache = {};   // { repo : [ {name, sha}, ... ] }
  let commitsCache = {};    // { repo|branch : [ commits ] }

  // -------------- 초기화 --------------
  document.addEventListener('DOMContentLoaded', async () => {
    await loadRepos();
    wireEvents();
  });

  function wireEvents() {
    elRepoFilter.addEventListener('input', renderRepos);
    qs('#btnSync').addEventListener('click', async ()=>{
      await loadRepos(true);
    });
  }

  // -------------- API 호출 --------------
  async function apiGet(url, params={}) {
    const q = new URLSearchParams(params);
    const res = await fetch(url + (q.toString() ? `?${q}` : ''));
    if (!res.ok) {
      let err = await res.text();
      throw new Error(err || res.statusText);
    }
    return res.json();
  }

  async function loadRepos(force=false) {
    const data = await apiGet('/api/my_repos');
    allRepos = data.repos || [];
    renderRepos();
    if (force) {
      branchesCache = {};
      commitsCache = {};
      elDayBranch.innerHTML = '';
      elDetail.textContent = '왼쪽에서 커밋을 선택하세요.';
    }
  }

  function renderRepos() {
    const f = (elRepoFilter.value || '').toLowerCase();
    elRepoList.innerHTML = '';
    allRepos
      .filter(r => (r.full_name||'').toLowerCase().includes(f))
      .forEach(r => {
        const chip = document.createElement('button');
        chip.className = 'repo-chip';
        chip.textContent = r.name || r.full_name;
        chip.title = r.full_name;
        chip.onclick = ()=>selectRepo(r.full_name);
        elRepoList.appendChild(chip);
      });
  }

  async function selectRepo(full_name) {
    selectedRepo = full_name;
    elDayBranch.innerHTML = '브랜치 불러오는 중...';

    if (!branchesCache[full_name]) {
      const data = await apiGet('/api/branches', {repo: full_name});
      branchesCache[full_name] = data.branches || [];
    }
    const branches = branchesCache[full_name];

    const wrap = document.createElement('div');
    if (!branches.length) {
      wrap.textContent = '브랜치 없음';
      elDayBranch.replaceChildren(wrap);
      return;
    }

    branches.forEach(b => {
      const row = document.createElement('div');
      row.className = 'branch-row';

      const head = document.createElement('div');
      head.className = 'row-head';
      head.innerHTML = `
        <div>
          <strong>${b.name}</strong>
          <span class="tag">C ?</span>
        </div>
        <button class="btn">열기</button>
      `;

      const panel = document.createElement('div');
      panel.className = 'commit-panel';
      panel.style.display = 'none';
      panel.textContent = '커밋을 불러오려면 "열기"를 누르세요.';

      head.querySelector('.btn').onclick = async () => {
        const opened = panel.style.display !== 'none';
        if (opened) {
          panel.style.display = 'none';
          head.querySelector('.btn').textContent = '열기';
          return;
        }
        head.querySelector('.btn').textContent = '닫기';
        panel.style.display = 'block';
        await loadCommitsForBranch(full_name, b.name, panel, head);
      };

      row.appendChild(head);
      row.appendChild(panel);
      wrap.appendChild(row);
    });

    elDayBranch.replaceChildren(wrap);
  }

  async function loadCommitsForBranch(repo, branch, panel, headEl) {
    panel.innerHTML = '조회 중...';

    const key = `${repo}|${branch}`;
    if (!commitsCache[key]) {
      const data = await apiGet('/api/commits', {repo, branch});
      commitsCache[key] = data.commits || [];
    }
    const commits = commitsCache[key];

    const tag = headEl.querySelector('.tag');
    tag.textContent = `C ${commits.length}`;

    if (!commits.length) {
      panel.textContent = '커밋 없음';
      return;
    }

    panel.innerHTML = '';
    const now = Date.now();
    commits.forEach(c => {
      const item = document.createElement('div');
      item.className = 'commit-item';

      const isFresh = (() => {
        if (!c.date) return false;
        const d = new Date(c.date).getTime();
        return (now - d) <= 3 * 60 * 1000; // 3분
      })();

      const left = document.createElement('div');
      left.style.display = 'flex';
      left.style.alignItems = 'center';
      left.style.gap = '6px';
      left.innerHTML = `
        ${isFresh ? '<span class="green-dot" title="3분 이내"></span>' : ''}
        <span>${escapeHtml(c.message || '(no message)')}</span>
      `;

      const right = document.createElement('div');
      right.innerHTML = `<span class="sha">${(c.sha || '').slice(0,7)}</span>`;

      item.appendChild(left);
      item.appendChild(right);

      item.onclick = ()=>showCommitDetail(repo, c.sha);
      panel.appendChild(item);
    });
  }

  async function showCommitDetail(repo, sha) {
    elDetail.textContent = '상세 조회 중...';
    const d = await apiGet('/api/commit_detail', {repo, sha});

    let kst = '';
    if (d.date) {
      kst = new Date(d.date).toLocaleString("ko-KR", {
        timeZone: "Asia/Seoul",
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit"
      });
    }

    const files = d.files || [];
    const stats = d.stats || {};

    const html = `
      <div class="detail">
        <div><strong>${escapeHtml(d.message || '')}</strong></div>
        <div class="muted" style="margin:6px 0">${escapeHtml(d.author||'')} • ${kst}</div>
        <div style="margin:6px 0">SHA: <code>${d.sha}</code> · <a href="${d.html_url}" target="_blank" rel="noopener">GitHub에서 보기</a></div>
        <div style="margin:6px 0">총 변경: ${stats.total ?? 0} (+${stats.additions ?? 0} / -${stats.deletions ?? 0})</div>
        <hr style="border:none;border-top:1px solid var(--border)">
        <div><strong>Files</strong></div>
        <ul style="margin:8px 0 0 18px;padding:0">
          ${files.map(f => `
            <li>${escapeHtml(f.filename)} — ${f.status} (+${f.additions} / -${f.deletions})</li>
          `).join("")}
        </ul>
      </div>
    `;
    elDetail.innerHTML = html;
  }

  function escapeHtml(s){
    return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
</script>
</body>
</html>

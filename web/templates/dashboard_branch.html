<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Project Guardian - Branch Activity (Basic)</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; font-size: 14px; margin: 0; }
    header, footer { background: #f2f2f2; padding: 8px 12px; border-bottom: 1px solid #ddd; }
    footer { border-top: 1px solid #ddd; border-bottom: none; position: sticky; bottom: 0; }
    main { display: grid; grid-template-columns: 260px 1fr 420px; gap: 8px; padding: 8px; height: calc(100vh - 90px); box-sizing: border-box; }
    section { border: 1px solid #ddd; border-radius: 4px; display: flex; flex-direction: column; min-height: 0; }
    section > h3 { margin: 0; padding: 8px; border-bottom: 1px solid #eee; background: #fafafa; font-size: 14px; }
    .content { padding: 8px; overflow: auto; }
    .row { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 6px 8px; border: 1px solid #eee; border-radius: 4px; margin-bottom: 6px; background: #fff; cursor: pointer; }
    .row:hover { background: #f9f9f9; }
    .muted { color: #666; font-size: 12px; }
    .mono { font-family: ui-monospace, Menlo, Consolas, monospace; }
    .btn { padding: 6px 10px; border: 1px solid #ccc; background: #fff; cursor: pointer; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .input { padding: 6px 8px; border: 1px solid #ccc; }
    details summary { list-style: none; cursor: pointer; }
    details summary::-webkit-details-marker { display: none; }
    details .child { margin: 6px 0 10px 16px; }
    .pill { font-size: 12px; border: 1px solid #c9defc; padding: 1px 6px; border-radius: 999px; background: #eef6ff; color: #225ea8; }
    .error { color: #b00020; white-space: pre-wrap; }
    .hr { height:1px; background:#eee; margin:8px 0; }
    .empty { color:#666; }
  </style>
</head>
<body>
  <header>
    <strong>{{ user_id }}</strong>
    <span class="muted">/ Branch Activity (Basic)</span>
  </header>

  <main>
    <!-- 좌측: 레포 선택 -->
    <section>
      <h3>Repositories</h3>
      <div class="content">
        <div style="display:flex; gap:6px; margin-bottom:8px;">
          <input id="repoFilter" class="input" placeholder="owner/repo 필터" style="flex:1;">
          <button id="btnResync" class="btn">재동기화</button>
        </div>
        <div id="repoList"></div>
      </div>
    </section>

    <!-- 가운데: 날짜 기준 리스트 -->
    <section>
      <h3>Days & Branches</h3>
      <div class="content">
        <div style="display:flex; gap:6px; margin-bottom:8px;">
          <input id="dayFilter" class="input" placeholder="YYYY-MM-DD / 브랜치" style="flex:1;">
          <button id="btnClear" class="btn">Clear</button>
        </div>
        <div id="daysPanel"><div class="empty">레포를 선택하세요.</div></div>
      </div>
    </section>

    <!-- 우측: 커밋 상세 -->
    <section>
      <h3>Commit Detail</h3>
      <div class="content" id="detailPanel"><div class="empty">커밋을 선택하세요.</div></div>
    </section>
  </main>

  <footer>
    <button id="btnManualRefresh" class="btn">지금 새로고침</button>
    <span class="muted">자동 새로고침: 60초</span>
    <span class="muted" id="lastRefreshed"></span>
  </footer>

  <script>
    // 서버가 주입한 초기 데이터
    const RAW_LOGS = {{ logs|tojson|safe }};
    const USER_REPOS = {{ repos|tojson|safe }};
    const USER_ID = "{{ user_id }}";

    // 상태
    let grouped = groupLogs(RAW_LOGS); // repo -> branch -> [days...]
    let currentRepo = Object.keys(grouped)[0] || (USER_REPOS[0] || null);
    let autoTimer = null;

    // ---- 유틸 ----
    function groupLogs(logs) {
      const map = {};
      for (const r of logs) {
        const repo = r.repo_full_name, br = r.branch;
        (map[repo] ||= {});
        (map[repo][br] ||= []);
        map[repo][br].push(r);
      }
      // 최신 날짜 우선
      for (const repo of Object.keys(map)) {
        for (const br of Object.keys(map[repo])) {
          map[repo][br].sort((a,b)=> b.date.localeCompare(a.date));
        }
      }
      return map;
    }
    function groupByDate(repo) {
      const out = {};
      if (!repo || !grouped[repo]) return out;
      for (const br of Object.keys(grouped[repo])) {
        for (const rec of grouped[repo][br]) (out[rec.date] ||= []).push(rec);
      }
      return Object.fromEntries(Object.entries(out).sort((a,b)=> b[0].localeCompare(a[0])));
    }
    function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]) )}
    function setLastRefreshed() {
      document.getElementById('lastRefreshed').textContent = ' / ' + new Date().toLocaleString();
    }

    // ---- 렌더: 레포 목록 ----
    function renderRepos() {
      const box = document.getElementById('repoList');
      const filter = document.getElementById('repoFilter').value.toLowerCase();
      const fromLogs = Object.keys(grouped);
      const all = Array.from(new Set([...fromLogs, ...(USER_REPOS || [])])).sort();
      if (!all.length) { box.innerHTML = '<div class="empty">레포 없음</div>'; return; }
      box.innerHTML = all
        .filter(r => !filter || r.toLowerCase().includes(filter))
        .map(r => {
          const latest = grouped[r] ? (Object.values(grouped[r]).map(a=>a[0]?.date).sort().reverse()[0] || '-') : '-';
          return `<div class="row" data-repo="${r}" onclick="selectRepo('${r}')">
                    <span>${r}</span>
                    <span class="pill">latest ${latest}</span>
                  </div>`;
        }).join('');
    }
    window.selectRepo = function(repo) {
      currentRepo = repo;
      renderDays();
    };

    // ---- 렌더: 날짜 기준 (날짜 → 브랜치들; 브랜치 행에 커밋 펼치기) ----
    function renderDays() {
      const panel = document.getElementById('daysPanel');
      if (!currentRepo || !grouped[currentRepo]) { panel.innerHTML = '<div class="empty">레포를 선택하세요.</div>'; return; }
      const filter = document.getElementById('dayFilter').value.toLowerCase();
      const byDate = groupByDate(currentRepo);
      let html = '';
      for (const [day, recs] of Object.entries(byDate)) {
        if (filter && !day.includes(filter)) continue;
        html += `<div class="row" style="cursor:default;"><strong class="mono">${day}</strong><span class="muted">${recs.length} item(s)</span></div>`;
        const seen = new Set();
        for (const r of recs) {
          if (seen.has(r.branch)) continue;
          seen.add(r.branch);
          const rowText = `${r.branch} ${day}`.toLowerCase();
          if (filter && !rowText.includes(filter)) continue;
          html += `
            <details class="row" style="cursor:default;" data-branch="${r.branch}" data-day="${r.date}">
              <summary><span>${r.branch}</span>
                <span class="pill">C ${r.counts.commits}</span>
                <span class="pill">D ${r.counts.dep_changes}</span>
              </summary>
              <div class="child" id="${btoa(currentRepo+'|'+r.branch+'|'+r.date)}">
                <button class="btn" onclick="loadCommits('${currentRepo}','${r.branch}','${r.date}', this)">이 날짜의 커밋 불러오기</button>
              </div>
            </details>
          `;
        }
      }
      panel.innerHTML = html || '<div class="empty">결과 없음</div>';
    }

    // ---- 데이터: 특정 날짜 커밋 전부 로드(최신순) ----
    window.loadCommits = async function(repo, branch, day, btnEl) {
      const hostId = btoa(repo+'|'+branch+'|'+day);
      const host = document.getElementById(hostId);
      btnEl.disabled = true; btnEl.textContent = '불러오는 중…';
      try {
        const q = new URLSearchParams({repo, branch, day}).toString();
        const res = await fetch('/api/commits_by_day?'+q);
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || 'fetch failed');
        if (!Array.isArray(data) || data.length === 0) {
          host.innerHTML = '<div class="empty">커밋 없음</div>'; return;
        }
        host.innerHTML = data.map(c => `
          <div class="row" onclick="loadCommitDetail('${repo}','${c.sha}')">
            <span title="${escapeHtml(c.message||'')}">${escapeHtml(c.message||'')}</span>
            <span class="pill mono">${c.sha.slice(0,7)}</span>
          </div>
        `).join('');
      } catch (e) {
        host.innerHTML = `<div class="error">${escapeHtml(e.message)}</div>`;
      } finally {
        btnEl.disabled = false; btnEl.textContent = '다시 불러오기';
      }
    };

    // ---- 데이터: 커밋 상세 ----
    window.loadCommitDetail = async function(repo, sha) {
      const panel = document.getElementById('detailPanel');
      panel.innerHTML = '<div class="muted">로딩 중…</div>';
      try {
        const q = new URLSearchParams({repo, sha}).toString();
        const res = await fetch('/api/commit_detail?'+q);
        const d = await res.json();
        if (!res.ok) throw new Error(d.error || 'fetch failed');

        const files = (d.files||[]).map(f => `
          <div style="margin-bottom:6px;">
            <div class="mono">${escapeHtml(f.filename)} <span class="muted">(${f.status} +${f.additions}/-${f.deletions})</span></div>
            ${f.patch ? `<pre class="mono" style="white-space:pre-wrap; background:#f7f7f7; border:1px solid #eee; padding:6px;">${escapeHtml(f.patch)}</pre>` : ''}
          </div>`).join('') || '<div class="empty">변경 파일 없음</div>';

        panel.innerHTML = `
          <div><strong>${repo}</strong> <span class="mono">@ ${d.sha.slice(0,7)}</span></div>
          <div class="muted">${escapeHtml(d.author || '')} • ${escapeHtml(d.date || '')}</div>
          <div class="hr"></div>
          <div><strong>Message</strong><div>${escapeHtml(d.message || '')}</div></div>
          <div class="hr"></div>
          <div><strong>Stats</strong>
            <div class="muted">total ${d.stats?.total ?? 0} / +${d.stats?.additions ?? 0} / -${d.stats?.deletions ?? 0}</div>
          </div>
          <div class="hr"></div>
          <div><strong>Files</strong>${files}</div>
          <div class="hr"></div>
          <div><a href="${d.html_url}" target="_blank">GitHub에서 보기</a></div>
        `;
      } catch (e) {
        panel.innerHTML = `<div class="error">${escapeHtml(e.message)}</div>`;
      }
    };

    // ---- 1분마다 자동 새로고침 (현재 선택된 레포만) ----
    async function refreshActiveRepo() {
      if (!currentRepo) return;
      try {
        const url = '/api/branch_logs?'+new URLSearchParams({repo: currentRepo}).toString();
        const res = await fetch(url);
        const items = await res.json();
        if (!res.ok) throw new Error(items.error || 'fetch failed');
        // 현재 레포만 교체해서 다시 그리기
        const tmp = groupLogs(items);
        grouped[currentRepo] = tmp[currentRepo] || {};
        renderDays();
        setLastRefreshed();
      } catch (e) {
        console.warn('auto refresh failed:', e);
      }
    }

    function startAutoRefresh() {
      if (autoTimer) clearInterval(autoTimer);
      autoTimer = setInterval(refreshActiveRepo, 60_000); // 60초
    }

    // ---- 이벤트 바인딩 ----
    document.getElementById('btnResync').onclick = () => location.href = "{{ url_for('sync_my_repos_route') }}";
    document.getElementById('btnManualRefresh').onclick = refreshActiveRepo;
    document.getElementById('btnClear').onclick = () => { document.getElementById('dayFilter').value = ""; renderDays(); };
    document.getElementById('repoFilter').oninput = renderRepos;
    document.getElementById('dayFilter').oninput = renderDays;

    // ---- 초기 렌더 ----
    renderRepos();
    if (currentRepo) selectRepo(currentRepo);
    startAutoRefresh(); setLastRefreshed();
  </script>
</body>
</html>

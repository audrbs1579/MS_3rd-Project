<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Project Guardian - Branch Activity Explorer</title>
  <style>
    /* ===== XP 스타일 ===== */
    body{background-color:#3A6EA5;font-family:Gulim, Dotum, "Tahoma", Geneva, sans-serif;font-size:12px; margin:0; padding:0; overflow:hidden;}
    .desktop{height:100vh;width:100vw;display:grid;grid-template-rows:1fr 30px;}
    .workspace{position:relative;overflow:hidden;padding:10px;}
    .grid{height:100%;display:grid;grid-template-columns: 2fr 10px 2fr 10px 1.5fr;gap:10px;align-items:stretch;}
    .window{border:2px solid #0058E1;border-radius:8px 8px 0 0;background:#ECE9D8;box-shadow:5px 5px 15px rgba(0,0,0,.5);display:flex;flex-direction:column;overflow:hidden;}
    .title-bar{background:linear-gradient(to bottom,#0058E1,#3A85E1);color:#fff;font-weight:bold;padding:6px 8px;display:flex;align-items:center;gap:6px;user-select:none;flex-shrink: 0;}
    .toolbar{display:flex;gap:8px;align-items:center;padding:8px 10px;background:#f5f2e8;border-bottom:1px solid #cfc9b8; flex-shrink: 0;}
    .toolbar input{border:1px solid #000;background:#fff;padding:5px 8px;font-family:inherit;width:240px;}
    .toolbar button, .toolbar a button {border:1px solid #000;background:#ECE9D8;padding:5px 10px;cursor:pointer; font-family: inherit;}
    .content-area { padding:10px;flex-grow:1;overflow:auto;color:#000; }
    .repo-row, .branch-row, .day-row {padding:10px;border:1px solid #ccc;background:#fff;border-radius:4px;display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:8px;cursor:pointer;}
    .repo-row.active, .branch-row.active, .day-row.active { outline:2px solid #3A85E1;background:#f5f9ff; }
    .repo-name, .branch-name, .day-name {font-weight:bold;color:#0058E1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:260px;}
    .chip{font-size:11px;background:#e7eefc;border:1px solid #bfd0f5;padding:1px 6px;border-radius:10px;color:#245edc;white-space:nowrap;}
    .handle{background:#D6D3C6; border:1px solid #9f9a87;border-radius:8px;user-select:none;cursor:col-resize; display:flex; align-items:center; justify-content:center;}
    .detail-content { font-family: 'Malgun Gothic', sans-serif; }
    .detail-header { border-bottom: 1px solid #ccc; padding-bottom: 8px; margin-bottom: 8px; }
    .detail-title { font-size: 14px; font-weight: bold; }
    .detail-meta { font-size: 11px; color: #555; }
    .detail-section { margin-top: 12px; }
    .detail-section h4 { margin: 0 0 5px 0; font-size: 12px; border-bottom: 1px solid #ddd; padding-bottom: 3px; }
    .detail-list { list-style: none; padding-left: 0; margin: 0; font-size: 11px; max-height: 220px; overflow-y: auto; background: #fff; border: 1px solid #ccc; }
    .detail-list li { padding: 4px 6px; border-bottom: 1px solid #eee; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .empty-state, .info-state { padding: 14px; text-align: center; color: #666; background:#fff; border:1px dashed #bbb; border-radius:4px; }
    .taskbar{background:linear-gradient(to bottom,#245EDC,#3A85E1);border-top:1px solid #66A3FF;display:flex;align-items:center;gap:8px;padding:0 6px;}
    .start-button{background:linear-gradient(to bottom,#72BE4A,#55A82B);color:#fff;font-weight:bold;font-size:16px;border:2px outset #55A82B;border-radius:10px 10px 0 0;padding:2px 20px;margin-left:5px;font-style:italic;cursor:pointer;user-select:none;}
    a{color:#0058E1;text-decoration:none;} a:hover{text-decoration:underline;}
  </style>
</head>
<body>
  <div class="desktop">
    <div class="workspace">
      <div class="grid" id="mainGrid">
        <!-- Left: Repositories -->
        <div class="window" id="reposPane">
          <div class="title-bar"><div class="title-text">{{ user_id }}'s Repositories</div></div>
          <div class="toolbar">
            <input id="repoFilter" type="text" placeholder="레포 필터 (owner/repo)" />
            <a href="{{ url_for('logout') }}"><button>Logout</button></a>
          </div>
          <div class="content-area" id="repoList"></div>
        </div>

        <div class="handle" data-splitter-for="1"></div>

        <!-- Middle: Branches & Days -->
        <div class="window" id="branchPane">
          <div class="title-bar"><div class="title-text">Branches / Days</div></div>
          <div class="toolbar">
            <input id="branchFilter" type="text" placeholder="브랜치 또는 날짜(YYYY-MM-DD) 필터" />
            <button id="clearBranchFilter">Clear</button>
          </div>
          <div class="content-area" id="branchAndDays">
            <div class="empty-state">레포를 선택하세요.</div>
          </div>
        </div>

        <div class="handle" data-splitter-for="2"></div>

        <!-- Right: Details -->
        <div class="window" id="detailPane">
          <div class="title-bar"><div class="title-text">Branch Activity Details</div></div>
          <div class="content-area" id="activityDetails">
            <div class="empty-state">좌측에서 브랜치와 날짜를 선택하면 상세가 표시됩니다.</div>
          </div>
        </div>
      </div>
    </div>
    <div class="taskbar"><div class="start-button">start</div></div>
  </div>

  <script>
    // 서버에서 전달됨:
    // logs: branch_log 문서 배열
    // repos: role:user 문서의 repos[] (폴백)
    const RAW_LOGS = {{ logs|tojson|safe }};
    const USER_REPOS = {{ repos|tojson|safe }};
    const userId = "{{ user_id }}";

    // repo -> branch -> [days...]
    function groupLogs(logs) {
      const map = {};
      for (const r of logs) {
        const repo = r.repo_full_name;
        const br = r.branch;
        if (!map[repo]) map[repo] = {};
        if (!map[repo][br]) map[repo][br] = [];
        map[repo][br].push(r);
      }
      Object.keys(map).forEach(repo => {
        Object.keys(map[repo]).forEach(br => {
          map[repo][br].sort((a,b)=> b.date.localeCompare(a.date));
        });
      });
      return map;
    }

    const GROUPED = groupLogs(RAW_LOGS);

    // DOM refs
    const repoListEl = document.getElementById('repoList');
    const branchAndDaysEl = document.getElementById('branchAndDays');
    const activityDetailsEl = document.getElementById('activityDetails');
    const repoFilterEl = document.getElementById('repoFilter');
    const branchFilterEl = document.getElementById('branchFilter');
    const clearBranchFilterBtn = document.getElementById('clearBranchFilter');

    // 레포 렌더(로그 없으면 repos 폴백 사용)
    function renderRepos(filter="") {
      const f = (filter||"").toLowerCase();

      const reposFromLogs = Object.keys(GROUPED);
      const allRepos = Array.from(new Set([ ...reposFromLogs, ...(USER_REPOS || []) ])).sort((a,b)=>a.localeCompare(b));

      const rows = [];
      for (const repo of allRepos) {
        if (f && !repo.toLowerCase().includes(f)) continue;

        const hasLogs = !!GROUPED[repo];
        const latest = hasLogs ? (Object.values(GROUPED[repo]).map(arr=>arr[0]?.date).sort().reverse()[0] || "-") : "-";
        const totalBranches = hasLogs ? Object.keys(GROUPED[repo]).length : 0;

        rows.push(`
          <div class="repo-row" data-repo="${repo}">
            <span class="repo-name" title="${repo}">${repo}</span>
            <span class="chip">${hasLogs ? `branches ${totalBranches}` : 'no logs yet'}</span>
            <span class="chip">latest ${latest}</span>
          </div>
        `);
      }
      repoListEl.innerHTML = rows.length ? rows.join("") : '<div class="empty-state">표시할 레포가 없습니다.</div>';
    }

    // 브랜치/일자 렌더
    function renderBranchDays(repo, filter="") {
      if (!repo || !GROUPED[repo]) {
        branchAndDaysEl.innerHTML = '<div class="empty-state">레포를 선택하세요.</div>';
        return;
      }
      const f = (filter||"").toLowerCase();
      let html = "";
      const branches = Object.keys(GROUPED[repo]).sort((a,b)=>a.localeCompare(b));
      for (const br of branches) {
        const days = GROUPED[repo][br];
        if (f && !br.toLowerCase().includes(f) && !days.some(d=>d.date.includes(f))) continue;

        html += `<div class="branch-row" data-repo="${repo}" data-branch="${br}">
          <span class="branch-name" title="${br}">${br}</span>
          <span class="chip">latest ${days[0].date}</span>
          <span class="chip">C ${days[0].counts.commits}</span>
          <span class="chip">D ${days[0].counts.dep_changes}</span>
        </div>`;

        for (const d of days) {
          if (f && !d.date.includes(f) && !br.toLowerCase().includes(f)) continue;
          html += `<div class="day-row" data-repo="${repo}" data-branch="${br}" data-day="${d.date}">
            <span class="day-name mono">${d.date}</span>
            <span class="chip">C ${d.counts.commits}</span>
            <span class="chip">D ${d.counts.dep_changes}</span>
          </div>`;
        }
      }
      branchAndDaysEl.innerHTML = html || '<div class="empty-state">해당 필터에 일치하는 항목이 없습니다.</div>';
    }

    // 우측 상세
    function fillDetail(rec) {
      if (!rec) {
        activityDetailsEl.innerHTML = '<div class="empty-state">좌측에서 선택하세요.</div>';
        return;
      }
      const depFiles = (rec.dep_files||[]).map(f=>`<li class="mono">${escapeHtml(f)}</li>`).join("") || "<li>None</li>";
      const samples = (rec.examples||[]).map(s=>{
        const sha7 = (s.sha||"").slice(0,7);
        return `<li><a href="${s.url}" target="_blank">${sha7}</a> – ${escapeHtml(s.message||"")}</li>`;
      }).join("") || "<li>None</li>";

      activityDetailsEl.innerHTML = `
        <div class="detail-content">
          <div class="detail-header">
            <div class="detail-title">${rec.repo_full_name} <span class="mono">@ ${rec.branch}</span></div>
            <div class="detail-meta">Date (UTC): <span class="mono">${rec.date}</span></div>
          </div>
          <div class="detail-section">
            <h4>Counts</h4>
            <ul class="detail-list">
              <li>Commits: <b>${rec.counts?.commits ?? 0}</b></li>
              <li>Dependency Changes: <b>${rec.counts?.dep_changes ?? 0}</b></li>
            </ul>
          </div>
          <div class="detail-section">
            <h4>Dependency Files</h4>
            <ul class="detail-list">${depFiles}</ul>
          </div>
          <div class="detail-section">
            <h4>Samples</h4>
            <ul class="detail-list">${samples}</ul>
          </div>
        </div>
      `;
    }

    // 이벤트 바인딩
    const repoListElClick = (e)=>{
      const row = e.target.closest('.repo-row');
      if (!row) return;
      document.querySelectorAll('.repo-row').forEach(r=>r.classList.remove('active'));
      row.classList.add('active');
      const repo = row.dataset.repo;
      renderBranchDays(repo, branchFilterEl.value);
      activityDetailsEl.innerHTML = '<div class="info-state" style="text-align:left;">브랜치를 선택한 뒤 날짜를 선택하면 상세가 표시됩니다.</div>';
    };
    repoListEl.addEventListener('click', repoListElClick);

    branchAndDaysEl.addEventListener('click', (e)=>{
      const dayRow = e.target.closest('.day-row');
      const branchRow = e.target.closest('.branch-row');

      if (branchRow && !dayRow) {
        const repo = branchRow.dataset.repo;
        const br = branchRow.dataset.branch;
        const latest = GROUPED[repo][br][0];
        document.querySelectorAll('.branch-row, .day-row').forEach(r=>r.classList.remove('active'));
        branchRow.classList.add('active');
        fillDetail(latest);
        return;
      }
      if (dayRow) {
        const repo = dayRow.dataset.repo;
        const br = dayRow.dataset.branch;
        const day = dayRow.dataset.day;
        const rec = GROUPED[repo][br].find(x=>x.date===day);
        document.querySelectorAll('.day-row, .branch-row').forEach(r=>r.classList.remove('active'));
        dayRow.classList.add('active');
        fillDetail(rec);
      }
    });

    repoFilterEl.addEventListener('input', ()=> renderRepos(repoFilterEl.value));
    branchFilterEl.addEventListener('input', ()=>{
      const activeRepo = document.querySelector('.repo-row.active')?.dataset.repo;
      renderBranchDays(activeRepo, branchFilterEl.value);
    });
    document.getElementById('clearBranchFilter').addEventListener('click', ()=>{
      branchFilterEl.value = "";
      const activeRepo = document.querySelector('.repo-row.active')?.dataset.repo;
      renderBranchDays(activeRepo, "");
    });

    // 스플리터
    document.querySelectorAll('.handle').forEach(handle => {
      handle.addEventListener('mousedown', e => {
        const mainGrid = document.getElementById('mainGrid');
        const startX = e.clientX;
        const nums = getComputedStyle(mainGrid).gridTemplateColumns.split(' ');
        const px = nums.map(v=>v.endsWith('px')?parseFloat(v):v);
        const idx = parseInt(handle.dataset.splitterFor)*2 - 1;
        const onMove = ev => {
          const dx = ev.clientX - startX;
          if (typeof px[idx-1]==='number' && typeof px[idx+1]==='number') {
            const left = Math.max(180, px[idx-1] + dx);
            const right = Math.max(180, px[idx+1] - dx);
            const newCols = [...px]; newCols[idx-1]=left; newCols[idx+1]=right;
            mainGrid.style.gridTemplateColumns = newCols.map(v=> typeof v==='number'?`${v}px`:v ).join(' ');
          }
        };
        const onUp = ()=>{ window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); };
        window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp);
      });
    });

    function escapeHtml(s){return (s||"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

    // 초기 렌더
    renderRepos("");
  </script>
</body>
</html>

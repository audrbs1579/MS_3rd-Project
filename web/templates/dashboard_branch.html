<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>Branch Activity – {{ user_id }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root{
      --bg:#f7f7f8; --panel:#ffffff; --text:#222; --muted:#6b7280; --border:#e5e7eb;
      --ring:#3b82f6; --accent:#ff9500; --chip:#f1f5f9; --chip-border:#e2e8f0;
      --shadow-sm:0 1px 8px rgba(0,0,0,.05); --shadow-md:0 6px 24px rgba(0,0,0,.08);
      --soft:#f3f4f6; --link:#2563eb;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0c0d0f; --panel:#121317; --text:#eaeaea; --muted:#a6adbb; --border:#23262d;
        --ring:#60a5fa; --accent:#ffb86b; --chip:#151821; --chip-border:#222630;
        --shadow-sm:0 1px 8px rgba(0,0,0,.6); --shadow-md:0 6px 24px rgba(0,0,0,.55);
        --soft:#181b20; --link:#60a5fa;
      }
    }
    *{box-sizing:border-box}
    html,body{font-family:Tahoma, Arial, sans-serif;margin:0;padding:0;background:var(--bg);color:var(--text)}
    a{color:inherit;text-decoration:none}
    code{font-family:ui-monospace,Consolas,monaco,monospace}

    header,footer{
      padding:10px 14px;border-bottom:1px solid var(--border);display:flex;gap:8px;align-items:center;justify-content:space-between;background:var(--panel)
    }
    footer{border-top:1px solid var(--border);border-bottom:none;color:var(--muted)}
    header strong{font-weight:700}
    .muted{color:var(--muted);font-size:12px}

    main{
      display:grid;grid-template-columns:320px 1fr 1fr;gap:14px;padding:14px;max-width:1400px;margin:0 auto
    }
    @media (max-width:1080px){ main{grid-template-columns:1fr;gap:12px} }
    .col{
      border:1px solid var(--border);border-radius:12px;background:var(--panel);padding:12px;box-shadow:var(--shadow-sm);position:relative
    }
    h2{margin:0 0 10px 0;font-size:15px;letter-spacing:.2px}
    .stamp{position:absolute;right:12px;bottom:8px;font-size:11px;color:var(--muted)}

    /* Inputs & buttons */
    input[type=text]{
      width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:transparent;color:inherit;
      outline:none;transition:border .15s ease, box-shadow .15s ease
    }
    input[type=text]:focus{border-color:var(--ring);box-shadow:0 0 0 3px color-mix(in oklab, var(--ring) 25%, transparent)}
    .btn{
      padding:8px 12px;border:1px solid var(--text);border-radius:10px;background:transparent;cursor:pointer;transition:.15s ease;font-weight:600
    }
    .btn:hover{background:color-mix(in oklab, var(--text) 6%, transparent)}
    .btn:focus{outline:3px solid var(--ring);outline-offset:2px}

    /* Repositories: 고정 높이 + 말줄임 */
    .repo-item{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:0 12px;border:1px solid var(--chip-border);border-radius:12px;background:var(--chip);
      margin:8px 0;cursor:pointer;transition:transform .12s ease, box-shadow .12s ease;
      height:44px;  /* 고정 높이 */
    }
    .repo-item:hover{transform:translateY(-1px);box-shadow:var(--shadow-sm)}
    .repo-item:focus{outline:3px solid var(--ring);outline-offset:2px}
    .repo-name{font-weight:600;flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .repo-meta{font-size:12px;color:var(--muted);flex:0 0 auto}

    /* Branch & commits */
    .date-head{
      margin:12px 0 8px 0;padding:10px 12px;border-radius:10px;background:var(--accent);
      color:#fff;display:flex;align-items:center;justify-content:space-between
    }
    .drag-scroll{
      max-height:460px;overflow:auto;border:1px dashed var(--border);border-radius:10px;background:color-mix(in oklab, var(--panel) 80%, var(--bg));
      cursor:grab; user-select:none; padding:6px;
    }
    .drag-scroll:active{cursor:grabbing}
    .branch-row{padding:8px 4px;border-bottom:1px dashed var(--border)}
    .row-head{display:flex;align-items:center;justify-content:space-between;gap:8px}
    .left-pack{display:flex;align-items:center;gap:8px}
    .tag{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;background:rgba(0,0,0,.03)}
    .commit-panel{border:1px dashed var(--border);border-radius:10px;padding:10px;max-height:420px;overflow:auto;background:color-mix(in oklab, var(--panel) 80%, var(--bg)); margin-top:6px}
    .commit-item{
      display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border);border-radius:10px;
      padding:10px;margin:8px 0;background:var(--panel);box-shadow:var(--shadow-sm);transition:.15s ease
    }
    .commit-item:hover{transform:translateY(-1px);box-shadow:var(--shadow-md)}
    .sha{font-family:ui-monospace,Consolas,monospace;font-size:12px;border:1px solid var(--border);border-radius:999px;padding:2px 8px}
    .green-dot{display:inline-block;width:10px;height:10px;border-radius:50%;background:#28a745;box-shadow:0 0 0 3px rgba(40,167,69,.15)}
    .kicker{font-size:12px;color:var(--muted)}

    /* Commit Detail: 카드형 섹션 구분 */
    .detail-wrap{display:grid;gap:10px}
    .kv{background:var(--soft);border:1px solid var(--border);border-radius:10px;padding:10px}
    .kv dl{margin:0;display:grid;grid-template-columns:120px 1fr;row-gap:8px;column-gap:10px;align-items:start}
    .kv dt{font-weight:700;color:var(--muted)}
    .kv dd{margin:0}
    .files{background:var(--soft);border:1px solid var(--border);border-radius:10px;padding:10px}
    .files ul{margin:0 0 0 18px;padding:0}
    .only-link a{color:var(--link);text-decoration:underline}
  </style>
</head>
<body>
<header>
  <div><strong>Branch Activity – {{ user_id }}</strong> <span class="muted">KST로 표시 / 클릭 시에만 조회</span></div>
  <div>
    <button id="btnSync" class="btn">동기화(로그인 유지)</button>
    <a class="btn" href="{{ url_for('logout') }}">Logout</a>
  </div>
</header>

<main>
  <!-- Repositories -->
  <section class="col">
    <h2>Repositories</h2>
    <input id="repoFilter" type="text" placeholder="owner/repo 필터">
    <div id="repoList" style="margin-top:8px"></div>
    <div id="repoStamp" class="stamp"></div>
  </section>

  <!-- Branches (최신 날짜 그룹) -->
  <section class="col">
    <h2>Branches</h2>
    <div class="kicker">최신 날짜 순으로 묶어 보여줍니다. 그룹은 마우스로 드래그하여 스크롤할 수 있어요.</div>
    <div id="dayBranch" style="margin-top:8px"></div>
    <div id="branchStamp" class="stamp"></div>
  </section>

  <!-- Commit Detail -->
  <section class="col">
    <h2>Commit Detail</h2>
    <div id="detail" class="kicker">왼쪽에서 커밋을 선택하세요.</div>
    <div id="detailStamp" class="stamp"></div>
  </section>
</main>

<footer>
  <span class="muted">© dashboard</span>
</footer>

<script>
  const USER_ID = "{{ user_id }}";

  // -------------- DOM 헬퍼 --------------
  const qs = (s, el=document)=>el.querySelector(s);
  const qsa = (s, el=document)=>Array.from(el.querySelectorAll(s));
  const elRepoList   = qs('#repoList');
  const elDayBranch  = qs('#dayBranch');
  const elDetail     = qs('#detail');
  const elRepoFilter = qs('#repoFilter');
  const elRepoStamp  = qs('#repoStamp');
  const elBranchStamp= qs('#branchStamp');
  const elDetailStamp= qs('#detailStamp');

  // -------------- 상태 --------------
  let allRepos = [];                 // API로 가져온 전체 repo
  let selectedRepo = null;           // "owner/repo"
  let branchesCache = {};            // { repo : [ {name, sha}, ... ] }
  let commitsCache = {};             // { "repo|branch" : [ commits ] }

  // UI 유지용 상태
  const openedBranches = new Set();  // `${repo}|${branch}`
  let selectedCommit = null;         // {repo, sha}
  const groupScrollTops = new Map(); // dayKey -> scrollTop

  // -------------- 초기화 & 주기적 새로고침 --------------
  document.addEventListener('DOMContentLoaded', async () => {
    await loadRepos();
    wireEvents();
    stampAll(); // 최초 스탬프
    // 1분마다 전체 새로고침
    setInterval(periodicRefresh, 60*1000);
  });

  function wireEvents() {
    elRepoFilter.addEventListener('input', renderRepos);
    qs('#btnSync').addEventListener('click', async ()=>{
      await periodicRefresh();
    });
  }

  // -------------- 공통 유틸 --------------
  function stamp(el){
    const now = new Date().toLocaleString('ko-KR', { timeZone:'Asia/Seoul', hour12:false });
    el.textContent = `마지막 새로고침: ${now} (KST)`;
  }
  function stampAll(){
    [elRepoStamp, elBranchStamp, elDetailStamp].forEach(el=>el && stamp(el));
  }

  function enableDragScroll(el){
    let isDown=false, startY=0, startScroll=0;
    el.addEventListener('mousedown',e=>{
      isDown=true; startY=e.pageY - el.offsetTop; startScroll=el.scrollTop; el.classList.add('grabbing');
    });
    el.addEventListener('mouseleave',()=>{isDown=false;});
    el.addEventListener('mouseup',()=>{isDown=false;});
    el.addEventListener('mousemove',e=>{
      if(!isDown) return;
      e.preventDefault();
      const y=e.pageY - el.offsetTop;
      const walk=(y - startY);
      el.scrollTop = startScroll - walk;
    });
    // 터치
    el.addEventListener('touchstart',e=>{
      isDown=true; startY=e.touches[0].pageY - el.offsetTop; startScroll=el.scrollTop;
    },{passive:true});
    el.addEventListener('touchend',()=>{isDown=false;});
    el.addEventListener('touchmove',e=>{
      if(!isDown) return;
      const y=e.touches[0].pageY - el.offsetTop;
      const walk=(y - startY);
      el.scrollTop = startScroll - walk;
    },{passive:false});
  }

  function timeAgo(d){
    const seconds = Math.floor((Date.now() - d.getTime())/1000);
    const units = [['일',86400],['시간',3600],['분',60],['초',1]];
    for (const [name, s] of units){
      const v = Math.floor(seconds / s);
      if (v >= 1) return `${v}${name} 전`;
    }
    return '방금';
  }

  // 한국시간 YYYY-MM-DD 키
  function kstDateKey(iso){
    if(!iso) return null;
    const t = new Date(iso).getTime();
    const kst = new Date(t + 9*60*60*1000); // UTC+9
    return kst.toISOString().slice(0,10);   // YYYY-MM-DD (KST 기준)
  }

  // -------------- API --------------
  async function apiGet(url, params={}) {
    const q = new URLSearchParams(params);
    const res = await fetch(url + (q.toString() ? `?${q}` : ''));
    if (!res.ok) {
      let err = await res.text();
      throw new Error(err || res.statusText);
    }
    return res.json();
  }

  // -------------- Repositories --------------
  async function loadRepos() {
    const data = await apiGet('/api/my_repos');
    allRepos = data.repos || [];
    renderRepos();
    stamp(elRepoStamp);
  }

  function renderRepos() {
    const f = (elRepoFilter.value || '').toLowerCase();
    elRepoList.innerHTML = '';
    allRepos
      .filter(r => (r.full_name||'').toLowerCase().includes(f))
      .forEach(r => {
        const item = document.createElement('button');
        item.className = 'repo-item';
        item.title = r.full_name;
        item.onclick = ()=>selectRepo(r.full_name);

        const left = document.createElement('div');
        left.className = 'repo-name';
        left.textContent = r.name || r.full_name;

        const right = document.createElement('div');
        right.className = 'repo-meta';
        right.textContent = r.pushed_at ? ('pushed ' + timeAgo(new Date(r.pushed_at))) : '';

        item.appendChild(left);
        item.appendChild(right);
        elRepoList.appendChild(item);
      });
  }

  // -------------- Branches (KST 날짜 그룹) --------------
  async function selectRepo(full_name) {
    // 현재 그룹 스크롤 기억
    saveGroupScrolls();

    selectedRepo = full_name;
    elDayBranch.innerHTML = '브랜치 불러오는 중...';

    if (!branchesCache[full_name]) {
      const data = await apiGet('/api/branches', {repo: full_name});
      branchesCache[full_name] = data.branches || [];
    }
    const branches = branchesCache[full_name].slice(); // 복사본

    // 각 브랜치의 최신 커밋 확보
    await Promise.all(branches.map(async (b) => {
      const key = `${full_name}|${b.name}`;
      if (!commitsCache[key]) {
        const data = await apiGet('/api/commits', {repo: full_name, branch: b.name});
        commitsCache[key] = data.commits || [];
      }
      const list = commitsCache[key];
      b._latestISO = list.length ? list[0].date : null;
      b._latestKDay = b._latestISO ? kstDateKey(b._latestISO) : null;
      b._latestDate = b._latestISO ? new Date(b._latestISO).getTime() : 0;
      b._commitCount = list.length;
      b._isFresh = list.length ? (Date.now() - (new Date(list[0].date).getTime())) <= 3*60*1000 : false;
    }));

    // 날짜별 그룹핑(KST 키 사용) — 날짜 없는 브랜치는 제외
    const groups = {};
    for (const b of branches){
      if (!b._latestKDay) continue;
      (groups[b._latestKDay] ||= []).push(b);
    }
    const days = Object.keys(groups).sort((a,b)=> b.localeCompare(a)); // desc

    // 렌더
    const out = document.createDocumentFragment();
    for (const day of days){
      const head = document.createElement('div');
      head.className = 'date-head';
      head.innerHTML = `<div>${day}</div><div class="muted">브랜치 ${groups[day].length}개</div>`;
      out.appendChild(head);

      const box = document.createElement('div');
      box.className = 'drag-scroll';
      box.dataset.day = day; // 스크롤 복구용
      enableDragScroll(box);

      // 해당 날짜의 브랜치만(이미 필터됨), 최신순
      groups[day].sort((a,b)=> (b._latestDate||0) - (a._latestDate||0));
      groups[day].forEach(b=>{
        const row = document.createElement('div');
        row.className = 'branch-row';

        const head = document.createElement('div');
        head.className = 'row-head';

        const left = document.createElement('div');
        left.className = 'left-pack';
        left.innerHTML = `
          ${b._isFresh ? '<span class="green-dot" title="3분 이내"></span>' : '<span style="width:10px;height:10px;display:inline-block"></span>'}
          <strong>${b.name}</strong>
          <span class="tag">C ${b._commitCount ?? '?'}</span>
          <span class="muted" style="font-size:12px">${new Date(b._latestISO).toLocaleString('ko-KR',{ timeZone:'Asia/Seoul'})}</span>
        `;

        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.alignItems = 'center';
        right.style.gap = '8px';
        right.innerHTML = `
          ${b._isFresh ? '<span class="green-dot" title="3분 이내"></span>' : ''}
          <button class="btn">열기</button>
        `;

        const panel = document.createElement('div');
        panel.className = 'commit-panel';
        panel.style.display = 'none';
        panel.textContent = '커밋을 불러오려면 "열기"를 누르세요.';

        const k = `${full_name}|${b.name}`;
        right.querySelector('.btn').onclick = async () => {
          const opened = panel.style.display !== 'none';
          if (opened) {
            panel.style.display = 'none';
            right.querySelector('.btn').textContent = '열기';
            openedBranches.delete(k);
            return;
          }
          right.querySelector('.btn').textContent = '닫기';
          panel.style.display = 'block';
          openedBranches.add(k);
          await loadCommitsForBranch(full_name, b.name, panel, head);
        };

        // 이미 열려 있던 패널은 복구
        if (openedBranches.has(k)) {
          panel.style.display = 'block';
          right.querySelector('.btn').textContent = '닫기';
          loadCommitsForBranch(full_name, b.name, panel, head);
        }

        head.appendChild(left);
        head.appendChild(right);
        row.appendChild(head);
        row.appendChild(panel);
        box.appendChild(row);
      });

      out.appendChild(box);
    }

    elDayBranch.replaceChildren(out);
    restoreGroupScrolls();
    stamp(elBranchStamp);
  }

  async function loadCommitsForBranch(repo, branch, panel, headEl) {
    panel.innerHTML = '조회 중...';

    const key = `${repo}|${branch}`;
    if (!commitsCache[key]) {
      const data = await apiGet('/api/commits', {repo, branch});
      commitsCache[key] = data.commits || [];
    }
    const commits = commitsCache[key];

    // 헤더 C 배지 갱신 및 fresh dot 갱신
    const tag = headEl.querySelector('.tag');
    if (tag) tag.textContent = `C ${commits.length}`;
    const isFresh = commits.length ? (Date.now() - (new Date(commits[0].date).getTime())) <= 3*60*1000 : false;
    const rightPack = headEl.parentElement.querySelector('.row-head > div:last-child');
    if (rightPack){
      const firstChild = rightPack.firstElementChild;
      if (firstChild && (firstChild.classList && firstChild.classList.contains('green-dot'))) {
        // 기존 점 삭제
        rightPack.removeChild(firstChild);
      }
      if (isFresh) rightPack.insertAdjacentHTML('afterbegin', '<span class="green-dot" title="3분 이내"></span>');
    }

    if (!commits.length) {
      panel.textContent = '커밋 없음';
      return;
    }

    panel.innerHTML = '';
    const now = Date.now();
    commits.forEach(c => {
      const item = document.createElement('div');
      item.className = 'commit-item';

      const fresh = (() => {
        if (!c.date) return false;
        const d = new Date(c.date).getTime();
        return (now - d) <= 3 * 60 * 1000; // 3분
      })();

      const left = document.createElement('div');
      left.style.display = 'flex';
      left.style.alignItems = 'center';
      left.style.gap = '6px';
      left.innerHTML = `<span>${escapeHtml(c.message || '(no message)')}</span>`;

      const right = document.createElement('div');
      right.style.display = 'flex';
      right.style.alignItems = 'center';
      right.style.gap = '6px';
      right.innerHTML = `
        ${fresh ? '<span class="green-dot" title="3분 이내"></span>' : ''}
        <span class="sha">${(c.sha || '').slice(0,7)}</span>
      `;

      item.appendChild(left);
      item.appendChild(right);
      item.onclick = ()=>{ selectedCommit = {repo, sha:c.sha}; showCommitDetail(repo, c.sha); };
      panel.appendChild(item);
    });
  }

  // -------------- Commit Detail --------------
  async function showCommitDetail(repo, sha) {
    elDetail.textContent = '상세 조회 중...';
    const d = await apiGet('/api/commit_detail', {repo, sha});

    let kst = '';
    if (d.date) {
      kst = new Date(d.date).toLocaleString("ko-KR", {
        timeZone: "Asia/Seoul",
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit"
      });
    }

    const files = d.files || [];
    const stats = d.stats || {};

    elDetail.innerHTML = `
      <div class="detail-wrap">
        <div class="kv">
          <dl>
            <dt>제목</dt>
            <dd><strong>${escapeHtml(d.message || '')}</strong></dd>
            <dt>작성자</dt>
            <dd>${escapeHtml(d.author||'')}</dd>
            <dt>날짜(KST)</dt>
            <dd>${kst || '—'}</dd>
            <dt>SHA</dt>
            <dd><code>${d.sha}</code></dd>
          </dl>
          <div class="only-link" style="margin-top:6px"><a href="${d.html_url}" target="_blank" rel="noopener">GitHub에서 보기</a></div>
          <dl style="margin-top:10px">
            <dt>변경</dt>
            <dd>총 ${stats.total ?? 0} (+${stats.additions ?? 0} / -${stats.deletions ?? 0})</dd>
          </dl>
        </div>
        <div class="files">
          <div style="font-weight:700;margin-bottom:6px">Files</div>
          <ul>
            ${files.map(f => `
              <li>${escapeHtml(f.filename)} — ${f.status} (+${f.additions} / -${f.deletions})</li>
            `).join("")}
          </ul>
        </div>
      </div>
    `;
    stamp(elDetailStamp);
  }

  // -------------- 주기적 새로고침 --------------
  async function periodicRefresh(){
    try{
      // 전체 레포 리프레시
      await loadRepos();

      // 모든 레포의 브랜치/커밋 갱신 (캐시 갱신)
      for (const r of allRepos){
        // 브랜치
        const bData = await apiGet('/api/branches', {repo: r.full_name});
        branchesCache[r.full_name] = bData.branches || [];

        // 커밋(각 브랜치)
        for (const b of branchesCache[r.full_name]){
          const key = `${r.full_name}|${b.name}`;
          const cData = await apiGet('/api/commits', {repo: r.full_name, branch: b.name});
          commitsCache[key] = cData.commits || [];
        }
      }

      // 현재 선택된 레포/오픈된 브랜치/선택 커밋 복구
      if (selectedRepo) {
        await selectRepo(selectedRepo);
      }
      if (selectedCommit) {
        await showCommitDetail(selectedCommit.repo, selectedCommit.sha);
      }

      stampAll();
    }catch(e){
      console.error(e);
    }
  }

  // 스크롤 상태 저장/복구
  function saveGroupScrolls(){
    groupScrollTops.clear();
    qsa('.drag-scroll', elDayBranch).forEach(box=>{
      groupScrollTops.set(box.dataset.day, box.scrollTop);
    });
  }
  function restoreGroupScrolls(){
    qsa('.drag-scroll', elDayBranch).forEach(box=>{
      const v = groupScrollTops.get(box.dataset.day);
      if (typeof v === 'number') box.scrollTop = v;
    });
  }

  // -------------- misc --------------
  function escapeHtml(s){
    return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }
</script>
</body>
</html>
